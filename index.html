<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AP Speedo Rider</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #D32F2F; --white: #FFFFFF; }
        body {
            font-family: 'Poppins', sans-serif; margin: 0; padding: 0;
            background-color: var(--white); height: 100vh; width: 100vw;
            overflow: hidden; display: flex; justify-content: center; align-items: center;
        }
        /* TOAST */
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 10000; width: 90%; pointer-events: none; }
        .toast { background: rgba(0,0,0,0.8); color: white; padding: 12px; border-radius: 8px; text-align: center; margin-top:5px; opacity: 0; transition: opacity 0.3s; }
        .toast.error { border-left: 5px solid red; }
        /* SPLASH */
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--white); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        #splash-screen img { width: 250px; }
        /* UI */
        .container { width: 100%; max-width: 400px; height: 100%; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        input, select { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        button { background-color: var(--primary); color: var(--white); border: none; padding: 12px; border-radius: 5px; width: 100%; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .carousel-container { width: 100%; flex: 1; position: relative; overflow: hidden; }
        .step { position: absolute; top: 0; left: 100%; width: 100%; height: 100%; transition: left 0.3s ease-in-out; display: flex; flex-direction: column; justify-content: center; align-items: center; background: var(--white); padding: 5px; box-sizing: border-box; }
        .step.active { left: 0; } .step.prev { left: -100%; }
        /* CAM & IMAGES */
        .camera-circle { width: 180px; height: 180px; border-radius: 50%; background: #ddd; overflow: hidden; border: 3px solid var(--primary); margin-bottom: 10px; position:relative;}
        video, canvas, #selfie-result { width: 100%; height: 100%; object-fit: cover; }
        .nic-row { display: flex; gap: 10px; width: 100%; }
        .nic-btn { flex: 1; background: #eee; padding: 10px; text-align: center; border: 1px solid #999; cursor:pointer;}
        .preview-container { display: flex; gap: 10px; width: 100%; height: 120px; margin-top:5px;}
        .preview-box { flex: 1; background: #f0f0f0; border: 1px dashed #ccc; display: flex; align-items: center; justify-content: center; overflow:hidden;}
        .nic-img { width: 100%; height: 100%; object-fit: cover; display: none; }
        /* STATES */
        .declined-box { border: 2px solid var(--primary); padding: 20px; width: 100%; background: #fff; margin-bottom: 20px; max-height: 60vh; overflow-y: auto; text-align: left;}
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; width: 100%; margin-top: 10px; }
        .keypad div { background: #eee; padding: 15px; text-align: center; font-weight: bold; border-radius: 5px; }
        .link { color: var(--primary); margin-top: 15px; font-size: 12px; text-decoration: none; }
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 10001; display: none; justify-content: center; align-items: center; color: var(--primary); font-weight: bold; }
    </style>
</head>
<body>

<div id="toast-container"></div>
<div id="loading-overlay">Processing...</div>
<div id="splash-screen"><img src="https://i.ibb.co/0y4f8HBn/56bfb5ea-125e-4071-a5dc-63762dbddc05.jpg"></div>

<!-- Login -->
<div id="login-view" class="container">
    <img src="https://i.ibb.co/0y4f8HBn/56bfb5ea-125e-4071-a5dc-63762dbddc05.jpg" width="100" style="margin-bottom:20px;">
    <h2 style="text-align:center; color:var(--primary); margin:0 0 20px 0;">Rider Login</h2>
    <input type="tel" id="login-phone" placeholder="Mobile Number">
    <input type="password" id="login-pass" placeholder="Password">
    <button onclick="handleLogin()">LOGIN</button>
    <a href="#" class="link" onclick="switchView('register-view')">Create Account</a>
</div>

<!-- Register -->
<div id="register-view" class="container">
    <h3 style="text-align:center;">Sign Up</h3>
    <div class="carousel-container">
        <!-- Steps 1-7 same as before, abbreviated for length but logic retained -->
        <div class="step active" id="step1">
            <h4>1. Full Name</h4>
            <input type="text" id="reg-name" placeholder="CAPITAL LETTERS ONLY" oninput="this.value=this.value.toUpperCase()">
            <button onclick="nextStep(1)">Next</button><a href="#" class="link" onclick="switchView('login-view')">Back</a>
        </div>
        <div class="step" id="step2">
            <h4>2. Mobile Number</h4>
            <input type="text" id="reg-phone" readonly placeholder="07XXXXXXXX">
            <div class="keypad">
                <div onclick="kp('1')">1</div><div onclick="kp('2')">2</div><div onclick="kp('3')">3</div>
                <div onclick="kp('4')">4</div><div onclick="kp('5')">5</div><div onclick="kp('6')">6</div>
                <div onclick="kp('7')">7</div><div onclick="kp('8')">8</div><div onclick="kp('9')">9</div>
                <div onclick="kp('back')">DEL</div><div onclick="kp('0')">0</div><div onclick="nextStep(2)" style="background:var(--primary); color:white;">OK</div>
            </div>
            <button onclick="prevStep(2)" style="background:#555">Back</button>
        </div>
        <div class="step" id="step3">
            <h4>3. NIC Number</h4>
            <input type="text" id="reg-nic" placeholder="NIC">
            <button onclick="nextStep(3)">Next</button><button onclick="prevStep(3)" style="background:#555">Back</button>
        </div>
        <div class="step" id="step4">
            <h4>4. Upload NIC</h4>
            <div class="nic-row">
                <div class="nic-btn" onclick="document.getElementById('nic-front-file').click()">Select Front</div>
                <div class="nic-btn" onclick="document.getElementById('nic-back-file').click()">Select Back</div>
            </div>
            <input type="file" id="nic-front-file" hidden accept="image/*" onchange="procImg(this, 'front-prev')">
            <input type="file" id="nic-back-file" hidden accept="image/*" onchange="procImg(this, 'back-prev')">
            <div class="preview-container">
                <div class="preview-box"><img id="front-prev" class="nic-img"></div>
                <div class="preview-box"><img id="back-prev" class="nic-img"></div>
            </div>
            <button onclick="nextStep(4)">Next</button><button onclick="prevStep(4)" style="background:#555">Back</button>
        </div>
        <div class="step" id="step5">
            <h4>5. Selfie</h4>
            <div class="camera-circle"><video id="webcam" autoplay playsinline></video><img id="selfie-result" style="display:none;"></div>
            <button id="cap-btn" onclick="capture()">Capture</button>
            <button id="retake-btn" onclick="retake()" style="display:none; background:#333">Retake</button>
            <button id="next-5" onclick="nextStep(5)" style="display:none;">Next</button>
            <button onclick="prevStep(5)" style="background:#555">Back</button>
        </div>
        <div class="step" id="step6">
            <h4>6. Contact & Location</h4>
            <input type="email" id="reg-email" placeholder="Email">
            <select id="reg-province" onchange="fillDistricts()"><option value="">Province</option></select>
            <select id="reg-district"><option value="">District</option></select>
            <button onclick="nextStep(6)">Next</button><button onclick="prevStep(6)" style="background:#555">Back</button>
        </div>
        <div class="step" id="step7">
            <h4>7. Security</h4>
            <input type="password" id="reg-pass" placeholder="Password">
            <button onclick="submitReg()">SUBMIT</button><button onclick="prevStep(7)" style="background:#555">Back</button>
        </div>
    </div>
</div>

<div id="pending-view" class="container">
    <div style="text-align:center">
        <h2 style="color:orange;">PENDING APPROVAL</h2>
        <p>Your request is under review.</p>
        <button onclick="location.reload()">Check Status</button>
        <button onclick="logout()" style="background:#555">Logout</button>
    </div>
</div>

<div id="declined-view" class="container">
    <div class="declined-box">
        <div style="color:var(--primary); font-weight:bold; font-size:20px;">APPLICATION DECLINED</div>
        <p style="font-size:12px;">Issues found:</p>
        <div id="dec-reasons"></div>
    </div>
    <button onclick="resetApp()">TRY AGAIN</button>
    <button onclick="logout()" style="background:#555">Logout</button>
</div>

<!-- Firebase -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, set, get, child, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    window.db = getDatabase(initializeApp({
        apiKey: "AIzaSyC3Rf4x5a_L1cYVa6soADfYktQK5WyMN-4",
        authDomain: "speedo-acb7c.firebaseapp.com",
        databaseURL: "https://speedo-acb7c-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "speedo-acb7c"
    }));
    window.ref = ref; window.set = set; window.get = get; window.child = child; window.remove = remove;
</script>

<script>
    // Utils
    const toast = (m,e) => {
        let t = document.createElement('div'); t.className = 'toast '+(e?'error':''); t.innerText=m;
        document.getElementById('toast-container').appendChild(t);
        setTimeout(()=>t.style.opacity=1,10); setTimeout(()=>{t.style.opacity=0;setTimeout(()=>t.remove(),300)},3000);
    }
    const loading = (s) => document.getElementById('loading-overlay').style.display = s?'flex':'none';
    const slData = { "Western": ["Colombo", "Gampaha", "Kalutara"], "Central": ["Kandy", "Matale", "Nuwara Eliya"], "Southern": ["Galle", "Matara", "Hambantota"], "Northern": ["Jaffna", "Kilinochchi", "Mannar"], "Eastern": ["Ampara", "Trincomalee"], "North Western": ["Kurunegala", "Puttalam"], "Uva": ["Badulla"], "Sabaragamuwa": ["Ratnapura", "Kegalle"] };
    let imgData = {front:"",back:"",selfie:""};

    window.onload = function() {
        const ps = document.getElementById('reg-province');
        for(let p in slData){ let o=document.createElement('option'); o.value=p; o.text=p; ps.add(o); }
        setTimeout(()=>{ document.getElementById('splash-screen').style.display='none'; checkLogin(); },1500);
        startCam();
    }

    function checkLogin() {
        const uid = localStorage.getItem('uid');
        const dist = localStorage.getItem('dist');
        if(uid && dist) {
            window.get(window.child(window.ref(window.db), `riders/${dist}/${uid}`)).then(s => {
                if(s.exists()) {
                    let st = s.val().approved_status;
                    if(st === true) window.location.href = "main.html"; // REDIRECT
                    else if(st === "declined") showDeclined(s.val().rejection_reasons);
                    else switchView('pending-view');
                } else { localStorage.clear(); switchView('login-view'); }
            });
        } else { switchView('login-view'); }
    }

    window.switchView = (id) => { document.querySelectorAll('.container').forEach(d=>d.style.display='none'); document.getElementById(id).style.display='flex'; }

    // Duplicate Check
    async function checkExists(f,v) {
        loading(true);
        let found = false;
        try {
            const s = await window.get(window.ref(window.db, 'riders'));
            if(s.exists()) s.forEach(ds => ds.forEach(rs => { if(rs.val().riderdata && rs.val().riderdata[f]===v) found=true; }));
        } catch(e){}
        loading(false); return found;
    }

    window.nextStep = async (n) => {
        if(n===1) { let nm=document.getElementById('reg-name').value; if(nm.length<5) return toast("Name too short",1); if(await checkExists('fullName',nm)) return toast("Name exists",1); }
        if(n===2) { let ph=document.getElementById('reg-phone').value; if(ph.length<10) return toast("Invalid Phone",1); if(await checkExists('phone',ph)) return toast("Phone exists",1); }
        if(n===3) { let nic=document.getElementById('reg-nic').value; if(nic.length<10) return toast("Invalid NIC",1); if(await checkExists('nic',nic)) return toast("NIC exists",1); }
        if(n===4 && (!imgData.front||!imgData.back)) return toast("Upload images",1);
        if(n===5 && !imgData.selfie) return toast("Take selfie",1);
        if(n===6) { let em=document.getElementById('reg-email').value; if(!em.includes('@')) return toast("Invalid Email",1); if(await checkExists('email',em)) return toast("Email exists",1); if(!document.getElementById('reg-district').value) return toast("Select District",1); }
        
        document.getElementById(`step${n}`).className='step prev'; document.getElementById(`step${n+1}`).className='step active';
    }
    window.prevStep = (n) => { document.getElementById(`step${n}`).className='step'; document.getElementById(`step${n-1}`).className='step active'; }
    window.kp = (k) => { let e=document.getElementById('reg-phone'); if(k==='back')e.value=e.value.slice(0,-1); else if(e.value.length<10)e.value+=k; }

    // Images
    window.procImg = (i,id) => {
        if(i.files[0]){
            let r=new FileReader();
            r.onload=(e)=>{
                let im=new Image(); im.src=e.target.result;
                im.onload=()=>{
                    let c=document.createElement('canvas'), x=c.getContext('2d'), sc=800/im.width;
                    c.width=800; c.height=im.height*sc; x.drawImage(im,0,0,c.width,c.height);
                    let b64=c.toDataURL('image/jpeg',0.5);
                    document.getElementById(id).src=b64; document.getElementById(id).style.display='block';
                    if(id.includes('front'))imgData.front=b64; else imgData.back=b64;
                }
            }; r.readAsDataURL(i.files[0]);
        }
    }
    // Camera
    function startCam(){ navigator.mediaDevices.getUserMedia({video:true}).then(s=>document.getElementById('webcam').srcObject=s).catch(e=>{}); }
    window.capture=()=>{
        let v=document.getElementById('webcam'), c=document.createElement('canvas'), x=c.getContext('2d');
        let s=400; c.width=s; c.height=s;
        let vr=v.videoWidth/v.videoHeight, sx, sy, sw, sh;
        if(vr>1){ sh=v.videoHeight; sw=sh; sx=(v.videoWidth-sw)/2; sy=0; } else { sw=v.videoWidth; sh=sw; sx=0; sy=(v.videoHeight-sh)/2; }
        x.drawImage(v,sx,sy,sw,sh,0,0,s,s);
        imgData.selfie=c.toDataURL('image/jpeg',0.6);
        document.getElementById('selfie-result').src=imgData.selfie; document.getElementById('selfie-result').style.display='block'; v.style.display='none';
        document.getElementById('cap-btn').style.display='none'; document.getElementById('retake-btn').style.display='inline-block'; document.getElementById('next-5').style.display='inline-block';
    }
    window.retake=()=>{ 
        document.getElementById('webcam').style.display='block'; document.getElementById('selfie-result').style.display='none';
        document.getElementById('cap-btn').style.display='inline-block'; document.getElementById('retake-btn').style.display='none'; document.getElementById('next-5').style.display='none';
        imgData.selfie=""; 
    }

    // Submit
    window.fillDistricts=()=>{
        let p=document.getElementById('reg-province').value, d=document.getElementById('reg-district'); d.innerHTML='<option value="">District</option>';
        if(slData[p]) slData[p].forEach(x=>{ let o=document.createElement('option'); o.value=x; o.text=x; d.add(o); });
    }
    window.submitReg=()=>{
        let d=document.getElementById('reg-district').value, uid="RID_"+Date.now();
        let dt={ riderdata:{ fullName:document.getElementById('reg-name').value, phone:document.getElementById('reg-phone').value, nic:document.getElementById('reg-nic').value, email:document.getElementById('reg-email').value, password:document.getElementById('reg-pass').value, nicFront:imgData.front, nicBack:imgData.back, selfie:imgData.selfie }, approved_status:false };
        loading(true);
        window.set(window.ref(window.db, `riders/${d}/${uid}`), dt).then(()=>{
            localStorage.setItem('uid',uid); localStorage.setItem('dist',d);
            loading(false); switchView('pending-view');
        });
    }

    // Reset
    window.resetApp=async()=>{
        let u=localStorage.getItem('uid'), d=localStorage.getItem('dist');
        if(u&&d){ loading(true); try{ await window.remove(window.ref(window.db, `riders/${d}/${u}`)); }catch(e){} }
        localStorage.clear(); location.reload();
    }
    function showDeclined(r){
        let d=document.getElementById('dec-reasons'); d.innerHTML="";
        if(Array.isArray(r))r.forEach(x=>d.innerHTML+=`<div>- ${x}</div>`); else d.innerHTML=`<div>- ${r}</div>`;
        switchView('declined-view');
    }
    window.logout=()=>{ localStorage.clear(); location.reload(); }

    window.handleLogin = async function() {
        const ph = document.getElementById('login-phone').value;
        const pa = document.getElementById('login-pass').value;
        if(!ph||!pa) return toast("Fill all fields",1);
        loading(true);
        try {
            const s = await window.get(window.ref(window.db, 'riders'));
            let f = false;
            if(s.exists()) {
                s.forEach(ds => {
                    ds.forEach(rs => {
                        let d = rs.val().riderdata;
                        if(d && d.phone === ph && d.password === pa) {
                            f = true;
                            // Check approval directly here
                            if(rs.val().approved_status === true) {
                                localStorage.setItem('uid', rs.key);
                                localStorage.setItem('dist', ds.key);
                                window.location.href = "main.html"; // REDIRECT
                            } else if (rs.val().approved_status === "declined") {
                                localStorage.setItem('uid', rs.key);
                                localStorage.setItem('dist', ds.key);
                                showDeclined(rs.val().rejection_reasons);
                            } else {
                                localStorage.setItem('uid', rs.key);
                                localStorage.setItem('dist', ds.key);
                                switchView('pending-view');
                            }
                        }
                    });
                });
            }
            if(!f) toast("Invalid Login",1);
        } catch(e){ toast("Error",1); }
        loading(false);
    }
</script>
</body>
</html>
