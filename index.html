<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AP Speedo - Rider App</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #FFD700;
            --dark: #1a1a1a;
            --light: #ffffff;
            --gray: #f8f9fa;
            --error: #dc3545;
            --success: #28a745;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; font-family: 'Poppins', sans-serif; }
        
        body { background-color: var(--light); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- Screens --- */
        .screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #fff;
            display: none; /* Hidden by default */
            flex-direction: column;
            overflow-y: auto;
            z-index: 10;
        }
        
        .screen.active { display: flex; }

        /* --- Splash --- */
        #splash-screen {
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        #splash-screen img { width: 150px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* --- Auth/Forms --- */
        .auth-container { padding: 24px; max-width: 480px; margin: 0 auto; width: 100%; }
        .header { text-align: center; margin-bottom: 20px; }
        .header img { width: 70px; border-radius: 10px; margin-bottom: 10px; }
        
        input {
            width: 100%; padding: 14px; margin-bottom: 15px;
            border: 2px solid #eee; border-radius: 12px;
            font-size: 1rem; background: var(--gray); outline: none;
        }
        input:focus { border-color: var(--primary); background: #fff; }

        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 12px;
            background: var(--dark); color: #fff; font-weight: 600; font-size: 1rem;
            cursor: pointer; margin-top: 10px;
        }
        .btn-link { background: none; color: #666; margin-top: 15px; font-size: 0.9rem; }

        /* --- Carousel Steps --- */
        .step { display: none; animation: fadeIn 0.4s; }
        .step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Upload Boxes --- */
        .upload-box {
            border: 2px dashed #ccc; border-radius: 12px; height: 140px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            margin-bottom: 10px; background: var(--gray); position: relative; overflow: hidden;
        }
        .upload-box img { position: absolute; width: 100%; height: 100%; object-fit: cover; opacity: 0.6; }
        .upload-box.done { border-color: var(--success); }

        /* --- Status Screens (Pending/Declined) --- */
        .status-content {
            flex: 1; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; 
            padding: 30px; text-align: center;
        }
        .status-icon { font-size: 4rem; margin-bottom: 20px; color: var(--primary); }
        .status-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 10px; color: var(--dark); }
        .status-desc { color: #666; margin-bottom: 30px; line-height: 1.6; }
        
        .decline-list {
            text-align: left; background: #fff5f5; padding: 15px; 
            border-radius: 10px; border-left: 4px solid var(--error);
            width: 100%; margin-bottom: 20px;
        }
        .decline-list li { list-style: none; margin-bottom: 5px; color: var(--error); font-weight: 500; }

        /* --- Loader --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 10000;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #eee; 
            border-top: 4px solid var(--dark); border-radius: 50%; 
            animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- Global Loader -->
    <div id="loader">
        <div class="spinner"></div>
        <p id="loader-text">Loading...</p>
    </div>

    <!-- 1. Splash Screen -->
    <div id="splash-screen" class="screen active">
        <img src="https://i.ibb.co/0y4f8HBn/56bfb5ea-125e-4071-a5dc-63762dbddc05.jpg" alt="Logo">
    </div>

    <!-- 2. Auth Screen (Login) -->
    <div id="login-screen" class="screen">
        <div class="auth-container">
            <div class="header">
                <img src="https://i.ibb.co/0y4f8HBn/56bfb5ea-125e-4071-a5dc-63762dbddc05.jpg">
                <h2>Rider Login</h2>
            </div>
            <input type="tel" id="login-phone" placeholder="Mobile Number">
            <input type="password" id="login-pass" placeholder="Password">
            <button class="btn" onclick="handleLogin()">Login</button>
            <button class="btn btn-link" onclick="showRegister()">Create Account</button>
        </div>
    </div>

    <!-- 3. Register Screen (Carousel) -->
    <div id="register-screen" class="screen">
        <div class="auth-container">
            <div class="header">
                <h2>Rider Registration</h2>
            </div>

            <!-- Step 1 -->
            <div class="step active" id="step-1">
                <h3>Personal Info</h3>
                <input type="text" id="reg-name" placeholder="Full Name (Capitalized)" style="text-transform: uppercase;">
                <input type="tel" id="reg-phone" placeholder="Mobile (07XXXXXXXX)" maxlength="10">
                <button class="btn" onclick="nextStep(1)">Next</button>
            </div>

            <!-- Step 2 -->
            <div class="step" id="step-2">
                <h3>NIC Details</h3>
                <input type="text" id="reg-nic" placeholder="NIC Number">
                <button class="btn" onclick="nextStep(2)">Next</button>
                <button class="btn btn-link" onclick="prevStep(2)">Back</button>
            </div>

            <!-- Step 3 (Images) -->
            <div class="step" id="step-3">
                <h3>Documents & Face</h3>
                
                <div class="upload-box" onclick="document.getElementById('img-front').click()">
                    <p>NIC Front</p>
                    <img id="prev-front">
                </div>
                <input type="file" id="img-front" hidden accept="image/*" onchange="processImage(this, 'prev-front')">

                <div class="upload-box" onclick="document.getElementById('img-back').click()">
                    <p>NIC Back</p>
                    <img id="prev-back">
                </div>
                <input type="file" id="img-back" hidden accept="image/*" onchange="processImage(this, 'prev-back')">

                <div class="upload-box" onclick="document.getElementById('img-face').click()" style="border-radius:50%; width:120px; height:120px; margin:10px auto;">
                    <p>Selfie</p>
                    <img id="prev-face" style="border-radius:50%;">
                </div>
                <input type="file" id="img-face" hidden accept="image/*" capture="user" onchange="processImage(this, 'prev-face')">

                <button class="btn" onclick="nextStep(3)">Next</button>
                <button class="btn btn-link" onclick="prevStep(3)">Back</button>
            </div>

            <!-- Step 4 (Password) -->
            <div class="step" id="step-4">
                <h3>Security</h3>
                <input type="password" id="reg-pass" placeholder="Create Password">
                <input type="password" id="reg-pass-confirm" placeholder="Confirm Password">
                <button class="btn" onclick="submitRegistration()">Submit Application</button>
                <button class="btn btn-link" onclick="prevStep(4)">Back</button>
            </div>
            
            <button class="btn btn-link" onclick="showLogin()" style="margin-top:20px;">Back to Login</button>
        </div>
    </div>

    <!-- 4. Review Pending Screen -->
    <div id="pending-screen" class="screen">
        <div class="status-content">
            <i class="fas fa-file-contract status-icon"></i>
            <div class="status-title">Application Under Review</div>
            <div class="status-desc">
                Your application is currently being reviewed by our team. We will notify you once the verification process is complete.
            </div>
            <button class="btn" onclick="logout()">Check Later (Logout)</button>
        </div>
    </div>

    <!-- 5. Declined Screen -->
    <div id="declined-screen" class="screen">
        <div class="status-content">
            <i class="fas fa-exclamation-circle status-icon" style="color: var(--error);"></i>
            <div class="status-title" style="color: var(--error);">Application Declined</div>
            <div class="status-desc">
                Unfortunately, your application was not approved due to the following reasons:
            </div>
            
            <ul class="decline-list" id="decline-reasons-list">
                <!-- Reasons injected here -->
            </ul>

            <button class="btn" onclick="reUpload()">Re-Upload Documents</button>
            <button class="btn btn-link" onclick="logout()">Logout</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getDatabase, ref, set, get, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC3Rf4x5a_L1cYVa6soADfYktQK5WyMN-4",
            authDomain: "speedo-acb7c.firebaseapp.com",
            databaseURL: "https://speedo-acb7c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "speedo-acb7c",
            storageBucket: "speedo-acb7c.firebasestorage.app",
            messagingSenderId: "31066493782",
            appId: "1:31066493782:web:e3e9dfa209fa855bc17cf7",
            measurementId: "G-ND3GRGL0WQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        let formData = {
            name: '', phone: '', nic: '', 
            imgFront: '', imgBack: '', imgFace: ''
        };

        // --- Splash & Auth State Check ---
        window.addEventListener('load', () => {
            setTimeout(() => {
                const splash = document.getElementById('splash-screen');
                splash.style.opacity = '0';
                setTimeout(() => splash.style.display = 'none', 500);
            }, 2500);
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                checkStatus(user.uid);
            } else {
                showScreen('login-screen');
            }
        });

        // --- Status Logic ---
        async function checkStatus(uid) {
            toggleLoader(true);
            try {
                const snapshot = await get(ref(db, 'riders/' + uid));
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    
                    if (data.approved_status === true) {
                        window.location.href = "main.html"; // Redirect Approved
                    } else if (data.approved_status === "declined") {
                        showDeclined(data.declinereasons);
                    } else {
                        // approved_status is false or undefined
                        showScreen('pending-screen');
                    }
                } else {
                    // Auth exists but DB node missing? Show Register.
                    showScreen('register-screen');
                }
            } catch (error) {
                console.error(error);
                alert("Connection Error");
            } finally {
                toggleLoader(false);
            }
        }

        // --- Helper: Image Compression (~50KB) ---
        window.processImage = function(input, previewId) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 500; // Small width for low size
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    // High compression (0.5 quality)
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.5); 
                    
                    // Display preview
                    document.getElementById(previewId).src = dataUrl;
                    document.getElementById(previewId).style.opacity = '1';
                    
                    // Store to global
                    if(previewId === 'prev-front') formData.imgFront = dataUrl;
                    if(previewId === 'prev-back') formData.imgBack = dataUrl;
                    if(previewId === 'prev-face') formData.imgFace = dataUrl;
                };
            };
        };

        // --- Registration Flow ---
        window.nextStep = (step) => {
            // Basic Validation
            if(step === 1) {
                const name = document.getElementById('reg-name').value;
                const phone = document.getElementById('reg-phone').value;
                if(name.length < 5) return alert("Valid Name Required");
                if(!/^07[0-9]{8}$/.test(phone)) return alert("Invalid Phone");
                formData.name = name.toUpperCase();
                formData.phone = phone;
            }
            if(step === 2) {
                const nic = document.getElementById('reg-nic').value;
                if(nic.length < 9) return alert("Invalid NIC");
                formData.nic = nic;
            }
            if(step === 3) {
                if(!formData.imgFront || !formData.imgBack || !formData.imgFace) {
                    return alert("Please upload all photos");
                }
            }

            document.getElementById(`step-${step}`).classList.remove('active');
            document.getElementById(`step-${step+1}`).classList.add('active');
        };

        window.prevStep = (step) => {
            document.getElementById(`step-${step}`).classList.remove('active');
            document.getElementById(`step-${step-1}`).classList.add('active');
        };

        window.submitRegistration = async () => {
            const pass = document.getElementById('reg-pass').value;
            const confirm = document.getElementById('reg-pass-confirm').value;

            if(pass.length < 6 || pass !== confirm) return alert("Check Password");

            toggleLoader(true, "Submitting...");

            try {
                let uid;
                
                // Check if updating existing declined user or creating new
                if (currentUser) {
                    uid = currentUser.uid;
                } else {
                    const email = `${formData.phone}@apspeedo.com`;
                    const cred = await createUserWithEmailAndPassword(auth, email, pass);
                    uid = cred.user.uid;
                }

                // SAVE TO DB: Overwrite any existing node
                await set(ref(db, 'riders/' + uid), {
                    fullName: formData.name,
                    phone: formData.phone,
                    nic: formData.nic,
                    nicFront: formData.imgFront,
                    nicBack: formData.imgBack,
                    faceImg: formData.imgFace,
                    approved_status: false, // Default
                    declinereasons: null, // Clear reasons
                    joined: new Date().toISOString()
                });

                // Check status (which will show pending)
                checkStatus(uid);

            } catch (e) {
                alert("Error: " + e.message);
                toggleLoader(false);
            }
        };

        // --- Login Logic ---
        window.handleLogin = async () => {
            const phone = document.getElementById('login-phone').value;
            const pass = document.getElementById('login-pass').value;
            const email = `${phone}@apspeedo.com`;

            toggleLoader(true);
            try {
                await signInWithEmailAndPassword(auth, email, pass);
                // Listener will handle redirect
            } catch (e) {
                alert("Login Failed");
                toggleLoader(false);
            }
        };

        // --- Re-Upload Logic ---
        window.reUpload = () => {
            // Populate form if needed, or just show register screen
            // For simplicity, we just reset the view to register step 1
            showScreen('register-screen');
            // Pre-fill logic could go here
            document.getElementById('reg-name').value = formData.name || "";
            document.getElementById('reg-phone').value = formData.phone || "";
        };

        window.logout = () => {
            signOut(auth);
            location.reload();
        };

        // --- Helpers ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => {
                if(s.id !== 'splash-screen') s.classList.remove('active');
            });
            document.getElementById(id).classList.add('active');
        }

        function showDeclined(reasons) {
            showScreen('declined-screen');
            const list = document.getElementById('decline-reasons-list');
            list.innerHTML = "";
            if(reasons) {
                reasons.forEach(r => {
                    const li = document.createElement('li');
                    li.innerText = "â€¢ " + r;
                    list.appendChild(li);
                });
            }
        }

        function showRegister() { showScreen('register-screen'); }
        function showLogin() { showScreen('login-screen'); }

        function toggleLoader(show, text="Loading...") {
            const l = document.getElementById('loader');
            document.getElementById('loader-text').innerText = text;
            l.style.display = show ? 'flex' : 'none';
        }
        
        // Export needed functions to window
        window.showRegister = showRegister;
        window.showLogin = showLogin;
    </script>
</body>
</html>
