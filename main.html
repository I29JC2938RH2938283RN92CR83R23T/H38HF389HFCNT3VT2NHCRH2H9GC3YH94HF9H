<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AP Speedo Home</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #D32F2F; --bg: #f8f9fa; --text: #212121; --white: #ffffff; --green: #2E7D32; --yellow: #FBC02D; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); min-height: 100vh; padding-bottom: 80px; }

        /* Header */
        .top-bar {
            background: var(--white); padding: 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100;
        }
        .greeting h2 { font-size: 1.2rem; font-weight: 700; color: var(--primary); }
        .greeting p { font-size: 0.8rem; color: #757575; }
        .profile-pill {
            background: var(--primary); color: var(--white);
            padding: 8px 16px; border-radius: 50px; display: flex; align-items: center; gap: 10px;
            cursor: pointer; font-size: 0.9rem; font-weight: 500;
        }

        /* Vehicle List */
        .container { padding: 20px; }
        .section-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; color: #444; }
        
        .vehicle-card {
            background: var(--white); border-radius: 16px; padding: 15px;
            margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: space-between;
            position: relative; overflow: hidden;
        }
        .v-info { display: flex; flex-direction: column; }
        .v-plate { font-size: 1.4rem; font-weight: 700; color: var(--text); letter-spacing: 1px; }
        .v-detail { font-size: 0.85rem; color: #666; display: flex; align-items: center; gap: 5px; }
        .v-color-dot { width: 12px; height: 12px; border-radius: 50%; border: 1px solid #ddd; }
        .v-status { font-size: 1.5rem; }
        
        /* Add Button */
        .add-card {
            background: var(--white); border: 2px dashed #ccc; border-radius: 16px;
            height: 80px; display: flex; align-items: center; justify-content: center;
            color: var(--primary); font-weight: 600; cursor: pointer;
        }

        /* Modals */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 200; display: none; flex-direction: column;
            overflow-y: auto;
        }
        .modal.active { display: flex; }
        .modal-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .modal-body { padding: 20px; flex: 1; }
        
        /* Profile Styles */
        .p-field { margin-bottom: 15px; }
        .p-field label { font-size: 0.8rem; color: #666; display: block; margin-bottom: 5px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; outline: none; }
        .btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: 600; margin-top: 10px; }
        .btn-sec { background: #eee; color: #333; margin-top: 10px; }

        /* Carousel Steps */
        .step { display: none; animation: fade 0.3s; }
        .step.active { display: block; }
        @keyframes fade { from {opacity:0} to {opacity:1}}

        /* Custom Radio */
        .radio-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .radio-opt {
            border: 2px solid #eee; border-radius: 12px; padding: 15px; text-align: center; cursor: pointer;
        }
        .radio-opt.selected { border-color: var(--primary); background: #FFF5F5; }
        .radio-opt span { font-size: 2rem; display: block; }

        /* Upload */
        .up-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .up-box {
            height: 100px; background: #f5f5f5; border-radius: 10px; border: 2px dashed #ccc;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; overflow: hidden;
        }
        .up-box img { width: 100%; height: 100%; object-fit: cover; position: absolute; }
        .up-box.done { border-color: var(--green); }

        /* Status Colors */
        .st-pending { border-left: 5px solid var(--yellow); }
        .st-approved { border-left: 5px solid var(--green); }
        .st-declined { border-left: 5px solid var(--primary); }

        /* Loader & Toast */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:999; display:none; justify-content:center; align-items:center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s infinite; }
        @keyframes spin { to {transform: rotate(360deg);} }
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 50px; font-size: 0.9rem; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 1000; }
        #toast.show { opacity: 1; bottom: 50px; }

    </style>
</head>
<body>

    <audio id="bg-sound" src="https://www.myinstants.com/media/sounds/severe-thunderstorm-warning-ryan-hall-yall_V5kzHWO.mp3" preload="auto"></audio>
    <div id="loader"><div class="spinner"></div></div>
    <div id="toast"></div>

    <!-- Top Bar -->
    <div class="top-bar">
        <div class="greeting">
            <h2 id="greet-msg">Hello</h2>
            <p id="greet-time">Good Morning</p>
        </div>
        <div class="profile-pill" onclick="openProfile()">
            <i class="fas fa-user-circle"></i> <span id="nav-name">User</span>
        </div>
    </div>

    <!-- Vehicle List -->
    <div class="container">
        <div class="section-title">My Vehicles (<span id="v-count">0</span>/5)</div>
        <div id="vehicle-list">
            <!-- Cards injected here -->
        </div>
        <div class="add-card" id="add-btn" onclick="openAddVehicle()">
            <i class="fas fa-plus-circle" style="margin-right: 8px;"></i> Add a Vehicle
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="modal">
        <div class="modal-header">
            <h3>My Profile</h3>
            <i class="fas fa-times" onclick="closeModal('profile-modal')" style="font-size:1.2rem;"></i>
        </div>
        <div class="modal-body">
            <div id="prof-alert" style="background:#FFF3E0; padding:10px; border-radius:8px; font-size:0.85rem; color:#E65100; display:none; margin-bottom:15px;">
                <i class="fas fa-clock"></i> Edits pending approval.
            </div>
            <div class="p-field">
                <label>Full Name</label>
                <input type="text" id="prof-name">
            </div>
            <div class="p-field">
                <label>Phone</label>
                <input type="text" id="prof-phone" readonly style="background:#eee;">
            </div>
            <div class="p-field">
                <label>NIC</label>
                <input type="text" id="prof-nic">
            </div>
            <button class="btn" id="prof-edit-btn" onclick="saveProfileEdit()">Save Changes</button>
            <button class="btn btn-sec" onclick="logout()">Logout</button>
        </div>
    </div>

    <!-- Add Vehicle Modal -->
    <div id="vehicle-modal" class="modal">
        <div class="modal-header">
            <h3>Add Vehicle</h3>
            <i class="fas fa-times" onclick="closeModal('vehicle-modal')"></i>
        </div>
        <div class="modal-body">
            
            <!-- Step 1: Type -->
            <div class="step active" id="v-step-1">
                <h4>Select Type</h4>
                <div class="radio-grid" id="type-opts">
                    <div class="radio-opt" onclick="selectType('Bike', this)"><span>üèçÔ∏è</span>Bike</div>
                    <div class="radio-opt" onclick="selectType('Tuk', this)"><span>üõ∫</span>Tuk Tuk</div>
                    <div class="radio-opt" onclick="selectType('Car', this)"><span>üöó</span>Car</div>
                    <div class="radio-opt" onclick="selectType('Van', this)"><span>üöê</span>Van</div>
                </div>
                <button class="btn" onclick="vNext(1)">Next</button>
            </div>

            <!-- Step 2: Brand/Model -->
            <div class="step" id="v-step-2">
                <h4>Details</h4>
                <div class="p-field">
                    <label>Brand</label>
                    <select id="v-brand" onchange="loadModels()"><option>Select Brand</option></select>
                </div>
                <div class="p-field">
                    <label>Model</label>
                    <select id="v-model"><option>Select Model</option></select>
                </div>
                <button class="btn" onclick="vNext(2)">Next</button>
                <button class="btn btn-sec" onclick="vPrev(2)">Back</button>
            </div>

            <!-- Step 3: Plate/Color -->
            <div class="step" id="v-step-3">
                <h4>Identification</h4>
                <div class="p-field">
                    <label>Number Plate (e.g. CAB-1234)</label>
                    <input type="text" id="v-plate" style="text-transform:uppercase; font-size:1.2rem; letter-spacing:1px; font-weight:700;">
                </div>
                <div class="p-field">
                    <label>Vehicle Color</label>
                    <input type="color" id="v-color" style="height:50px; padding:2px;">
                </div>
                <button class="btn" onclick="vNext(3)">Next</button>
                <button class="btn btn-sec" onclick="vPrev(3)">Back</button>
            </div>

            <!-- Step 4: Images -->
            <div class="step" id="v-step-4">
                <h4>Photos (Exterior & Interior)</h4>
                <p style="font-size:0.8rem; color:#666; margin-bottom:10px;">Ensure Number Plate is visible.</p>
                <div class="up-grid">
                    <div class="up-box" id="bx-out1" onclick="pick('f-out1')"><i class="fas fa-camera"></i><p>Ext 1</p><img id="i-out1"></div>
                    <div class="up-box" id="bx-out2" onclick="pick('f-out2')"><i class="fas fa-camera"></i><p>Ext 2</p><img id="i-out2"></div>
                </div>
                <div class="up-grid">
                    <div class="up-box" id="bx-in1" onclick="pick('f-in1')"><i class="fas fa-car-side"></i><p>Int 1</p><img id="i-in1"></div>
                    <div class="up-box" id="bx-in2" onclick="pick('f-in2')"><i class="fas fa-car-side"></i><p>Int 2</p><img id="i-in2"></div>
                </div>
                <!-- Hidden inputs -->
                <input type="file" id="f-out1" hidden onchange="proc(this,'i-out1','bx-out1')">
                <input type="file" id="f-out2" hidden onchange="proc(this,'i-out2','bx-out2')">
                <input type="file" id="f-in1" hidden onchange="proc(this,'i-in1','bx-in1')">
                <input type="file" id="f-in2" hidden onchange="proc(this,'i-in2','bx-in2')">
                
                <button class="btn" onclick="vNext(4)">Next</button>
                <button class="btn btn-sec" onclick="vPrev(4)">Back</button>
            </div>

            <!-- Step 5: License -->
            <div class="step" id="v-step-5">
                <h4>Driving License</h4>
                <div class="up-grid">
                    <div class="up-box" id="bx-lic1" onclick="pick('f-lic1')"><p>Front</p><img id="i-lic1"></div>
                    <div class="up-box" id="bx-lic2" onclick="pick('f-lic2')"><p>Back</p><img id="i-lic2"></div>
                </div>
                <input type="file" id="f-lic1" hidden onchange="proc(this,'i-lic1','bx-lic1')">
                <input type="file" id="f-lic2" hidden onchange="proc(this,'i-lic2','bx-lic2')">
                
                <button class="btn" onclick="vNext(5)">Next</button>
                <button class="btn btn-sec" onclick="vPrev(5)">Back</button>
            </div>

            <!-- Step 6: Agreements -->
            <div class="step" id="v-step-6">
                <h4>Agreements</h4>
                <div style="height:200px; overflow-y:scroll; background:#f9f9f9; padding:10px; font-size:0.8rem; border:1px solid #ddd; border-radius:8px;">
                    <p><strong>Driver Agreement</strong></p>
                    <p>1. I agree to follow traffic rules.</p>
                    <p>2. Vehicle details are accurate.</p>
                    <p>3. I maintain valid insurance.</p>
                    <p>4. AP Speedo is a facilitator.</p>
                    <p>...</p>
                </div>
                <div style="margin-top:10px;">
                    <input type="checkbox" id="v-agree" style="width:auto;"> <label>I Accept Terms</label>
                </div>
                <button class="btn" onclick="submitVehicle()">Submit Application</button>
                <button class="btn btn-sec" onclick="vPrev(6)">Back</button>
            </div>

        </div>
    </div>

    <!-- Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getDatabase, ref, get, set, remove, update, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const app = initializeApp({
            apiKey: "AIzaSyC3Rf4x5a_L1cYVa6soADfYktQK5WyMN-4",
            authDomain: "speedo-acb7c.firebaseapp.com",
            databaseURL: "https://speedo-acb7c-default-rtdb.asia-southeast1.firebasedatabase.app",
        });
        const auth = getAuth(app);
        const db = getDatabase(app);

        let uid = null;
        let userData = {};
        let vData = { type:'', brand:'', model:'', plate:'', color:'', imgs:{}, lic:{} };
        
        // Data Arrays
        const carData = {
            "Bike": { "Yamaha":["FZ","TW200","R15"], "Honda":["Dio","Hornet","CBR"], "Bajaj":["Pulsar","CT100","Platina"], "TVS":["Apache","Scooty"] },
            "Tuk": { "Bajaj":["RE","4S","Compact"], "TVS":["King"], "Piaggio":["Ape"] },
            "Car": { "Toyota":["Axio","Vitz","Prius","Premio","Allion"], "Honda":["Civic","Vezel","Fit"], "Suzuki":["Alto","WagonR","Swift"], "Nissan":["Leaf","Sunny"] },
            "Van": { "Toyota":["Hiace","KDH","TownAce"], "Nissan":["Caravan"] }
        };

        // Init
        window.onload = () => {
            const u = localStorage.getItem('aps_user');
            if(!u) window.location.href = 'index.html';
            uid = JSON.parse(u).uid;
            loadProfile();
            loadVehicles();
            setGreeting();
        };

        function setGreeting() {
            const h = new Date().getHours();
            const g = h < 12 ? "Good Morning" : h < 18 ? "Good Afternoon" : "Good Evening";
            document.getElementById('greet-time').innerText = g;
        }

        async function loadProfile() {
            const s = await get(ref(db, 'riders/'+uid));
            if(s.exists()) {
                userData = s.val();
                document.getElementById('nav-name').innerText = userData.fullName.split(' ')[0];
                document.getElementById('greet-msg').innerText = "Hello " + userData.fullName.split(' ')[0];
                
                // Populate Modal
                document.getElementById('prof-name').value = userData.fullName;
                document.getElementById('prof-phone').value = userData.phone;
                document.getElementById('prof-nic').value = userData.nic;

                // Check pending edit
                if(userData.pending_edit) {
                    document.getElementById('prof-alert').style.display = 'block';
                    document.getElementById('prof-edit-btn').disabled = true;
                    document.getElementById('prof-edit-btn').innerText = "Edit Pending Approval";
                }
            }
        }

        async function loadVehicles() {
            const q = query(ref(db, 'vehicles'), orderByChild('ownerId'), equalTo(uid));
            const s = await get(q);
            const list = document.getElementById('vehicle-list');
            list.innerHTML = "";
            let count = 0;

            if(s.exists()) {
                s.forEach(ch => {
                    count++;
                    const v = ch.val();
                    const statusClass = v.approved_status === true ? 'st-approved' : v.approved_status === "declined" ? 'st-declined' : 'st-pending';
                    const icon = v.approved_status === true ? '<i class="fas fa-check-circle" style="color:var(--green)"></i>' : v.approved_status === "declined" ? '<i class="fas fa-exclamation-circle" style="color:var(--primary)"></i>' : '<i class="fas fa-clock" style="color:var(--yellow)"></i>';
                    
                    let card = `
                    <div class="vehicle-card ${statusClass}" onclick="showStatus('${ch.key}', '${v.approved_status}', '${v.declinereasons}')">
                        <div class="v-info">
                            <div class="v-plate">${v.plate}</div>
                            <div class="v-detail">
                                <div class="v-color-dot" style="background:${v.color}"></div>
                                ${v.color} ${v.brand} ${v.model}
                            </div>
                        </div>
                        <div class="v-status">${icon}</div>
                    </div>`;
                    list.innerHTML += card;
                });
            }
            document.getElementById('v-count').innerText = count;
            document.getElementById('add-btn').style.display = count >= 5 ? 'none' : 'flex';
        }

        // --- Profile Edit ---
        window.saveProfileEdit = async () => {
            const name = document.getElementById('prof-name').value;
            const nic = document.getElementById('prof-nic').value;
            
            await update(ref(db, 'riders/'+uid), {
                pending_edit: { fullName: name, nic: nic, time: Date.now() }
            });
            showToast("Edit request sent for approval");
            closeModal('profile-modal');
            loadProfile();
        };

        // --- Vehicle Logic ---
        window.openAddVehicle = () => {
            document.getElementById('vehicle-modal').classList.add('active');
            document.querySelectorAll('.step').forEach(s=>s.classList.remove('active'));
            document.getElementById('v-step-1').classList.add('active');
            vData = {imgs:{}, lic:{}}; // Reset
        };

        window.selectType = (t, el) => {
            vData.type = t;
            document.querySelectorAll('.radio-opt').forEach(r=>r.classList.remove('selected'));
            el.classList.add('selected');
        };

        window.vNext = (step) => {
            if(step===1 && !vData.type) return showToast("Select Type");
            if(step===1) {
                // Populate Brands
                const bSel = document.getElementById('v-brand');
                bSel.innerHTML = "<option>Select Brand</option>";
                for(let b in carData[vData.type]) {
                    let o = document.createElement('option'); o.value=b; o.innerText=b; bSel.appendChild(o);
                }
            }
            if(step===2) {
                const b = document.getElementById('v-brand').value;
                const m = document.getElementById('v-model').value;
                if(b==="Select Brand" || m==="Select Model") return showToast("Select details");
                vData.brand = b; vData.model = m;
            }
            if(step===3) {
                const p = document.getElementById('v-plate').value;
                const c = document.getElementById('v-color').value;
                if(p.length<5) return showToast("Invalid Plate");
                vData.plate = p.toUpperCase(); vData.color = c;
            }
            if(step===4) {
                if(Object.keys(vData.imgs).length < 4) return showToast("Upload 4 photos");
            }
            if(step===5) {
                if(Object.keys(vData.lic).length < 2) return showToast("Upload License");
            }

            document.getElementById('v-step-'+step).classList.remove('active');
            document.getElementById('v-step-'+(step+1)).classList.add('active');
        };

        window.vPrev = (step) => {
            document.getElementById('v-step-'+step).classList.remove('active');
            document.getElementById('v-step-'+(step-1)).classList.add('active');
        };

        window.loadModels = () => {
            const b = document.getElementById('v-brand').value;
            const mSel = document.getElementById('v-model');
            mSel.innerHTML = "<option>Select Model</option>";
            if(carData[vData.type][b]) {
                carData[vData.type][b].forEach(m=>{
                    let o = document.createElement('option'); o.value=m; o.innerText=m; mSel.appendChild(o);
                });
            }
        };

        // --- Image Handling ---
        window.pick = (id) => document.getElementById(id).click();
        window.proc = (inp, imgId, boxId) => {
            const f = inp.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = (e) => {
                const i = new Image(); i.src = e.target.result;
                i.onload = () => {
                    const c = document.createElement('canvas');
                    const w = 500; const sc=w/i.width; c.width=w; c.height=i.height*sc;
                    c.getContext('2d').drawImage(i,0,0,w,c.height);
                    const d = c.toDataURL('image/jpeg', 0.6);
                    document.getElementById(imgId).src = d;
                    document.getElementById(boxId).classList.add('done');
                    
                    if(imgId.includes('out') || imgId.includes('in')) vData.imgs[imgId] = d;
                    if(imgId.includes('lic')) vData.lic[imgId] = d;
                }
            }; r.readAsDataURL(f);
        };

        window.submitVehicle = async () => {
            if(!document.getElementById('v-agree').checked) return showToast("Accept Agreement");
            
            document.getElementById('loader').style.display = 'flex';
            
            // Generate Numeric ID
            const vid = Date.now().toString() + Math.floor(Math.random()*1000);
            
            try {
                await set(ref(db, `vehicles/${vid}`), {
                    id: vid,
                    ownerId: uid,
                    ownerName: userData.fullName,
                    type: vData.type,
                    brand: vData.brand,
                    model: vData.model,
                    plate: vData.plate,
                    color: vData.color,
                    images: vData.imgs,
                    license: vData.lic,
                    approved_status: false,
                    submitted: Date.now()
                });
                
                // Play Sound
                document.getElementById('bg-sound').play().catch(e=>console.log(e));
                
                showToast("Vehicle Submitted!", "success");
                closeModal('vehicle-modal');
                loadVehicles();
            } catch(e) {
                console.error(e);
                showToast("Error submitting");
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        };

        // --- Status Handling ---
        window.showStatus = (vid, status, reason) => {
            if(status === "true") return; // Nothing if approved
            
            if(status === "declined") {
                const ok = confirm(`DECLINED\nReason: ${reason}\n\nDo you want to delete this application and try again?`);
                if(ok) deleteVehicle(vid);
            } else {
                alert("APPLICATION PENDING\nYour vehicle is under review. Please wait for admin approval.");
            }
        };

        async function deleteVehicle(vid) {
            await remove(ref(db, `vehicles/${vid}`));
            loadVehicles();
        }

        // Utils
        window.openProfile = () => document.getElementById('profile-modal').classList.add('active');
        window.closeModal = (id) => document.getElementById(id).classList.remove('active');
        window.showToast = (m) => { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); };
        window.logout = () => { signOut(auth); localStorage.removeItem('aps_user'); window.location.href='index.html'; };

    </script>
</body>
</html>
