<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speedo - Driver Dashboard</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mona+Sans:wght@300;400;600;700&family=Noto+Sans+Sinhala:wght@400;700&family=Noto+Sans+Tamil:wght@400;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --primary-red: #D32F2F;
            --primary-dark: #b71c1c;
            --green: #4CAF50;
            --white: #ffffff;
            --bg-gray: #e0e0e0;
            --text-dark: #333333;
            --text-light: #666666;
            --border-radius: 16px;
            --font-main: 'Poppins', 'Noto Sans Sinhala', 'Noto Sans Tamil', sans-serif;
            --glass-bg: rgba(255,255, 255, 0.95);
            --shadow-soft: 0 4px 20px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            font-family: var(--font-main);
            background-color: var(--bg-gray);
            height: 100vh; width: 100vw;
            overflow: hidden;
            user-select: none; 
            -webkit-user-select: none;
        }

        /* --- MAP CONTAINER --- */
        #map-container {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0; background: #e5e5e5;
        }

        /* --- APP LAYER --- */
        #app {
            position: relative; width: 100%; height: 100%;
            z-index: 10; display: flex; flex-direction: column;
            pointer-events: none; 
        }
        #app > * { pointer-events: auto; }

        /* RE-CENTER BUTTON */
        .map-recenter-btn {
            position: fixed; bottom: 180px; right: 20px;
            background: white; width: 50px; height: 50px; border-radius: 50%;
            display: none; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 4000; cursor: pointer;
            pointer-events: auto; z-index: 5000;
            transition: transform 0.2s;
        }
        .map-recenter-btn:active { transform: scale(0.9); }
        .map-recenter-btn .material-icons { color: #333; font-size: 24px; }

        /* LOCATION OVERLAY */
        #location-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #b71c1c; z-index: 6000;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            text-align: center; color: white;
            transition: opacity 0.5s; pointer-events: auto;
        }
        .loc-icon { font-size: 64px; margin-bottom: 20px; animation: pulseLoc 1.5s infinite; }
        .loc-title { font-size: 22px; font-weight: 700; margin-bottom: 10px; }
        .loc-desc { font-size: 14px; padding: 0 30px; opacity: 0.9; }
        @keyframes pulseLoc { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }

        /* PULSATING MARKER */
        .pulsating-icon {
            background: var(--primary-red); border-radius: 50%;
            box-shadow: 0 0 0 rgba(211, 47, 47, 0.4);
            animation: mapPulse 2s infinite;
        }
        @keyframes mapPulse {
            0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(211, 47, 47, 0); }
            100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); }
        }

        /* DRIVER ARROW MARKER */
        .dm-arrow-box { width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; }
        .dm-circle {
            width: 32px; height: 32px; background: var(--blue);
            border: 3px solid white; border-radius: 50%;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
            display: flex; justify-content: center; align-items: center;
        }
        .dm-icon { color: white; font-size: 18px; font-weight: 700; transition: transform 0.5s cubic-bezier(0.4, 2.5, 0.6, 0.8); }

        /* UTILITIES */
        .hidden { display: none !important; }
        .full-center { 
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center; 
            width: 100%; height: 100%; padding: 30px; text-align: center;
            background: white; z-index: 20; position: absolute; top: 0; left: 0;
        }
        
        input[type="text"], input[type="tel"], input[type="number"], input[type="file"] {
            width: 100%; padding: 14px; margin-bottom: 15px; border:1px solid #ddd;
            border-radius: 12px; font-family: var(--font-main); font-size: 15px; text-align: center;
            user-select: text;
        }
        input:focus { border-color: var(--primary-red); }
        
        .btn { width: 100%; padding: 15px; background: var(--primary-red); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s; user-select: none; }
        .btn:active { opacity: 0.8; }
        .btn-outline { background: transparent; border: 2px solid var(--primary-red); color: var(--primary-red); }
        .btn-success { background: var(--green); }

        /* TOAST */
        #toast-container { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 20000; width: 90%; pointer-events: none; }
        .toast { background: rgba(0,0,0,0.85); color: white; padding: 12px 24px; border-radius: 50px; text-align: center; margin-bottom: 10px; font-size: 14px; animation: fadeUp 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        @keyframes fadeUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        /* CHAT POPUP OVERLAY */
        #chat-popup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 15000;
            display: none; justify-content: center; align-items: center;
            pointer-events: none;
        }
        #chat-popup-box {
            background: white; padding: 20px; border-radius: 16px;
            max-width: 80%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            pointer-events: auto;
        }
        .chat-msg-text { font-size: 16px; font-weight: 500; margin-bottom: 5px; }
        .chat-label { font-size: 12px; color: #888; }

        /* SUCCESS POPUP */
        #success-popup {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 30px 40px; border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 7000;
            text-align: center; display: flex; flex-direction: column; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.5s ease;
        }
        #success-popup.show { opacity: 1; pointer-events: auto; }
        .success-emoji { font-size: 48px; margin-bottom: 10px; display: block; }
        .success-text { font-size: 18px; font-weight: 700; color: var(--text-dark); }

        /* LOADER */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index: 5000; display: flex; justify-content: center; align-items: center; flex-direction: column; pointer-events: auto; }
        .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top: 4px solid var(--primary-red); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* HOLD & PAYMENT SCREENS */
        #section-hold, #section-payment-block {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 4000; display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 40px; text-align: center;
        }
        .hold-icon, .pay-icon { font-size: 64px; margin-bottom: 20px; }
        .hold-icon { color: var(--primary-red); } .pay-icon { color: #FF9800; }
        .hold-title, .pay-title { font-size: 24px; font-weight: 700; margin-bottom: 15px; }
        .hold-desc, .pay-desc { font-size: 15px; color: #555; margin-bottom: 30px; }
        .pay-btn-group { display: flex; flex-direction: column; gap: 15px; width: 100%; max-width: 300px; }

        /* ========================
           ACTIVE RIDE CARD
           ======================== */
        #active-ride-card {
            position: fixed; bottom: 85px; left: 20px; right: 20px;
            background: white; padding: 15px; border-radius: 16px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15); z-index: 4600;
            display: none; 
            pointer-events: auto;
            animation: slideUpFade 0.5s ease;
        }
        @keyframes slideUpFade { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .arc-user { font-weight: 700; font-size: 16px; color: var(--text-dark); margin-bottom: 4px; }
        .arc-dest { font-size: 13px; color: #555; display: flex; align-items: center; gap: 5px; }
        .arc-icon { color: var(--primary-red); font-size: 18px; }
        .arc-status-text { font-size: 12px; color: #888; margin-top: 4px; }

        /* ========================
           NEW RIDE REQUEST MODAL
           ======================== */
        #modal-request-full {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98); z-index: 9500; 
            display: none; flex-direction: column; padding: 30px 20px;
            animation: slideUp 0.3s ease-out; user-select: none;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .req-header { text-align: center; margin-bottom: 20px; margin-top: 40px; }
        .req-title { font-size: 14px; font-weight: 700; color: #999; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 10px; }
        .req-price-big { font-size: 56px; font-weight: 800; color: var(--text-dark); margin: 5px 0; }
        .req-dist-badge { background: #f0f0f0; padding: 8px 20px; border-radius: 30px; font-size: 15px; color: #555; display: inline-block; font-weight: 600; }

        .req-details { flex: 1; padding: 30px 10px; }
        .req-row { display: flex; margin-bottom: 25px; align-items: flex-start; }
        .req-icon { font-size: 28px; margin-right: 15px; margin-top: 2px; }
        .req-addr { font-size: 16px; font-weight: 500; color: #333; line-height: 1.4; }

        .req-actions { display: flex; gap: 15px; margin-top: auto; margin-bottom: 20px; }
        .btn-decline { flex: 1; padding: 18px; border: 2px solid #ddd; background: white; color: #333; border-radius: 16px; font-weight: 700; font-size: 16px; user-select: none; }
        .btn-accept { flex: 1; padding: 18px; border: none; background: var(--green); color: white; border-radius: 16px; font-weight: 700; font-size: 16px; box-shadow: 0 4px 15px rgba(76,175,80,0.3); user-select: none; }

        /* ========================
           NAVIGATION OVERLAY
           ======================== */
        #section-navigation {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5500; display: none; flex-direction: column; pointer-events: none;
        }
        .nav-header {
            background: #222; color: white; padding: 20px;
            pointer-events: auto; margin: 15px; border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 15px;
            transition: height 0.3s ease;
        }
        .nav-arrow { font-size: 40px; color: white; }
        .nav-instr { flex: 1; overflow: hidden; }
        .nav-title { font-size: 20px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .nav-addr { font-size: 14px; color: #bbb; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .nav-footer { margin-top: auto; padding: 20px; pointer-events: auto; display: flex; justify-content: center; }
        
        /* TRIP SLIDER */
        .trip-slider {
            width: 100%; max-width: 350px; height: 60px; background: white;
            border-radius: 30px; position: relative; overflow: hidden;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2); user-select: none;
        }
        .ts-text { position: absolute; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: #333; text-transform: uppercase; letter-spacing: 1px; font-size: 14px; pointer-events: none; user-select: none; }
        .ts-thumb { width: 52px; height: 52px; background: var(--green); border-radius: 50%; position: absolute; top: 4px; left: 4px; display: flex; align-items: center; justify-content: center; color: white; z-index: 2; box-shadow: 0 2px 5px rgba(0,0,0,0.3); cursor: grab; transition: background 0.3s; user-select: none; }

        /* END TRIP MODAL */
        #modal-trip-end {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9800; display: none; flex-direction: column;
            justify-content: center; align-items: center; padding: 30px; text-align: center;
        }
        .end-price { font-size: 60px; font-weight: 800; color: var(--green); margin: 20px 0; }
        .bill-card { width: 100%; background: #f9f9f9; padding: 20px; border-radius: 16px; margin-bottom: 30px; }
        .bill-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; color: #555; }
        .bill-val { font-weight: 700; color: #333; }

        /* MODALS (Common) */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); z-index: 9000; 
            display: none; justify-content: center; align-items: center; padding: 25px; 
        }
        .modal-content { 
            background: white; width: 100%; max-width: 380px; padding: 25px; 
            border-radius: 24px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            display: flex; flex-direction: column; align-items: center;
        }
        .bank-img { width: 100%; border-radius: 8px; margin-bottom: 15px; border: 1px solid #eee; }

        /* DASHBOARD UI */
        .dash-header { padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; background: var(--glass-bg); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.5); height: 70px; pointer-events: auto; }
        .profile-circle { width: 45px; height: 45px; border-radius: 50%; background: #eee; overflow: hidden; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-shrink: 0; }
        .profile-circle img { width: 100%; height: 100%; object-fit: cover; }
        .earnings-pill-parent { background: var(--primary-red); padding: 5px 15px; border-radius: 50px; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 8px rgba(211, 47, 47, 0.3); color: white; font-weight: 600; font-size: 13px; }
        .earnings-pill-child { background: white; color: var(--text-dark); padding: 2px 10px; border-radius: 20px; font-weight: 700; min-width: 60px; text-align: center; }
        .lang-icon { font-size: 20px; color: var(--text-dark); background: #f0f0f0; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        .dash-bottom { background: var(--glass-bg); backdrop-filter: blur(15px); border-top-left-radius: 24px; border-top-right-radius: 24px; padding: 20px; box-shadow: 0 -5px 25px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 15px; position: absolute; bottom: 0; width: 100%; pointer-events: auto; transition: transform 0.3s; }
        .db-top-row { display: flex; justify-content: space-between; align-items: center; }
        .driver-info { flex: 1; }
        .d-name { font-size: 18px; font-weight: 700; color: var(--text-dark); text-align: left; }
        .d-vehicle { font-size: 13px; color: var(--text-light); margin-top: 2px; text-align: left; }
        .v-plate { color: var(--primary-red); font-weight: 600; text-transform: uppercase; }
        .vehicle-thumb { width: 40px; height: 40px; border-radius: 50%; background: #eee; overflow: hidden; margin-bottom: 5px; flex-shrink: 0; }
        .vehicle-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .db-right-col { display: flex; align-items: center; gap: 10px; }
        .rating-box { display: flex; align-items: center; gap: 4px; font-size: 13px; font-weight: 700; color: var(--text-dark); }
        .rating-box .material-icons { font-size: 14px; color: #FFC107; }

        /* MAIN SLIDER */
        .slider-wrapper { width: 100%; height: 50px; background: #eee; border-radius: 25px; position: relative; overflow: hidden; margin-top: 5px; user-select: none; }
        .slider-text { position: absolute; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; color: #999; text-transform: uppercase; letter-spacing: 1px; z-index: 1; pointer-events: none; user-select: none; }
        .slider-thumb { width: 44px; height: 44px; background: var(--primary-red); border-radius: 50%; position: absolute; left: 3px; top: 3px; z-index: 2; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: grab; color: white; user-select: none; }
        .online-status-view { height: 50px; width: 100%; background: var(--green); border-radius: 25px; display: none; align-items: center; justify-content: center; color: white; font-weight: 700; cursor: pointer; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4); user-select: none; }
        
        /* ============================
           VEHICLE REGISTRATION (From Snippet)
           ============================ */
        .carousel-step { width: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; animation: fadeIn 0.4s ease; }
        .carousel-step.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .step-title { font-size: 22px; font-weight: 700; margin-bottom: 10px; color: var(--text-dark); }
        .step-subtitle { font-size: 14px; color: #888; margin-bottom: 25px; text-align: center; }
        
        .type-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; }
        .type-card { background: #f9f9f9; border: 2px solid #eee; border-radius: 16px; height: 110px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; user-select: none; }
        .type-card.selected { border-color: var(--primary-red); background: #fff0f0; }
        .type-icon { font-size: 32px; margin-bottom: 5px; color: #555; }
        .type-card.selected .type-icon { color: var(--primary-red); }
        .type-label { font-size: 13px; font-weight: 600; color: #444; }
        
        .upload-grid-2x2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; margin-bottom: 20px; }
        .upload-grid-docs { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; margin-bottom: 20px; }
        .upload-box { background: #f9f9f9; border: 2px dashed #ccc; border-radius: 12px; height: 120px; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; overflow: hidden; cursor: pointer; transition: 0.2s; }
        .upload-box.active { border-color: var(--primary-red); background: #fff0f0; }
        .upload-label { font-size: 11px; font-weight: 600; color: #555; pointer-events: none; text-align: center; padding: 5px; }
        .upload-preview { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .upload-input { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        /* AGREEMENT SLIDER */
        .v-agree-slider { width: 100%; height: 50px; background: #eee; border-radius: 25px; position: relative; overflow: hidden; margin-top: 20px; }
        .v-agree-text { position: absolute; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: #999; text-transform: uppercase; letter-spacing: 1px; z-index: 1; }
        .v-agree-thumb { width: 44px; height: 44px; background: var(--primary-red); border-radius: 50%; position: absolute; left: 3px; top: 3px; z-index: 2; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: grab; transition: transform 0.1s; color: white; user-select: none; }
        .v-agree-thumb:active { cursor: grabbing; transform: scale(1.1); }
        .v-agree-thumb.unlocked { background: #4CAF50; transform: translateX(calc(100% - 50px)); }
        
        /* PRICE MODAL (Fixed CSS) */
        #modal-price {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 9000;
            display: none; justify-content: center; align-items: center; padding: 20px;
        }
        .price-modal { 
            background: white; width: 100%; max-width: 380px; padding: 30px; 
            border-radius: 24px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; align-items: center;
        }
        .pm-title { font-size: 20px; font-weight: 700; color: #333; margin-bottom: 5px; }
        .pm-base-text { font-size: 13px; color: #777; margin-bottom: 20px; }
        .pm-input { 
            width: 100%; padding: 15px; border: 2px solid #eee; 
            border-radius: 12px; font-size: 18px; font-weight: 700; text-align: center; 
            margin-bottom: 10px; color: var(--primary-red);
        }
        .pm-input:focus { border-color: var(--primary-red); }
        .pm-calc { font-size: 12px; color: #666; margin-bottom: 20px; background: #f0f0f0; padding: 5px 10px; border-radius: 8px; }
        .pm-btn { 
            width: 100%; padding: 15px; background: var(--green); color: white; 
            border: none; border-radius: 12px; font-size: 16px; font-weight: 700; 
            cursor: pointer; box-shadow: 0 4px 10px rgba(76,175,80,0.3); user-select: none;
        }
    </style>
</head>
<body>

    <!-- MAP CONTAINER -->
    <div id="map-container"></div>
    
    <!-- RE-CENTER BUTTON -->
    <div class="map-recenter-btn" id="recenter-btn" onclick="reCenterMap()">
        <span class="material-icons">my_location</span>
    </div>

    <!-- CHAT POPUP OVERLAY -->
    <div id="chat-popup-overlay">
        <div id="chat-popup-box">
            <div class="chat-label">New Message</div>
            <div class="chat-msg-text" id="chat-popup-text">...</div>
        </div>
    </div>

    <!-- 1. ACTIVE RIDE CARD -->
    <div id="active-ride-card">
        <div class="arc-user" id="arc-user-name">User</div>
        <div class="arc-dest">
            <span class="material-icons arc-icon">navigation</span>
            <span id="arc-dest-text">Destination</span>
        </div>
        <!-- Dynamic Status Text -->
        <div class="arc-status-text" id="arc-status-text">Ride In Progress</div>
    </div>

    <!-- 2. NEW RIDE REQUEST MODAL -->
    <div id="modal-request-full">
        <div class="req-header">
            <div class="req-title">New Request</div>
            <div class="req-price-big" id="req-price">Rs 0</div>
            <div class="req-dist-badge" id="req-dist">0 km Trip</div>
        </div>
        
        <div class="req-details">
            <div class="req-row">
                <span class="material-icons req-icon" style="color:green;">radio_button_checked</span>
                <div class="req-addr" id="req-pickup">...</div>
            </div>
            <div class="req-row">
                <span class="material-icons req-icon" style="color:red;">location_on</span>
                <div class="req-addr" id="req-drop">...</div>
            </div>
        </div>

        <div class="req-actions">
            <button class="btn-decline" onclick="declineRide()">Decline</button>
            <button class="btn-accept" onclick="acceptRide()">Accept</button>
        </div>
    </div>

    <!-- 3. NAVIGATION OVERLAY -->
    <div id="section-navigation">
        <div class="nav-header">
            <span class="material-icons nav-arrow" id="nav-icon">navigation</span>
            <div class="nav-instr">
                <div class="nav-title" id="nav-title">Pickup Passenger</div>
                <div class="nav-addr" id="nav-addr">Calculating route...</div>
            </div>
        </div>

        <div class="nav-footer">
            <div class="trip-slider" id="trip-slider">
                <div class="ts-text" id="ts-text">I'm Arrived</div>
                <div class="ts-thumb" id="ts-thumb">
                    <span class="material-icons">arrow_forward</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. END TRIP MODAL -->
    <div id="modal-trip-end">
        <span class="material-icons" style="font-size:60px; color:#4CAF50; margin-bottom:10px;">check_circle</span>
        <h2>Trip Completed</h2>
        <div style="color:#777; font-size:14px; margin-bottom:10px;">Collect Cash</div>
        <div class="end-price" id="end-final-price">Rs 0</div>
        
        <div class="bill-card">
            <div class="bill-row">
                <span>Estimated</span>
                <span class="bill-val" id="end-est">0</span>
            </div>
            <div class="bill-row">
                <span>Distance (<span id="end-km">0</span> km)</span>
                <span class="bill-val" id="end-dist-cost">0</span>
            </div>
            <div style="border-top:1px solid #ddd; margin:10px 0;"></div>
            <div class="bill-row" style="font-size:16px;">
                <span style="font-weight:700;">Final Total</span>
                <span class="bill-val" style="color:var(--primary-red);" id="end-total">0</span>
            </div>
        </div>

        <button class="btn" onclick="finishJob()">Done</button>
    </div>

    <!-- MAIN APP LAYER -->
    <div id="app">
        <!-- Dashboard Section Container -->
        <div id="section-dashboard" class="hidden" style="width:100%; height:100%; display:flex; flex-direction:column; justify-content:space-between;">
            
            <!-- HEADER -->
            <header class="dash-header" id="dash-header">
                <div class="profile-circle"><img id="dash-selfie" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="Profile"></div>
                <div class="earnings-pill-parent"><span class="earnings-label" id="t-earnings">Earnings</span><span class="earnings-pill-child" id="dash-amount">0.00</span></div>
                <div class="lang-icon" onclick="toggleLanguage()"><span class="material-icons">public</span></div>
            </header>

            <div style="flex-grow:1;"></div>

            <!-- DASHBOARD BOTTOM -->
            <div class="dash-bottom" id="dash-ui">
                <div class="db-top-row">
                    <div class="driver-info">
                        <div class="d-name" id="dash-name">Driver</div>
                        <div class="d-vehicle"><span class="v-type" id="dash-vtype">...</span> <span class="v-plate" id="dash-vplate">...</span></div>
                    </div>
                    <div class="db-right-col">
                        <!-- Vehicle Thumb -->
                        <div class="vehicle-thumb"><img id="dash-vehicle-img" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></div>
                        <div class="rating-box"><span class="material-icons">star</span><span id="dash-rating">0.0</span></div>
                    </div>
                </div>

                <div id="slider-container" class="slider-wrapper">
                    <div class="slider-text" id="t-slide-online">Slide to Go Online</div>
                    <div class="slider-thumb" id="online-thumb"><span class="material-icons" style="color:white;">arrow_forward</span></div>
                </div>

                <div id="online-view" class="online-status-view" onclick="goOffline()">
                    <span class="material-icons online-emoji">power_settings_new</span>
                    <span id="t-touch-offline">Tap to Go Offline</span>
                </div>
            </div>
        </div>
    </div>

    <!-- UTILS: PRICE MODAL -->
    <div id="modal-price">
        <div class="price-modal">
            <h3 class="pm-title" id="t-set-price">Set Hire Price</h3>
            <p class="pm-base-text" id="t-base-desc">Base amount for 1st KM included.</p>
            <div class="pm-input-group">
                <input type="number" id="input-price" class="pm-input" placeholder="0.00" oninput="updatePriceCalc()">
                <div class="pm-calc" id="calc-display">Price per KM is 0</div>
            </div>
            <button class="pm-btn" onclick="confirmOnline()">GO ONLINE</button>
            <div style="margin-top:15px; color:#999; font-size:12px; cursor:pointer; border:none; background:none;" onclick="document.getElementById('modal-price').style.display='none'" id="t-cancel">Cancel</div>
        </div>
    </div>

    <!-- UTILS: LOADER & TOAST -->
    <div id="loader"><div class="spinner"></div><p style="margin-top:15px; font-weight:600;" id="txt-loading">Loading...</p></div>
    <div id="toast-container"></div>
    <div id="success-popup"><span class="success-emoji">üéâ</span><div class="success-text" id="txt-good-luck">Good Luck Driver!</div></div>
    
    <!-- LOCATION OVERLAY -->
    <div id="location-overlay">
        <span class="material-icons loc-icon">location_searching</span>
        <h2 class="loc-title" id="loc-title">Fetching Location</h2>
        <p class="loc-desc" id="loc-desc">Please enable location access.</p>
    </div>

    <!-- ACCOUNT SCREENS -->
    <div id="section-hold" class="hidden">
        <span class="material-icons hold-icon">gpp_bad</span>
        <h1 class="hold-title" id="hold-title">Account Held</h1>
        <p class="hold-desc" id="hold-desc">Contact admin.</p>
    </div>
    
    <div id="section-payment-block" class="hidden">
        <span class="material-icons pay-icon">receipt_long</span>
        <h1 class="pay-title" id="pay-title">Payment Due</h1>
        <p class="pay-desc" id="pay-desc">Pay 1000/- to continue.</p>
        <div class="pay-btn-group">
            <button class="btn btn-outline" onclick="openBankModal()">Bank Details</button>
            <button class="btn" onclick="openPaidModal()">Paid</button>
        </div>
    </div>

    <!-- MODALS: PAYMENT & REGISTRATION -->
    <div id="modal-bank-details" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>Bank Details</h3>
            <img src="https://i.ibb.co/QFX3cMqx/c1062165-ada9-4654-849a-197a9f5084e6.jpg" class="bank-img" alt="Bank">
            <button class="btn" onclick="closeBankModal()">Close</button>
        </div>
    </div>

    <div id="modal-paid-form" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>Submit Receipt</h3>
            <input type="text" id="pay-driver-id" readonly style="background:#f5f5f5; margin-bottom:10px;">
            <div class="upload-box" id="pay-receipt-box" style="margin-bottom:15px; height:100px;">
                <span class="upload-label">Tap to Upload</span>
                <input type="file" class="upload-input" onchange="handlePayUpload(this)">
                <img id="pay-receipt-preview" class="upload-preview hidden">
            </div>
            <button class="btn btn-success" onclick="submitPayment()">Submit</button>
            <button class="btn-outline" style="border:none; margin-top:10px;" onclick="closePaidModal()">Cancel</button>
        </div>
    </div>

    <!-- VEHICLE REGISTRATION (From Snippet) -->
    <div id="section-vehicle-reg" class="full-center hidden">
        <!-- Step 1: Type -->
        <div id="v-step-1" class="carousel-step active">
            <h2 class="step-title" id="t-v-type-title">Vehicle Type</h2>
            <p class="step-subtitle" id="t-v-type-sub">Select your vehicle category</p>
            <div class="type-grid">
                <div class="type-card" onclick="selectType('bike',this)">
                    <span class="material-icons type-icon">two_wheeler</span>
                    <span class="type-label" id="t-bike">Bike</span>
                </div>
                <div class="type-card" onclick="selectType('tuk',this)">
                    <span class="material-icons type-icon">electric_rickshaw</span>
                    <span class="type-label" id="t-tuk">Tuk Tuk</span>
                </div>
                <div class="type-card" onclick="selectType('car',this)">
                    <span class="material-icons type-icon">directions_car</span>
                    <span class="type-label" id="t-car">Car</span>
                </div>
                <div class="type-card" onclick="selectType('van',this)">
                    <span class="material-icons type-icon">airport_shuttle</span>
                    <span class="type-label" id="t-van">Van</span>
                </div>
            </div>
            <button class="btn hidden" id="v-btn-1" style="margin-top:20px;" onclick="nextVStep(2)">Next</button>
        </div>
        <!-- Step 2: Details -->
        <div id="v-step-2" class="carousel-step">
            <h2 class="step-title" id="t-v-det-title">Vehicle Details</h2>
            <p class="step-subtitle" id="t-v-det-sub">Brand, Model and Number Plate</p>
            <label style="font-size:12px; color:#777; text-align:left; width:100%; margin-bottom:5px;" id="t-v-model-lbl">Vehicle Brand & Model</label>
            <input type="text" id="v-model" placeholder="e.g. Bajaj RE, Honda Dio">
            <label style="font-size:12px; color:#777; text-align:left; width:100%; margin-bottom:5px;" id="t-v-plate-lbl">Number Plate</label>
            <input type="text" id="v-plate" placeholder="e.g. AB-1234" style="text-transform: uppercase;">
            <button class="btn" onclick="nextVStep(3)" id="t-btn-next-2">Next</button>
            <button class="btn-outline" style="border:none; margin-top:10px;" onclick="nextVStep(1)" id="t-btn-back-2">Back</button>
        </div>
        <!-- Step 3: Photos -->
        <div id="v-step-3" class="carousel-step">
            <h2 class="step-title" id="t-v-pho-title">Vehicle Photos</h2>
            <p class="step-subtitle" id="t-v-pho-sub">Upload clear images (2 Outside, 2 Inside)</p>
            <div class="upload-grid-2x2">
                <div class="upload-box" id="up-out-1"><span class="upload-label" id="t-out1">Outside 1</span><input type="file" class="upload-input" accept="image/*" onchange="handleVUpload(this,'out1')"><img class="upload-preview hidden"></div>
                <div class="upload-box" id="up-out-2"><span class="upload-label" id="t-out2">Outside 2</span><input type="file" class="upload-input" accept="image/*" onchange="handleVUpload(this,'out2')"><img class="upload-preview hidden"></div>
                <div class="upload-box" id="up-in-1"><span class="upload-label" id="t-in1">Inside 1</span><input type="file" class="upload-input" accept="image/*" onchange="handleVUpload(this,'in1')"><img class="upload-preview hidden"></div>
                <div class="upload-box" id="up-in-2"><span class="upload-label" id="t-in2">Inside 2</span><input type="file" class="upload-input" accept="image/*" onchange="handleVUpload(this,'in2')"><img class="upload-preview hidden"></div>
            </div>
            <button class="btn" onclick="validateVStep3()" id="t-btn-next-3">Next</button>
            <button class="btn-outline" style="border:none; margin-top:10px;" onclick="nextVStep(2)" id="t-btn-back-3">Back</button>
        </div>
        <!-- Step 4: Docs -->
        <div id="v-step-4" class="carousel-step">
            <h2 class="step-title" id="t-v-doc-title">Documents</h2>
            <p class="step-subtitle" id="t-v-doc-sub">Revenue Permit & Insurance</p>
            <div class="upload-grid-docs">
                <div class="upload-box" id="up-permit"><span class="upload-label" id="t-permit">Revenue Permit</span><input type="file" class="upload-input" accept="image/*" onchange="handleVUpload(this,'permit')"><img class="upload-preview hidden"></div>
                <div class="upload-box" id="up-insurance"><span class="upload-label" id="t-ins">Insurance Cert</span><input type="file" class="upload-input" accept="image/*" onchange="handleVUpload(this,'insurance')"><img class="upload-preview hidden"></div>
            </div>
            <button class="btn" onclick="validateVStep4()" id="t-btn-next-4">Next</button>
            <button class="btn-outline" style="border:none; margin-top:10px;" onclick="nextVStep(3)" id="t-btn-back-4">Back</button>
        </div>
        <!-- Step 5: Agreement -->
        <div id="v-step-5" class="carousel-step">
            <h2 class="step-title" id="t-agree-title">Agreement</h2>
            <div style="height: 200px; overflow-y: auto; text-align: left; font-size: 12px; color: #555; line-height: 1.6; background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                <p style="margin-bottom:10px;" id="t-terms-1"><strong>Terms of Service:</strong> By registering this vehicle, you agree to adhere to Speedo's standards of service and safety.</p>
                <p style="color:var(--primary-red); font-weight:600;" id="t-terms-2"><strong>Weekly Fee:</strong> You agree to pay a subscription fee of LKR 1000/- per week to Speedo LK to keep your driver profile active and online.</p>
            </div>
            <div class="slider-wrapper" id="v-agree-slider">
                <div class="slider-text" id="t-slide">Slide to Agree</div>
                <div class="slider-thumb" id="v-agree-thumb"><span class="material-icons" style="color:white; font-size:18px;">arrow_forward</span></div>
            </div>
            <button class="btn-outline" style="border:none; margin-top:15px;" onclick="nextVStep(4)" id="t-btn-back-5">Back</button>
        </div>
    </div>

    <!-- WELCOME MODAL -->
    <div id="modal-welcome" class="modal-overlay hidden">
        <div class="welcome-card" style="background:white; width:100%; max-width:400px; padding:30px; border-radius:24px; text-align:center;">
            <h2 id="welcome-name" style="margin-bottom:15px;">Welcome!</h2>
            <p id="t-welcome-body" class="welcome-text" style="font-size:14px; color:#444; line-height:1.6; margin-bottom:20px;">Loading welcome message...</p>
            <input type="text" id="promo-code" class="promo-input" placeholder="Promo Code (Optional)" style="background:#f0f0f0; border:none; margin-bottom:10px;">
            <button class="btn-outline" onclick="checkPromo()" id="t-btn-check" style="padding: 8px; font-size:13px; border-radius:8px; margin-bottom:10px;">Check Code</button>
            <div id="t-promo-msg" class="hidden promo-success" style="color:#4CAF50; font-size:12px; margin-bottom:10px; font-weight:600;">You have gained 14 days free app usage by PROMO CODE!</div>
            <button class="btn" onclick="finalizeWelcome()" id="t-btn-agree">I Agree</button>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, get, child, update, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyC3Rf4x5a_L1cYVa6soADfYktQK5WyMN-4", authDomain: "speedo-acb7c.firebaseapp.com", databaseURL: "https://speedo-acb7c-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "speedo-acb7c", storageBucket: "speedo-acb7c.firebasestorage.app", messagingSenderId: "31066493782", appId: "1:31066493782:web:e3e9dfa209fa855bc17cf7", measurementId: "G-ND3GRGL0WQ" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        window.fbDb = db; window.fbRef = ref; window.fbSet = set; window.fbGet = get; window.fbChild = child; window.fbUpdate = update; window.fbOnValue = onValue; window.fbOnDisconnect = onDisconnect;
    </script>

    <script>
        // --- AUDIO PRELOADING ---
        const soundOrder = new Audio("https://www.myinstants.com/media/sounds/severe-thunderstorm-warning-ryan-hall-yall_V5kzHWO.mp3");
        const soundMsg = new Audio("https://www.myinstants.com/media/sounds/tethys.mp3");

        // GLOBAL STATE
        let driverId = localStorage.getItem('speedo_driver_id');
        let driverData = null;
        let vehicleData = {}; 
        let map = null, driverMarker = null, routeLine = null;
        let isOnline = false, isTracking = true;
        let pricePer100m = 0;
        let currentRide = null; 
        let tripState = 'idle'; 
        let tripDist = 0; 
        let lastLoc = null; 
        let watchId = null;
        let tempReceiptBase64 = null;
        let isPromoValid = false;
        let userName = "Passenger";

        // TRANSLATIONS
        const translations = {
            en: { welcome: "Welcome", loading: "Loading...", locTitle: "Fetching Location", locDesc: "Enable location access", goodLuck: "Good Luck Driver!", vTypeTitle: "Vehicle Type", vTypeSub: "Select your vehicle category", bike: "Bike", tuk: "Tuk Tuk", car: "Car", van: "Van", vDetTitle: "Vehicle Details", vDetSub: "Brand, Model and Number Plate", vModelLbl: "Vehicle Brand & Model", vPlateLbl: "Number Plate", vPlatePh: "e.g. AB-1234", vPhoTitle: "Vehicle Photos", vPhoSub: "Upload clear images (2 Outside, 2 Inside)", out1: "Outside 1", out2: "Outside 2", in1: "Inside 1", in2: "Inside 2", vDocTitle: "Documents", vDocSub: "Revenue Permit & Insurance", permit: "Revenue Permit", ins: "Insurance Cert", agreeTitle: "Agreement", terms1: "<strong>Terms of Service:</strong> By registering this vehicle, you agree to adhere to Speedo's standards of service and safety.", terms2: "<strong>Weekly Fee:</strong> You agree to pay a subscription fee of LKR 1000/- per week to Speedo LK to keep your driver profile active and online.", slide: "Slide to Agree", welcomeBody: "To continue keeping your driver profile updated and online, you need to pay LKR 1000/- every week to Speedo LK. You will be notified when week is over.", btnNext: "Next", btnBack: "Back", btnCheck: "Check Code", btnAgree: "I Agree", promoSuccess: "You have gained 14 days free app usage by PROMO CODE!", earnings: "Earnings", slideOnline: "Slide to Go Online", setPrice: "Set Price", baseDesc: "Base amount for 1st KM included", per100m: "Price per 100m", cancel: "Cancel", touchOffline: "Tap to Go Offline" },
            si: { welcome: "‡∂Ü‡∂∫‡∑î‡∂∂‡∑ù‡∑Ä‡∂±‡∑ä", loading: "‡∂¥‡∑ñ‡∂ª‡∂´‡∂∫ ‡∑Ä‡∑ô‡∂∏‡∑í‡∂±‡∑ä...", locTitle: "‡∂¥‡∑í‡∑Ñ‡∑í‡∂ß‡∑ì‡∂∏ ‡∑É‡∑ú‡∂∫‡∂∏‡∑í‡∂±‡∑ä", locDesc: "Location ‡∑É‡∂∂‡∂Ω ‡∂ö‡∂ª‡∂±‡∑ä‡∂±", goodLuck: "‡∑É‡∑î‡∂∑ ‡∂¥‡∑ê‡∂≠‡∑î‡∂∏‡∑ä!", vTypeTitle: "‡∑Ä‡∑è‡∑Ñ‡∂± ‡∑Ä‡∂ª‡∑ä‡∂ú‡∂∫", vTypeSub: "‡∂î‡∂∂‡∑ö ‡∑Ä‡∑è‡∑Ñ‡∂± ‡∂ö‡∑è‡∂´‡∑ä‡∂©‡∂∫ ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±", bike: "‡∂∫‡∂≠‡∑î‡∂ª‡∑î‡∂¥‡∑ê‡∂Ø‡∑í", tuk: "‡∂≠‡∑ä‚Äç‡∂ª‡∑í‡∂ª‡∑ù‡∂Ø ‡∂ª‡∂Æ", car: "‡∂ö‡∑è‡∂ª‡∑ä", van: "‡∑Ä‡∑ë‡∂±‡∑ä", vDetTitle: "‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª", vDetSub: "‡∑Ä‡∑ô‡∑Ö‡∂≥ ‡∂±‡∑è‡∂∏‡∂∫ ‡∑É‡∑Ñ ‡∂∏‡∑è‡∂Ø‡∑í‡∂Ω‡∑í‡∂∫", vModelLbl: "‡∑Ä‡∑è‡∑Ñ‡∂± ‡∑Ä‡∑ô‡∑Ö‡∂≥ ‡∂±‡∑è‡∂∏‡∂∫ ‡∑É‡∑Ñ ‡∂∏‡∑è‡∂Ø‡∑í‡∂Ω‡∑í‡∂∫", vPlateLbl: "‡∂ª‡∑í‡∂∫ ‡∂Ö‡∂Ç‡∂ö ‡∂≠‡∑Ñ‡∂©‡∑î‡∑Ä", vPlatePh: "‡∂ã‡∂Ø‡∑è: AB-1234", vPhoTitle: "‡∑Ä‡∑è‡∑Ñ‡∂± ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥", vPhoSub: "‡∂¥‡∑ê‡∑Ñ‡∑ê‡∂Ø‡∑í‡∂Ω‡∑í ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥ (‡∂¥‡∑í‡∂ß‡∂≠‡∑í‡∂±‡∑ä 2, ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑í‡∂±‡∑ä 2)", out1: "‡∂¥‡∑í‡∂ß‡∂≠ 1", out2: "‡∂¥‡∑í‡∂ß‡∂≠ 2", in1: "‡∂á‡∂≠‡∑î‡∑Ö‡∂≠ 1", in2: "‡∂á‡∂≠‡∑î‡∑Ö‡∂≠ 2", vDocTitle: "‡∂Ω‡∑ö‡∂õ‡∂±", vDocSub: "‡∂Ü‡∂Ø‡∑è‡∂∫‡∂∏‡∑ä ‡∂∂‡∂Ω‡∂¥‡∂≠‡∑ä‚Äç‡∂ª‡∂∫ ‡∑É‡∑Ñ ‡∂ª‡∂ö‡∑ä‡∑Ç‡∂´‡∂∫", permit: "‡∂Ü‡∂Ø‡∑è‡∂∫‡∂∏‡∑ä ‡∂∂‡∂Ω‡∂¥‡∂≠‡∑ä‚Äç‡∂ª‡∂∫", ins: "‡∂ª‡∂ö‡∑ä‡∑Ç‡∂´ ‡∑É‡∑Ñ‡∂≠‡∑í‡∂ö‡∂∫", agreeTitle: "‡∂ú‡∑í‡∑Ä‡∑í‡∑É‡∑î‡∂∏", terms1: "<strong>‡∑É‡∑ö‡∑Ä‡∑è ‡∂ö‡∑ú‡∂±‡∑ä‡∂Ø‡∑ö‡∑É‡∑í:</strong> ‡∂∏‡∑ô‡∂∏ ‡∑Ä‡∑è‡∑Ñ‡∂±‡∂∫ ‡∂Ω‡∑í‡∂∫‡∑è‡∂¥‡∂Ø‡∑í‡∂Ç‡∂†‡∑í ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ô‡∂±‡∑ä, ‡∂î‡∂∂ ‡∑É‡∑ä‡∂¥‡∑ì‡∂©‡∑ù ‡∑Ñ‡∑í ‡∑É‡∑ö‡∑Ä‡∑è ‡∑É‡∑Ñ ‡∂Ü‡∂ª‡∂ö‡∑ä‡∑Ç‡∂ö ‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∑í‡∂≠‡∑ì‡∂±‡∑ä‡∂ß ‡∂Ö‡∂±‡∑î‡∂ö‡∑ñ‡∂Ω ‡∑Ä‡∑ì‡∂∏‡∂ß ‡∂ë‡∂ö‡∂ü ‡∑Ä‡∑ö.", terms2: "<strong>‡∑É‡∂≠‡∑í‡∂¥‡∂≠‡∑è ‡∂ú‡∑è‡∑É‡∑ä‡∂≠‡∑î‡∑Ä:</strong> ‡∂î‡∂∂‡∂ú‡∑ö ‡∂ª‡∑í‡∂∫‡∂Ø‡∑î‡∂ª‡∑î ‡∂ú‡∑í‡∂´‡∑î‡∂∏ ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂ö‡∑è‡∂ª‡∑ì‡∑Ä ‡∂≠‡∂∂‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏ ‡∑É‡∂≥‡∑Ñ‡∑è ‡∑É‡∑ä‡∂¥‡∑ì‡∂©‡∑ù ‡∂ë‡∂Ω‡∑ä‡∂ö‡∑ö ‡∑Ä‡∑ô‡∂≠ ‡∑É‡∂≠‡∑í‡∂ö ‡∂ª‡∑î. 1000/- ‡∂ö ‡∂Ø‡∑è‡∂∫‡∂ö ‡∂∏‡∑î‡∂Ø‡∂Ω‡∂ö‡∑ä ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∂ß ‡∂î‡∂∂ ‡∂ë‡∂ö‡∂ü ‡∑Ä‡∑ö.", slide: "‡∂ë‡∂ö‡∂ü ‡∑Ä‡∑ì‡∂∏‡∂ß ‡∑É‡∑ä‡∂Ω‡∂∫‡∑í‡∂©‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±", welcomeBody: "‡∂î‡∂∂‡∂ú‡∑ö ‡∂ú‡∑í‡∂´‡∑î‡∂∏ ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂≠‡∑ä‡∂∏‡∂ö‡∑Ä ‡∂¥‡∑Ä‡∂≠‡∑ä‡∑Ä‡∑è‡∂ú‡∑ô‡∂± ‡∂∫‡∑è‡∂∏ ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂î‡∂∂‡∂ß ‡∑É‡∑ë‡∂∏ ‡∑É‡∂≠‡∑í‡∂∫‡∂ö‡∑ä ‡∂Ö‡∑Ä‡∑É‡∑è‡∂±‡∂∫‡∑ö ‡∑É‡∂∏‡∑è‡∂ú‡∂∏ ‡∑Ä‡∑ô‡∂≠ ‡∂ª‡∑î‡∂¥‡∑í‡∂∫‡∂Ω‡∑ä 1000‡∂ö ‡∂∏‡∑î‡∂Ø‡∂Ω‡∂ö‡∑ä ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∂ß ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫ ‡∑Ä‡∑ö.", btnNext: "‡∂ä‡∑Ö‡∂ü", btnBack: "‡∂Ü‡∂¥‡∑É‡∑î", btnCheck: "‡∂ö‡∑ö‡∂≠‡∂∫ ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±", btnAgree: "‡∂∏‡∂∏ ‡∂ë‡∂ö‡∂ü ‡∑Ä‡∑ô‡∂∏‡∑í", promoSuccess: "‡∂¥‡∑ä‚Äç‡∂ª‡∑Ä‡∂ª‡∑ä‡∂∞‡∂± ‡∂ö‡∑ö‡∂≠‡∂∫ ‡∂∏‡∂ú‡∑í‡∂±‡∑ä ‡∂î‡∂∂‡∂ß ‡∂Ø‡∑í‡∂± 14‡∂ö ‡∂±‡∑ú‡∂∏‡∑í‡∂Ω‡∑ö ‡∂∫‡∑ô‡∂Ø‡∑î‡∂∏‡∑ä ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∂∫ ‡∑Ñ‡∑í‡∂∏‡∑í‡∑Ä‡∑í‡∂∫!", earnings: "‡∂Ü‡∂Ø‡∑è‡∂∫‡∂∏", slideOnline: "‡∂∏‡∑è‡∂ª‡∑ä‡∂ú‡∂ú‡∂≠ ‡∑Ä‡∂±‡∑ä‡∂±", setPrice: "‡∂∏‡∑í‡∂Ω", baseDesc: "‡∂∏‡∑ñ‡∂Ω‡∑í‡∂ö ‡∂∏‡∑î‡∂Ø‡∂Ω (1 KM)", per100m: "100m ‡∂ö ‡∂∏‡∑í‡∂Ω", cancel: "‡∂Ö‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î", touchOffline: "‡∂∏‡∑è‡∂ª‡∑ä‡∂ú‡∂ú‡∂≠‡∑Ä‡∑ì‡∂∏ ‡∂±‡∑Ä‡∂≠‡∑ä‡∑Ä‡∂±‡∑ä‡∂± ‡∂≠‡∑Ä‡∂∏ ‡∂≠‡∂ß‡∑ä‡∂ß‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±" },
            ta: { welcome: "‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç", loading: "‡Æè‡Æ±‡Øç‡Æ±‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...", locTitle: "‡Æá‡Æü‡ÆÆ‡Øç ‡Æ§‡Øá‡Æü‡Æ≤‡Øç", locDesc: "Location ‡Æê ‡Æá‡ÆØ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç", goodLuck: "‡Æµ‡Ææ‡Æ¥‡Øç‡Æ§‡Øç‡Æ§‡ØÅ‡Æï‡Øç‡Æï‡Æ≥‡Øç!", vTypeTitle: "‡Æµ‡Ææ‡Æï‡Æ© ‡Æµ‡Æï‡Øà", vTypeSub: "‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æµ‡Ææ‡Æï‡Æ© ‡Æµ‡Æï‡Øà‡ÆØ‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç", bike: "‡Æ™‡Øà‡Æï‡Øç", tuk: "‡ÆÜ‡Æü‡Øç‡Æü‡Øã", car: "‡Æï‡Ææ‡Æ∞‡Øç", van: "‡Æµ‡Øá‡Æ©‡Øç", vDetTitle: "‡Æµ‡Ææ‡Æï‡Æ© ‡Æµ‡Æø‡Æµ‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øç", vDetSub: "‡Æ™‡Æø‡Æ∞‡Ææ‡Æ£‡Øç‡Æü‡Øç & ‡ÆÆ‡Ææ‡Æü‡Æ≤‡Øç", vModelLbl: "‡Æµ‡Ææ‡Æï‡Æ© ‡Æ™‡Æø‡Æ∞‡Ææ‡Æ£‡Øç‡Æü‡Øç & ‡ÆÆ‡Ææ‡Æü‡Æ≤‡Øç", vPlateLbl: "‡Æµ‡Ææ‡Æï‡Æ© ‡Æé‡Æ£‡Øç ‡Æ§‡Æï‡Æü‡ØÅ", vPlatePh: "‡Æâ.‡ÆÆ‡Øç: AB-1234", vPhoTitle: "‡Æµ‡Ææ‡Æï‡Æ© ‡Æ™‡ØÅ‡Æï‡Øà‡Æ™‡Øç‡Æ™‡Æü‡Æô‡Øç‡Æï‡Æ≥‡Øç", vPhoSub: "‡Æ§‡ØÜ‡Æ≥‡Æø‡Æµ‡Ææ‡Æ© ‡Æ™‡Æü‡Æô‡Øç‡Æï‡Æ≥‡Øà ‡Æ™‡Æ§‡Æø‡Æµ‡Øá‡Æ±‡Øç‡Æ±‡Æµ‡ØÅ‡ÆÆ‡Øç (2 ‡Æµ‡ØÜ‡Æ≥‡Æø‡ÆØ‡Øá, 2 ‡Æâ‡Æ≥‡Øç‡Æ≥‡Øá)", out1: "‡Æµ‡ØÜ‡Æ≥‡Æø‡ÆØ‡Øá 1", out2: "‡Æµ‡ØÜ‡Æ≥‡Æø‡ÆØ‡Øá 2", in1: "‡Æâ‡Æ≥‡Øç‡Æ≥‡Øá 1", in2: "‡Æâ‡Æ≥‡Øç‡Æ≥‡Øá 2", vDocTitle: "‡ÆÜ‡Æµ‡Æ£‡Æô‡Øç‡Æï‡Æ≥‡Øç", vDocSub: "‡Æµ‡Æ∞‡ØÅ‡Æµ‡Ææ‡ÆØ‡Øç ‡ÆÖ‡Æ©‡ØÅ‡ÆÆ‡Æ§‡Æø & ‡Æï‡Ææ‡Æ™‡Øç‡Æ™‡ØÄ‡Æü‡ØÅ", permit: "‡Æµ‡Æ∞‡ØÅ‡Æµ‡Ææ‡ÆØ‡Øç ‡ÆÖ‡Æ©‡ØÅ‡ÆÆ‡Æ§‡Æø", ins: "‡Æï‡Ææ‡Æ™‡Øç‡Æ™‡ØÄ‡Æü‡ØÅ ‡Æö‡Ææ‡Æ©‡Øç‡Æ±‡Æø‡Æ§‡Æ¥‡Øç", agreeTitle: "‡Æí‡Æ™‡Øç‡Æ™‡Æ®‡Øç‡Æ§‡ÆÆ‡Øç", terms1: "<strong>‡Æö‡Øá‡Æµ‡Øà ‡Æµ‡Æø‡Æ§‡Æø‡ÆÆ‡ØÅ‡Æ±‡Øà‡Æï‡Æ≥‡Øç:</strong> ‡Æá‡Æ®‡Øç‡Æ§ ‡Æµ‡Ææ‡Æï‡Æ©‡Æ§‡Øç‡Æ§‡Øà ‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡Æµ‡Æ§‡Æ©‡Øç ‡ÆÆ‡ØÇ‡Æ≤‡ÆÆ‡Øç, ‡Æ∏‡Øç‡Æ™‡ØÄ‡Æü‡Øã‡Æµ‡Æø‡Æ©‡Øç ‡Æö‡Øá‡Æµ‡Øà ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç ‡Æ™‡Ææ‡Æ§‡ØÅ‡Æï‡Ææ‡Æ™‡Øç‡Æ™‡ØÅ ‡Æ§‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øà ‡Æï‡Æü‡Øà‡Æ™‡Æø‡Æü‡Æø‡Æï‡Øç‡Æï ‡Æí‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Øç‡Æï‡Øä‡Æ≥‡Øç‡Æï‡Æø‡Æ±‡ØÄ‡Æ∞‡Øç‡Æï‡Æ≥‡Øç.", terms2: "<strong>‡Æµ‡Ææ‡Æ∞‡Ææ‡Æ®‡Øç‡Æ§‡Æø‡Æ∞ ‡Æï‡Æü‡Øç‡Æü‡Æ£‡ÆÆ‡Øç:</strong> ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æü‡Æø‡Æ∞‡Øà‡Æµ‡Æ∞‡Øç ‡Æö‡ØÅ‡ÆØ‡Æµ‡Æø‡Æµ‡Æ∞‡Æ§‡Øç‡Æ§‡Øà ‡Æö‡ØÜ‡ÆØ‡Æ≤‡Æø‡Æ≤‡Øç ‡Æµ‡Øà‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡ØÅ‡Æï‡Øç‡Æï, ‡Æ∏‡Øç‡Æ™‡ØÄ‡Æü‡Øã ‡Æé‡Æ≤‡Øç‡Æï‡Øá ‡Æ®‡Æø‡Æ±‡ØÅ‡Æµ‡Æ©‡Æ§‡Øç‡Æ§‡Æø‡Æ±‡Øç‡Æï‡ØÅ ‡Æµ‡Ææ‡Æ∞‡Æ§‡Øç‡Æ§‡Æø‡Æ±‡Øç‡Æï‡ØÅ ‡Æ∞‡ØÇ. 1000/- ‡Æö‡ØÜ‡Æ≤‡ØÅ‡Æ§‡Øç‡Æ§ ‡Æí‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Øç‡Æï‡Øä‡Æ≥‡Øç‡Æï‡Æø‡Æ±‡ØÄ‡Æ∞‡Øç‡Æï‡Æ≥‡Øç.", slide: "‡Æí‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Øç‡Æï‡Øä‡Æ≥‡Øç‡Æ≥ ‡Æ®‡Æï‡Æ∞‡Øç‡Æ§‡Øç‡Æ§‡Æµ‡ØÅ‡ÆÆ‡Øç", welcomeBody: "‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æü‡Æø‡Æ∞‡Øà‡Æµ‡Æ∞‡Øç ‡Æö‡ØÅ‡ÆØ‡Æµ‡Æø‡Æµ‡Æ∞‡Æ§‡Øç‡Æ§‡Øà ‡Æö‡ØÜ‡ÆØ‡Æ≤‡Æø‡Æ≤‡Øç ‡Æµ‡Øà‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡ØÅ‡Æï‡Øç‡Æï, ‡Æ®‡ØÄ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ∏‡Øç‡Æ™‡ØÄ‡Æü‡Øã ‡Æé‡Æ≤‡Øç‡Æï‡Øá ‡Æ®‡Æø‡Æ±‡ØÅ‡Æµ‡Æ©‡Æ§‡Øç‡Æ§‡Æø‡Æ±‡Øç‡Æï‡ØÅ ‡Æµ‡Ææ‡Æ∞‡Æ§‡Øç‡Æ§‡Æø‡Æ±‡Øç‡Æï‡ØÅ ‡Æ∞‡ØÇ. 1000/- ‡Æö‡ØÜ‡Æ≤‡ØÅ‡Æ§‡Øç‡Æ§ ‡Æµ‡Øá‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç. ‡Æµ‡Ææ‡Æ∞‡ÆÆ‡Øç ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡ØÅ‡ÆÆ‡Øç ‡Æ™‡Øã‡Æ§‡ØÅ ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡ØÅ‡Æï‡Øç‡Æï‡ØÅ ‡Æ§‡ØÜ‡Æ∞‡Æø‡Æµ‡Æø‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡ÆÆ‡Øç.", btnNext: "‡ÆÖ‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ", btnBack: "‡Æ™‡Æø‡Æ©‡Øç‡Æ©‡Ææ‡Æ≤‡Øç", btnCheck: "‡Æï‡ØÅ‡Æ±‡Æø‡ÆØ‡ØÄ‡Æü‡Øç‡Æü‡Øà ‡Æö‡Æ∞‡Æø‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç", btnAgree: "‡Æ®‡Ææ‡Æ©‡Øç ‡Æí‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Øç‡Æï‡Øä‡Æ≥‡Øç‡Æï‡Æø‡Æ±‡Øá‡Æ©‡Øç", promoSuccess: "PROMO CODE ‡ÆÆ‡ØÇ‡Æ≤‡ÆÆ‡Øç 14 ‡Æ®‡Ææ‡Æü‡Øç‡Æï‡Æ≥‡Øç ‡Æá‡Æ≤‡Æµ‡Æö ‡Æ™‡ÆØ‡Æ©‡Øç‡Æ™‡Ææ‡Æü‡Øç‡Æü‡Øà‡Æ™‡Øç ‡Æ™‡ØÜ‡Æ±‡Øç‡Æ±‡ØÅ‡Æ≥‡Øç‡Æ≥‡ØÄ‡Æ∞‡Øç‡Æï‡Æ≥‡Øç!", earnings: "‡Æµ‡Æ∞‡ØÅ‡ÆÆ‡Ææ‡Æ©‡ÆÆ‡Øç", slideOnline: "‡ÆÜ‡Æ©‡Øç‡Æ≤‡Øà‡Æ©‡Æø‡Æ≤‡Øç ‡Æö‡ØÜ‡Æ≤‡Øç‡Æ≤", setPrice: "‡Æµ‡Æø‡Æ≤‡Øà", baseDesc: "‡ÆÖ‡Æü‡Æø‡Æ™‡Øç‡Æ™‡Æü‡Øà ‡Æ§‡Øä‡Æï‡Øà (1 KM)", per100m: "100 ‡ÆÆ‡ØÄ ‡Æµ‡Æø‡Æ≤‡Øà", cancel: "‡Æ∞‡Æ§‡Øç‡Æ§‡ØÅ", touchOffline: "‡ÆÜ‡ÆÉ‡Æ™‡Øç‡Æ≤‡Øà‡Æ©‡Øç ‡Æö‡ØÜ‡Æ≤‡Øç‡Æ≤ ‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æ§‡Æü‡Øç‡Æü‡Æµ‡ØÅ‡ÆÆ‡Øç" }
        };
        let currentLang = localStorage.getItem('language') || 'en';
        const t = translations[currentLang];

        // --- TOAST HELPER ---
        function showToast(msg) {
            const c = document.getElementById('toast-container');
            const d = document.createElement('div'); d.className='toast'; d.innerText=msg; c.appendChild(d);
            setTimeout(()=>{ d.style.opacity='0'; setTimeout(()=>d.remove(),300); }, 3000);
        }

        // --- CHAT POPUP HELPER ---
        function showChatPopup(msg) {
            const overlay = document.getElementById('chat-popup-overlay');
            const text = document.getElementById('chat-popup-text');
            text.innerText = msg;
            overlay.style.display = 'flex';
            setTimeout(() => {
                overlay.style.opacity = '1';
            }, 10);
            
            setTimeout(() => {
                overlay.style.opacity = '0';
                setTimeout(() => overlay.style.display = 'none', 300);
            }, 2000);
        }

        function applyTranslations() {
            const els = {
                'txt-loading':t.loading, 'loc-title':t.locTitle, 'loc-desc':t.locDesc, 'txt-good-luck':t.goodLuck,
                'hold-title':'Account Held', 'hold-desc':'Contact Admin', 'pay-title':'Payment Due', 'pay-desc':'Pay 1000/-',
                't-v-type-title':t.vTypeTitle, 't-v-type-sub':t.vTypeSub, 't-bike':t.bike, 't-tuk':t.tuk, 't-car':t.car, 't-van':t.van,
                't-v-det-title':t.vDetTitle, 't-v-det-sub':t.vDetSub, 't-v-model-lbl':t.vModelLbl, 't-v-plate-lbl':t.vPlateLbl,
                't-v-pho-title':t.vPhoTitle, 't-v-pho-sub':t.vPhoSub, 't-out1':t.out1, 't-out2':t.out2, 't-in1':t.in1, 't-in2':t.in2,
                't-v-doc-title':t.vDocTitle, 't-v-doc-sub':t.vDocSub, 't-permit':t.permit, 't-ins':t.ins,
                't-agree-title':t.agreeTitle, 't-terms-1':t.terms1, 't-terms-2':t.terms2, 't-slide':t.slide,
                't-welcome-body':t.welcomeBody, 't-btn-check':t.btnCheck, 't-btn-agree':t.btnAgree, 't-promo-msg':t.promoSuccess,
                't-earnings':t.earnings, 't-slide-online':t.slideOnline, 't-set-price':t.setPrice, 't-per-100m':t.per100m,
                't-cancel':t.cancel, 't-touch-offline':t.touchOffline, 't-base-desc':t.baseDesc,
                'v-btn-1':t.btnNext, 't-btn-next-2':t.btnNext, 't-btn-back-2':t.btnBack, 't-btn-next-3':t.btnNext,
                't-btn-back-3':t.btnBack, 't-btn-next-4':t.btnNext, 't-btn-back-4':t.btnBack, 't-btn-back-5':t.btnBack
            };
            for(let id in els) {
                const el = document.getElementById(id);
                if(el) {
                    if(id === 't-terms-1' || id === 't-terms-2') {
                        el.innerHTML = els[id];
                    } else {
                        el.innerHTML = els[id];
                    }
                }
            }
            if(document.getElementById('v-plate')) document.getElementById('v-plate').placeholder = t.vPlatePh;
        }

        // --- INIT ---
        window.onload = async () => {
            applyTranslations();
            if(!driverId) { window.location.href = 'index.html'; return; }
            
            // Location Loop
            const overlay = document.getElementById('location-overlay');
            const intv = setInterval(() => {
                if(navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(p => {
                        clearInterval(intv);
                        userLocation = [p.coords.latitude, p.coords.longitude];
                        overlay.style.opacity = '0';
                        setTimeout(() => overlay.classList.add('hidden'), 500);
                        if(map && !currentRide) { map.setView(userLocation, 15); addUserMarker(userLocation); }
                    }, null, { enableHighAccuracy: true });
                }
            }, 500);

            // Fetch Data
            const dSnap = await window.fbGet(window.fbChild(window.fbRef(window.fbDb), 'drivers/' + driverId));
            if(!dSnap.exists()) { window.location.href = 'index.html'; return; }
            driverData = dSnap.val();

            if (driverData.hold) { 
                document.getElementById('loader').classList.add('hidden'); 
                document.getElementById('section-hold').classList.remove('hidden'); 
                return; 
            }

            if(checkPayment(driverData)) return;

            if(!driverData.vehicleId) {
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('section-vehicle-reg').classList.remove('hidden');
                return;
            }

            // Dashboard Ready
            const vSnap = await window.fbGet(window.fbChild(window.fbRef(window.fbDb), `vehicles/${driverData.vehicleType}/${driverData.vehicleId}`));
            if(vSnap.exists()) {
                const v = vSnap.val();
                vehicleData = { type: driverData.vehicleType, id: driverData.vehicleId, plate: v.numberplate };
                
                // Safe DOM updates
                if(document.getElementById('dash-name')) document.getElementById('dash-name').innerText = driverData.name;
                if(document.getElementById('dash-vplate')) document.getElementById('dash-vplate').innerText = vehicleData.plate;
                
                // Vehicle Type Fix
                if(document.getElementById('dash-vtype')) {
                    document.getElementById('dash-vtype').innerText = vehicleData.type.charAt(0).toUpperCase() + vehicleData.type.slice(1);
                }

                // Profile Pic Fix
                const picEl = document.getElementById('dash-selfie');
                if(driverData.selfie && driverData.selfie.length > 50) {
                    picEl.src = driverData.selfie;
                }

                // Vehicle Thumbnail Fix
                const vImgEl = document.getElementById('dash-vehicle-img');
                if(v.out1) {
                    vImgEl.src = v.out1;
                }

                if(document.getElementById('dash-rating')) document.getElementById('dash-rating').innerText = driverData.rating || '0.0';
                
                document.getElementById('loader').classList.add('hidden');
                const dashSection = document.getElementById('section-dashboard');
                if(dashSection) dashSection.classList.remove('hidden');
                
                initMap();
                loadDailyEarnings(); 
                listenForRequests();
            }
        };

        function checkPayment(data) {
            if(!data.nextpaydate) {
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('modal-welcome').classList.remove('hidden');
                return true; 
            }
            const nextPay = new Date(data.nextpaydate); nextPay.setHours(0,0,0,0);
            const today = new Date(); today.setHours(0,0,0,0);
            if(today >= nextPay) {
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('section-payment-block').classList.remove('hidden');
                return true;
            }
            return false;
        }

        // --- MAP ---
        function initMap() {
            map = L.map('map-container', { zoomControl: false, attributionControl: false }).setView([6.9, 79.8], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            // Detect User Interaction
            map.on('dragstart', () => { isTracking = false; document.getElementById('recenter-btn').style.display = 'flex'; });
            map.on('zoomend', () => { isTracking = false; document.getElementById('recenter-btn').style.display = 'flex'; });

            const ArrowIcon = L.divIcon({ className: 'dm-arrow-box', html: '<div class="dm-circle"><span class="material-icons dm-icon" id="dm-arrow">navigation</span></div>', iconSize: [40, 40], iconAnchor: [20, 20] });
            driverMarker = L.marker([0,0], {icon: ArrowIcon}).addTo(map);

            if(navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(updateLocation, null, { enableHighAccuracy: true });
            }
        }

        function updateLocation(pos) {
            const lat = pos.coords.latitude; const lng = pos.coords.longitude;
            const heading = pos.coords.heading || 0;
            const latlng = new L.LatLng(lat, lng);
            
            // Smooth movement
            driverMarker.setLatLng(latlng);
            
            // Smooth Rotation
            const arrow = document.getElementById('dm-arrow');
            if(arrow) arrow.style.transform = `rotate(${heading}deg)`;

            // Auto-Center Logic
            if(isTracking && map) {
                map.panTo(latlng);
            }

            if(isOnline) {
                window.fbUpdate(window.fbChild(window.fbRef(window.fbDb), `vehicles/${vehicleData.type}/${vehicleData.id}/location`), { latitude: lat, longitude: lng, heading: heading });
            }

            if(tripState === 'started' && lastLoc) {
                const dist = getDistance(lastLoc.lat, lastLoc.lng, lat, lng);
                tripDist += (dist * 1000);
            }
            lastLoc = { lat, lng };
        }

        function addUserMarker(latlng) {
            if(!map) return;
            L.circleMarker(latlng, { radius: 10, fillColor: "#D32F2F", color: "#fff", weight: 2, opacity: 1, fillOpacity: 1, className: 'pulsating-icon' }).addTo(map);
        }

        window.reCenterMap = function() {
            isTracking = true;
            document.getElementById('recenter-btn').style.display = 'none';
            if(lastLoc && map) {
                map.flyTo([lastLoc.lat, lastLoc.lng], 18, { duration: 1.5 });
            }
        }

        // --- EARNINGS LOGIC ---
        async function loadDailyEarnings() {
            const today = new Date().toISOString().split('T')[0];
            const fareRef = window.fbChild(window.fbRef(window.fbDb), `drivers/${driverId}/fares/${today}`);
            const snap = await window.fbGet(fareRef);
            if(snap.exists()) {
                const data = snap.val();
                document.getElementById('dash-amount').innerText = parseFloat(data.total).toFixed(2);
            } else {
                document.getElementById('dash-amount').innerText = "0.00";
            }
        }

        // --- ONLINE LOGIC ---
        const sThumb = document.getElementById('online-thumb');
        let sDrag = false;
        const startDrag = () => sDrag = true;
        const moveDrag = (x) => {
            if(!sDrag) return;
            const limit = document.getElementById('slider-container').offsetWidth - 50;
            const px = Math.min(Math.max(0, x - 20), limit);
            sThumb.style.left = px + 'px';
        };
        const endDrag = () => {
            if(!sDrag) return; sDrag = false;
            const limit = document.getElementById('slider-container').offsetWidth - 50;
            if(parseInt(sThumb.style.left) > limit * 0.9) {
                document.getElementById('modal-price').style.display = 'flex';
            }
            sThumb.style.left = '3px';
        };
        
        sThumb.ontouchstart = startDrag; sThumb.onmousedown = startDrag;
        document.ontouchmove = e => moveDrag(e.touches[0].clientX); document.onmousemove = e => moveDrag(e.clientX);
        document.ontouchend = endDrag; document.onmouseup = endDrag;

        window.updatePriceCalc = function() {
            const val = parseFloat(document.getElementById('input-price').value) || 0;
            pricePer100m = val;
            document.getElementById('calc-display').innerText = `Price per KM is ${val * 10}`;
        }

        window.confirmOnline = async function() {
            if(pricePer100m <= 0) { showToast("Enter valid price"); return; }
            document.getElementById('modal-price').style.display = 'none';
            
            isOnline = true;
            document.getElementById('slider-container').classList.add('hidden');
            document.getElementById('online-view').style.display = 'flex';
            
            const vRef = window.fbChild(window.fbRef(window.fbDb), `vehicles/${vehicleData.type}/${vehicleData.id}`);
            await window.fbUpdate(vRef, { onlinestatus: true, available: true, currentride: null });
            
            window.fbOnDisconnect(window.fbChild(vRef, 'onlinestatus')).set(false);
        }

        window.goOffline = async function() {
            isOnline = false;
            document.getElementById('slider-container').classList.remove('hidden');
            document.getElementById('online-view').style.display = 'none';
            await window.fbUpdate(window.fbChild(window.fbRef(window.fbDb), `vehicles/${vehicleData.type}/${vehicleData.id}`), { onlinestatus: false });
        }

        // --- RIDE REQUEST LOGIC ---
        function listenForRequests() {
            const rideRef = window.fbChild(window.fbRef(window.fbDb), `vehicles/${vehicleData.type}/${vehicleData.id}/currentride`);
            window.fbOnValue(rideRef, async (snap) => {
                const rideId = snap.val();
                if(rideId && isOnline && tripState === 'idle') {
                    window.fbUpdate(window.fbChild(window.fbRef(window.fbDb), `vehicles/${vehicleData.type}/${vehicleData.id}`), { available: false });
                    
                    const rSnap = await window.fbGet(window.fbChild(window.fbRef(window.fbDb), `rides/${rideId}`));
                    if(rSnap.exists() && rSnap.val().status === 'pending') {
                        showRequestModal(rideId, rSnap.val());
                    }
                }
            });
        }

        async function showRequestModal(id, data) {
            currentRide = { id: id, data: data };
            
            // Play Sound
            soundOrder.play().catch(e => console.log("Audio play blocked", e));
            
            document.getElementById('modal-request-full').style.display = 'flex';
            document.getElementById('req-price').innerText = "Rs " + parseInt(data.price).toLocaleString();
            document.getElementById('req-dist').innerText = (data.distance/1000).toFixed(1) + " km";
            document.getElementById('req-pickup').innerText = data.pickup.address;
            document.getElementById('req-drop').innerText = data.drop.address;

            // GET PASSENGER NAME FROM RIDE DATA (Requested change)
            userName = data.passengername || "Passenger";
        }

        window.declineRide = async function() {
            document.getElementById('modal-request-full').style.display = 'none';
            await window.fbUpdate(window.fbChild(window.fbRef(window.fbDb), `rides/${currentRide.id}`), { status: 'declined' });
            await window.fbUpdate(window.fbChild(window.fbRef(window.fbDb), `vehicles/${vehicleData.type}/${vehicleData.id}`), { available: true, currentride: null });
            currentRide = null;
        }

        window.acceptRide = async function() {
            document.getElementById('modal-request-full').style.display = 'none';
            document.getElementById('dash-header').classList.add('hidden');
            document.getElementById('dash-ui').classList.add('hidden');
            
            await window.fbUpdate(window.fbChild(window.fbRef(window.fbDb), `rides/${currentRide.id}`), { status: 'accepted' });
            
            // Listen for Messages
            setupMessageListener();
            
            // NAVIGATION: PICKUP
            tripState = 'pickup';
            document.getElementById('section-navigation').style.display = 'flex';
            document.getElementById('nav-title').innerText = "Pickup Passenger";
            document.getElementById('nav-addr').innerText = currentRide.data.pickup.address.split(',')[0];
            
            drawRoute(currentRide.data.pickup);
            setupTripSlider("I'm Arrived", "#4CAF50", onArrived);
        }

        function onArrived() {
            tripState = 'arrived';
            window.fbUpdate(window.fbChild(window.fbRef(window.fbDb), `rides/${currentRide.id}`), { status: 'arrived' });
            setupTripSlider("Start Trip", "#2196F3", onStartTrip);
        }

        function onStartTrip() {
            tripState = 'started';
            tripDist = 0;
            window.fbUpdate(window.fbChild(window.fbRef(window.fbDb), `rides/${currentRide.id}`), { status: 'started' });
            
            // Show Active Ride Card
            const arc = document.getElementById('active-ride-card');
            arc.style.display = 'block';

            // Get First Name
            const firstName = userName.split(' ')[0];
            document.getElementById('arc-user-name').innerText = firstName;
            document.getElementById('arc-dest-text').innerText = currentRide.data.drop.address.split(',')[0];
            
            // Update Status Text
            document.getElementById('arc-status-text').innerText = `You're riding with ${firstName}`;

            document.getElementById('section-navigation').style.display = 'flex';
            document.getElementById('nav-title').innerText = "Heading to Destination";
            
            drawRoute(currentRide.data.drop);
            setupTripSlider("End Trip", "#D32F2F", onEndTrip);
        }

        function setupMessageListener() {
            window.fbOnValue(window.fbChild(window.fbRef(window.fbDb), `rides/${currentRide.id}/messages`), (snap) => {
                const msgs = snap.val();
                if(msgs) {
                    const keys = Object.keys(msgs);
                    const lastKey = keys[keys.length - 1];
                    const lastMsg = msgs[lastKey];

                    if(lastMsg.sender === 'user') {
                        soundMsg.play().catch(e=>{});
                        showChatPopup(lastMsg.text);
                    }
                }
            });
        }

        function onEndTrip() {
            tripState = 'ended';
            window.fbUpdate(window.fbChild(window.fbRef(window.fbDb), `rides/${currentRide.id}`), { status: 'ended' });
            
            // Hide Active Ride Card
            document.getElementById('active-ride-card').style.display = 'none';
            
            let base = 100;
            if(vehicleData.type === 'tuk') base = 150;
            if(vehicleData.type === 'car') base = 250;
            if(vehicleData.type === 'van') base = 700;
            
            let finalPrice = base;
            if(tripDist > 1000) {
                const chunks = Math.ceil((tripDist - 1000) / 100);
                finalPrice += (chunks * pricePer100m);
            }
            
            document.getElementById('section-navigation').style.display = 'none';
            document.getElementById('modal-trip-end').style.display = 'flex';
            
            document.getElementById('end-final-price').innerText = "Rs " + Math.round(finalPrice);
            document.getElementById('end-total').innerText = "Rs " + Math.round(finalPrice);
            document.getElementById('end-est').innerText = "Rs " + currentRide.data.price;
            document.getElementById('end-km').innerText = (tripDist/1000).toFixed(2);
            document.getElementById('end-dist-cost').innerText = "Rs " + Math.round(finalPrice - base);
            
            if(routeLine) map.removeLayer(routeLine);

            // Store final price for saving
            currentRide.finalPrice = finalPrice;
        }

        window.finishJob = async function() {
            document.getElementById('modal-trip-end').style.display = 'none';
            
            // 1. Save to Driver Rides History
            const rideHistoryData = {
                ...currentRide.data,
                finalPrice: currentRide.finalPrice,
                actualDistance: tripDist,
                status: 'ended',
                timestamp: Date.now(),
                userName: userName
            };
            await window.fbSet(window.fbChild(window.fbRef(window.fbDb), `drivers/${driverId}/rides/${currentRide.id}`), rideHistoryData);

            // 2. Save to Driver Daily Fares
            const today = new Date().toISOString().split('T')[0];
            const fareRef = window.fbChild(window.fbRef(window.fbDb), `drivers/${driverId}/fares/${today}`);
            const snap = await window.fbGet(fareRef);
            let totalFare = currentRide.finalPrice;
            let count = 1;

            if(snap.exists()) {
                totalFare += parseFloat(snap.val().total || 0);
                count += parseInt(snap.val().count || 0);
            }

            await window.fbUpdate(fareRef, {
                total: totalFare.toFixed(2),
                count: count
            });

            // UI Cleanup
            document.getElementById('dash-header').classList.remove('hidden');
            document.getElementById('dash-ui').classList.remove('hidden');
            
            tripState = 'idle';
            currentRide = null;
            tripDist = 0;
            userName = "Passenger";
            
            // Unlock & Reload Earnings
            await window.fbUpdate(window.fbChild(window.fbRef(window.fbDb), `vehicles/${vehicleData.type}/${vehicleData.id}`), { available: true, currentride: null });
            loadDailyEarnings();
        }

        // --- TRIP SLIDER LOGIC ---
        function setupTripSlider(text, color, callback) {
            const thumb = document.getElementById('ts-thumb');
            const txt = document.getElementById('ts-text');
            const container = document.getElementById('trip-slider');
            
            txt.innerText = text;
            thumb.style.left = '4px';
            thumb.style.backgroundColor = color;
            
            let isDragging = false;
            const start = () => isDragging = true;
            const move = (cx) => {
                if(!isDragging) return;
                const rect = container.getBoundingClientRect();
                const x = cx - rect.left - (thumb.offsetWidth/2);
                const max = container.offsetWidth - thumb.offsetWidth - 5;
                if(x > 0 && x < max) thumb.style.left = x + 'px';
            };
            const end = () => {
                isDragging = false;
                const cur = parseInt(thumb.style.left);
                const max = container.offsetWidth - thumb.offsetWidth - 5;
                if(cur > max * 0.9) { callback(); } else { thumb.style.left = '4px'; }
            };
            
            thumb.ontouchstart = start; thumb.onmousedown = start;
            document.ontouchmove = e => move(e.touches[0].clientX); document.onmousemove = e => move(e.clientX);
            document.ontouchend = end; document.onmouseup = end;
        }

        // --- ROUTING & NAVIGATION (SIMPLIFIED - SHOW STATIC INITIAL DIRECTION) ---
        function drawRoute(target) {
            if(!lastLoc) return;
            
            // Request steps=true to get instruction text, but we only use first one.
            const url = `https://router.project-osrm.org/route/v1/driving/${lastLoc.lng},${lastLoc.lat};${target.lng},${target.lat}?overview=full&geometries=geojson&steps=true`;
            
            // Show loading state
            const navAddr = document.getElementById('nav-addr');
            if(navAddr) navAddr.innerText = "Calculating directions...";
            // Reset icon
            const navIcon = document.getElementById('nav-icon');
            if(navIcon) navIcon.innerText = 'navigation';

            fetch(url).then(r=>r.json()).then(d=>{
                if(!d.routes || d.routes.length === 0) {
                    if(navAddr) navAddr.innerText = "Route error";
                    return;
                }

                // 1. Draw Geometry
                const path = d.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]);
                if(routeLine) map.removeLayer(routeLine);
                routeLine = L.polyline(path, {color:'#2196F3', weight:6}).addTo(map);
                map.fitBounds(routeLine.getBounds(), {padding:[50,50]});

                // 2. Get Initial Direction (First Step)
                // OSRM returns legs[0].steps. The first step [0] is usually immediate departure direction.
                const firstStep = d.routes[0].legs[0].steps[0];
                const instruction = firstStep ? firstStep.instruction : "Head towards destination";
                
                // Update UI with static initial direction
                if(navAddr) navAddr.innerText = instruction;
                
                // Keep generic icon or update based on first maneuver if desired. 
                // Keeping 'straight' is safe for initial departure.
                
            }).catch(e => {
                console.error(e);
                if(navAddr) navAddr.innerText = "Route error";
            });
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            var R = 6371; var dLat = (lat2-lat1) * (Math.PI/180); var dLon = (lon2-lon1) * (Math.PI/180);
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * (Math.PI/180)) * Math.cos(lat2 * (Math.PI/180)) * Math.sin(dLon/2) * Math.sin(dLon/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // --- ACCOUNT UTILS ---
        window.openBankModal = () => document.getElementById('modal-bank-details').classList.remove('hidden');
        window.closeBankModal = () => document.getElementById('modal-bank-details').classList.add('hidden');
        window.openPaidModal = () => document.getElementById('modal-paid-form').classList.remove('hidden');
        window.closePaidModal = () => document.getElementById('modal-paid-form').classList.add('hidden');
        window.handlePayUpload = (inp) => { const f = inp.files[0]; if(!f) return; const r = new FileReader(); r.readAsDataURL(f); r.onload = e => { tempReceiptBase64 = e.target.result; document.getElementById('pay-receipt-preview').src = tempReceiptBase64; document.getElementById('pay-receipt-preview').classList.remove('hidden'); } };
        window.submitPayment = async () => { if(!tempReceiptBase64) return showToast("Upload receipt"); await window.fbSet(window.fbChild(window.fbRef(window.fbDb), 'drivers/'+driverId+'/payment_details'), {receipt:tempReceiptBase64, status:'paid', date:new Date().toISOString()}); closePaidModal(); showToast("Submitted"); };
        
        // ==============================================
        // VEHICLE REGISTRATION LOGIC (From Snippet)
        // ==============================================
        window.selectType = (t,e) => { 
            window.vehicleData.type = t; 
            document.querySelectorAll('.type-card').forEach(c=>c.classList.remove('selected')); 
            e.classList.add('selected'); 
            document.getElementById('v-btn-1').classList.remove('hidden'); 
        };
        
        window.nextVStep = (n) => { 
            document.querySelectorAll('.carousel-step').forEach(c=>c.classList.remove('active')); 
            document.getElementById(`v-step-${n}`).classList.add('active'); 
        };
        
        window.handleVUpload = (i,k) => { 
            const f=i.files[0]; 
            if(f){ 
                // Image Compression Logic
                compressImage(f, 800, (base64) => {
                    window.vehicleData[k]=base64; 
                    i.parentElement.classList.add('active'); 
                    i.parentElement.querySelector('img').src = base64; 
                    i.parentElement.querySelector('img').classList.remove('hidden');
                });
            } 
        };
        
        window.validateVStep3 = () => nextVStep(4); 
        window.validateVStep4 = () => nextVStep(5);
        
        window.saveVehicleRegistration = async () => {
            window.vehicleData.model = document.getElementById('v-model').value;
            window.vehicleData.numberplate = document.getElementById('v-plate').value.toUpperCase();
            window.vehicleData.status = 'pending_approval';
            window.vehicleData.ownerId = driverId;
            window.vehicleData.ownerName = driverData.name;
            window.vehicleData.ownerSelfie = driverData.selfie;
            const vid = 'veh_'+Date.now();
            await window.fbSet(window.fbChild(window.fbRef(window.fbDb), `vehicles/${window.vehicleData.type}/${vid}`), window.vehicleData);
            await window.fbUpdate(window.fbChild(window.fbRef(window.fbDb), `drivers/${driverId}`), {vehicleId:vid, vehicleType:window.vehicleData.type});
            location.reload();
        };

        // Image Compress Utility (From Snippet)
        function compressImage(file, maxWidth, callback) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width;
                    let h = img.height;
                    if (w > maxWidth) {
                        h = (maxWidth / w) * h;
                        w = maxWidth;
                    }
                    canvas.width = w;
                    canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    callback(canvas.toDataURL('image/jpeg', 0.6));
                }
            }
        }

        // Agreement Slider Logic (From Snippet)
        const vSlider = document.getElementById('v-agree-slider'); 
        const vThumb = document.getElementById('v-agree-thumb'); 
        let vDragging = false, vStartX = 0;
        
        vThumb.addEventListener('mousedown', startVDrag); vThumb.addEventListener('touchstart', startVDrag);
        function startVDrag(e) { 
            vDragging = true; 
            vStartX = (e.pageX || e.touches[0].pageX) - vThumb.offsetLeft; 
            document.addEventListener('mousemove', moveVDrag); 
            document.addEventListener('touchmove', moveVDrag); 
            document.addEventListener('mouseup', endVDrag); 
            document.addEventListener('touchend', endVDrag); 
        }
        function moveVDrag(e) { 
            if(!vDragging) return; 
            const x = (e.pageX || e.touches[0].pageX) - vStartX; 
            const max = vSlider.offsetWidth - vThumb.offsetWidth - 6; 
            if(x >= 0 && x <= max) { 
                vThumb.style.transform = `translateX(${x}px)`; 
            } 
        }
        function endVDrag(e) { 
            if(!vDragging) return; 
            vDragging = false; 
            const x = (e.pageX || (e.changedTouches ? e.changedTouches[0].pageX : 0)) - vStartX; 
            const max = vSlider.offsetWidth - vThumb.offsetWidth - 6; 
            if(x >= max * 0.9) { 
                vThumb.classList.add('unlocked'); 
                saveVehicleRegistration(); 
            } else { 
                vThumb.style.transform = `translateX(0px)`; 
            } 
            document.removeEventListener('mousemove', moveVDrag); 
            document.removeEventListener('touchmove', moveVDrag); 
            document.removeEventListener('mouseup', endVDrag); 
            document.removeEventListener('touchend', endVDrag); 
        }

        // Promo & Finalize Logic
        window.toggleLanguage = () => { currentLang = currentLang==='en'?'si':currentLang==='si'?'ta':'en'; localStorage.setItem('language', currentLang); location.reload(); };
        window.checkPromo = () => { 
            if(document.getElementById('promo-code').value.toUpperCase()==='FIRSTPAY20'){
                isPromoValid=true; 
                document.getElementById('t-promo-msg').classList.remove('hidden'); 
                showToast("Applied!"); 
            } 
        };
        window.finalizeWelcome = async () => {
            const nextPay = new Date(Date.now() + (isPromoValid?14:7)*24*60*60*1000).toISOString();
            await window.fbUpdate(window.fbChild(window.fbRef(window.fbDb), 'drivers/'+driverId), {nextpaydate:nextPay});
            location.reload();
        };

    </script>
</body>
</html>
