<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speedo Rider</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        :root { --primary: #D32F2F; --white: #ffffff; --text: #333; --online: #00C853; --offline: #D32F2F; }
        * { box-sizing: border-box; tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; padding: 0; font-family: 'Poppins', sans-serif; overflow: hidden; background: #eee; height: 100vh; width: 100vw; }

        /* --- MAP LAYER --- */
        #map { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        
        /* Marker Pulse */
        .gps-marker { background: rgba(33, 150, 243, 0.3); border-radius: 50%; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; animation: pulse 2s infinite; }
        .gps-dot { width: 16px; height: 16px; background: #2196F3; border: 3px solid white; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        @keyframes pulse { 0% { transform: scale(0.8); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }

        /* --- UI LAYER (Z-Index > 0) --- */
        
        /* TOP CARD */
        .top-card {
            position: fixed; top: 15px; left: 15px; right: 15px;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(5px);
            border-radius: 15px; padding: 10px 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 100;
        }
        .profile-sec { display: flex; align-items: center; gap: 10px; }
        .p-img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        .p-name { font-weight: 700; font-size: 14px; color: var(--text); line-height: 1.2; }
        .lang-btn { background: #f0f0f0; border: none; padding: 5px 12px; border-radius: 20px; font-weight: 600; font-size: 12px; color: #555; cursor: pointer; position: absolute; left: 50%; transform: translateX(-50%); }
        .status-pill { padding: 5px 12px; border-radius: 20px; color: white; font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
        .st-online { background: var(--online); }
        .st-offline { background: var(--offline); }

        /* BOTTOM CARD */
        .bottom-card {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--white); border-radius: 25px 25px 0 0;
            padding: 25px 20px 15px 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            z-index: 100; transition: transform 0.3s ease;
            display: flex; flex-direction: column; align-items: center;
        }
        
        .card-title { font-size: 16px; font-weight: 700; color: #444; margin-bottom: 15px; width: 100%; text-align: left; }
        .card-desc { font-size: 12px; color: #777; margin: 10px 0; text-align: center; }

        /* Buttons */
        .go-online-btn {
            background: var(--primary); color: white; width: 100%; padding: 15px;
            border: none; border-radius: 50px; font-size: 18px; font-weight: 700;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 5px 15px rgba(211, 47, 47, 0.4); cursor: pointer;
            transition: transform 0.1s;
        }
        .go-online-btn:active { transform: scale(0.98); }
        .dot { width: 10px; height: 10px; background: white; border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        .vehicles-strip {
            width: 100%; background: #f5f5f5; padding: 12px; border-radius: 12px;
            margin-top: 15px; text-align: center; font-weight: 600; color: #333;
            font-size: 14px; cursor: pointer; border: 1px solid #ddd;
        }

        .time-date { font-size: 11px; color: #999; margin-top: 15px; font-weight: 500; }

        /* Online State UI */
        .online-ui { display: none; width: 100%; flex-direction: column; }
        .finding-hires { text-align: center; margin-bottom: 10px; }
        .finding-hires h3 { color: var(--primary); margin: 0; animation: fadeText 1.5s infinite; }
        @keyframes fadeText { 50% { opacity: 0.5; } }
        
        .options-row { display: flex; justify-content: space-between; width: 100%; margin-top: 10px; }
        .chk-container { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 600; background: #f9f9f9; padding: 8px 12px; border-radius: 10px; width: 48%; }
        input[type="checkbox"] { accent-color: var(--primary); width: 18px; height: 18px; }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 2000; display: none;
            justify-content: center; align-items: flex-end; backdrop-filter: blur(3px);
        }
        .full-screen-modal {
            align-items: center; justify-content: center; background: #fff;
        }
        .modal-card {
            background: white; width: 100%; max-width: 500px;
            border-radius: 20px 20px 0 0; padding: 20px;
            max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column;
        }
        .fs-content { text-align: center; padding: 30px; }
        .fs-icon { font-size: 50px; color: var(--primary); margin-bottom: 20px; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* Skeleton Loader */
        #skeleton { position: fixed; inset: 0; background: #fff; z-index: 3000; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .sk-header { height: 80px; background: #eee; border-radius: 15px; animation: pulse-bg 1s infinite alternate; }
        .sk-map { flex: 1; background: #eee; border-radius: 15px; animation: pulse-bg 1s infinite alternate; }
        .sk-bottom { height: 200px; background: #eee; border-radius: 25px 25px 0 0; animation: pulse-bg 1s infinite alternate; }
        @keyframes pulse-bg { from { opacity: 0.6; } to { opacity: 1; } }

        /* Toast & Confetti */
        #toast-container { position: fixed; top: 100px; left: 50%; transform: translateX(-50%); z-index: 5000; width: 90%; pointer-events: none; }
        .toast { background: #333; color: white; padding: 10px 20px; border-radius: 30px; text-align: center; margin-bottom: 10px; opacity: 0; transition: 0.3s; font-size: 13px; }
        .toast.show { opacity: 1; transform: translateY(10px); }
        
        #confetti-overlay { position: fixed; inset: 0; pointer-events: none; z-index: 4000; display: none; justify-content: center; align-items: center; font-size: 50px; }

        /* Vehicle List Styles (Mini) */
        .v-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid #eee; border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
        .v-item:active { background: #f0f0f0; }
        .v-item.selected { border: 2px solid var(--primary); background: #fff0f0; }
        .del-btn { background: #ffebee; color: red; border: none; padding: 5px 10px; border-radius: 5px; font-size: 10px; margin-top: 5px; cursor: pointer; }
    </style>
</head>
<body>

<!-- Skeleton Loader -->
<div id="skeleton">
    <div class="sk-header"></div>
    <div class="sk-map"></div>
    <div class="sk-bottom"></div>
</div>

<!-- Location Error Modal -->
<div id="location-error-modal" class="modal-overlay full-screen-modal" style="display:none; z-index:9000; background:white;">
    <div class="fs-content">
        <div class="fs-icon"><i class="fas fa-map-marker-alt"></i></div>
        <h2 style="color:var(--primary)" data-i18n="loc_err_title">Location Required</h2>
        <p data-i18n="loc_err_msg">Please turn on your Location (GPS) and Mobile Data to continue.</p>
        <p style="font-size:12px; color:#777; margin-top:20px;">Searching...</p>
    </div>
</div>

<!-- Map -->
<div id="map"></div>

<!-- Top Card -->
<div class="top-card" id="top-ui" style="display:none;">
    <div class="profile-sec" onclick="showProfileModal()">
        <img src="" id="user-pic" class="p-img">
        <div class="p-name"><span id="user-name">Rider</span></div>
    </div>
    <button class="lang-btn" onclick="toggleLang()" id="lang-btn">EN</button>
    <div class="status-pill st-offline" id="status-pill" data-i18n="offline">OFFLINE</div>
</div>

<!-- Bottom Card -->
<div class="bottom-card" id="bottom-ui" style="display:none;">
    
    <!-- OFFLINE VIEW -->
    <div id="view-offline" style="width:100%;">
        <div class="card-title" data-i18n="driver_status">Driver Status</div>
        
        <button class="go-online-btn" onclick="initiateGoOnline()">
            <div class="dot"></div> <span data-i18n="go_online">GO ONLINE</span>
        </button>
        
        <p class="card-desc" data-i18n="go_online_desc">Go online to receive hires</p>
        
        <div class="vehicles-strip" onclick="openVehicleManager()">
            <i class="fas fa-car"></i> <span data-i18n="manage_vehicles">Vehicles</span>
        </div>
    </div>

    <!-- ONLINE VIEW -->
    <div id="view-online" class="online-ui">
        <div class="finding-hires">
            <h3 data-i18n="finding_hires">Finding Hires...</h3>
            <p class="card-desc" data-i18n="keep_data_on">Please keep location & data on</p>
        </div>
        
        <button class="go-online-btn" style="background:#333; padding:10px; font-size:14px;" onclick="goOffline()">
            <span data-i18n="go_offline">GO OFFLINE</span>
        </button>

        <div class="options-row">
            <label class="chk-container">
                <input type="checkbox" id="chk-close" onchange="updatePref()"> <span data-i18n="close_rides">Closer Rides</span>
            </label>
            <label class="chk-container">
                <input type="checkbox" id="chk-long" onchange="updatePref()"> <span data-i18n="long_trips">Long Trips Only</span>
            </label>
        </div>
    </div>

    <div class="time-date" id="time-date">Loading...</div>
</div>

<!-- Vehicle Select Modal -->
<div id="vehicle-select-modal" class="modal-overlay">
    <div class="modal-card">
        <h3 style="text-align:center; margin-top:0;" data-i18n="select_veh">Select a Vehicle</h3>
        <div id="online-veh-list" style="max-height:300px; overflow-y:auto;"></div>
        <button class="go-online-btn" style="margin-top:20px;" onclick="confirmVehicle()">
            <span data-i18n="continue">Continue</span>
        </button>
        <button class="vehicles-strip" onclick="closeModal('vehicle-select-modal')" data-i18n="cancel">Cancel</button>
    </div>
</div>

<!-- Vehicle Manager Modal (Simplified for adding/deleting) -->
<div id="vehicle-man-modal" class="modal-overlay">
    <div class="modal-card" style="height:80vh;">
        <h3 style="text-align:center; margin-top:0;" data-i18n="my_vehicles">My Vehicles</h3>
        <div id="man-veh-list" style="flex:1; overflow-y:auto;"></div>
        
        <!-- Add Vehicle Form (Collapsible or Link to detailed add) -->
        <p style="text-align:center; color:gray; font-size:12px;">To add a new vehicle, please use the registration portal from the previous screen for full validation.</p>
        
        <button class="go-online-btn" style="margin-top:10px; background:#444;" onclick="location.href='main.html'">
            + <span data-i18n="add_vehicle">Add Vehicle</span>
        </button>
        <button class="vehicles-strip" onclick="closeModal('vehicle-man-modal')" data-i18n="close">Close</button>
    </div>
</div>

<!-- First Time Tutorial -->
<div id="tutorial-modal" class="modal-overlay">
    <div class="modal-card">
        <h2 style="text-align:center; color:var(--primary);">How it Works</h2>
        <p>1. Go Online to become visible.</p>
        <p>2. Wait for ride requests.</p>
        <p>3. Accept rides quickly.</p>
        <p>4. Earn money!</p>
        <button class="go-online-btn" onclick="finishTutorial()">Got it!</button>
    </div>
</div>

<!-- Profile Modal -->
<div id="profile-modal" class="modal-overlay">
    <div class="modal-card">
        <h3 style="text-align:center;">Rider Profile</h3>
        <div style="text-align:center;">
            <img src="" id="modal-p-img" style="width:100px; height:100px; border-radius:50%; border:3px solid var(--primary);">
            <h2 id="modal-p-name"></h2>
            <p id="modal-p-phone"></p>
            <p id="modal-p-dist"></p>
        </div>
        <button class="vehicles-strip" onclick="closeModal('profile-modal')">Close</button>
    </div>
</div>

<div id="confetti-overlay">üéâ üéä üõ∫ üöó üèçÔ∏è</div>
<div id="toast-container"></div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, get, update, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    // Firebase Init
    const db = getDatabase(initializeApp({
        apiKey: "AIzaSyC3Rf4x5a_L1cYVa6soADfYktQK5WyMN-4",
        authDomain: "speedo-acb7c.firebaseapp.com",
        databaseURL: "https://speedo-acb7c-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "speedo-acb7c"
    }));

    // --- STATE ---
    let currentUser = null;
    let map = null;
    let marker = null;
    let watchId = null;
    let isOnline = false;
    let currentVehicles = [];
    let selectedVehId = null;
    let dbUpdateInterval = null;
    let lastLocTime = 0;
    let lang = localStorage.getItem('speedo_lang') || 'en';

    // --- LANG DATA ---
    const i18n = {
        en: { 
            offline: "OFFLINE", online: "ONLINE", driver_status: "Driver Status", 
            go_online: "GO ONLINE", go_online_desc: "Go online to receive hires", 
            manage_vehicles: "Vehicles", finding_hires: "Finding Hires...", 
            keep_data_on: "Keep location & data turned on", go_offline: "GO OFFLINE",
            close_rides: "Closer Rides", long_trips: "Long Trips Only",
            select_veh: "Select Vehicle", continue: "Continue", cancel: "Cancel",
            my_vehicles: "My Vehicles", add_vehicle: "Add Vehicle", close: "Close",
            loc_err_title: "Location Required", loc_err_msg: "Please turn on GPS & Mobile Data."
        },
        si: {
            offline: "‡∂Ö‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∂∫‡∑í", online: "‡∑É‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∂∫‡∑í", driver_status: "‡∂ª‡∑í‡∂∫‡∂Ø‡∑î‡∂ª‡∑î ‡∂≠‡∂≠‡∑ä‡∂≠‡∑ä‡∑Ä‡∂∫",
            go_online: "‡∑É‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫ ‡∑Ä‡∂±‡∑ä‡∂±", go_online_desc: "‡∂ö‡∑î‡∂Ω‡∑ì ‡∂ú‡∂∏‡∂±‡∑ä ‡∂Ω‡∂∂‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß",
            manage_vehicles: "‡∑Ä‡∑è‡∑Ñ‡∂±", finding_hires: "‡∑É‡∑ú‡∂∫‡∂∏‡∑í‡∂±‡∑ä ‡∂¥‡∑Ä‡∂≠‡∑ì...",
            keep_data_on: "‡∑É‡∑ä‡∂Æ‡∑è‡∂±‡∂∫ ‡∑É‡∑Ñ ‡∂Ö‡∂±‡∑ä‡∂≠‡∂ª‡∑ä‡∂¢‡∑è‡∂Ω‡∂∫ ‡∂≠‡∂∂‡∑è ‡∂ú‡∂±‡∑ä‡∂±", go_offline: "‡∂Ö‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫ ‡∑Ä‡∂±‡∑ä‡∂±",
            close_rides: "‡∑Ö‡∂ü ‡∂ú‡∂∏‡∂±‡∑ä", long_trips: "‡∂Ø‡∑î‡∂ª ‡∂ú‡∂∏‡∂±‡∑ä ‡∂¥‡∂∏‡∂´‡∑í",
            select_veh: "‡∑Ä‡∑è‡∑Ñ‡∂±‡∂∫‡∂ö‡∑ä ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±", continue: "‡∂â‡∂Ø‡∑í‡∂ª‡∑í‡∂∫‡∂ß", cancel: "‡∂Ö‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±",
            my_vehicles: "‡∂∏‡∂ú‡∑ö ‡∑Ä‡∑è‡∑Ñ‡∂±", add_vehicle: "‡∂ë‡∂ö‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±", close: "‡∑Ä‡∑É‡∂±‡∑ä‡∂±",
            loc_err_title: "‡∑É‡∑ä‡∂Æ‡∑è‡∂±‡∂∫ ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫‡∂∫‡∑í", loc_err_msg: "‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª GPS ‡∑É‡∑Ñ Data ‡∑É‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±."
        },
        ta: {
            offline: "‡ÆÜ‡ÆÉ‡Æ™‡Øç‡Æ≤‡Øà‡Æ©‡Øç", online: "‡ÆÜ‡Æ©‡Øç‡Æ≤‡Øà‡Æ©‡Øç", driver_status: "‡Æì‡Æü‡Øç‡Æü‡ØÅ‡Æ®‡Æ∞‡Øç ‡Æ®‡Æø‡Æ≤‡Øà",
            go_online: "‡ÆÜ‡Æ©‡Øç‡Æ≤‡Øà‡Æ©‡Æø‡Æ≤‡Øç ‡Æö‡ØÜ‡Æ≤‡Øç‡Æ≤", go_online_desc: "‡Æö‡Æµ‡Ææ‡Æ∞‡Æø‡Æï‡Æ≥‡Øà‡Æ™‡Øç ‡Æ™‡ØÜ‡Æ±",
            manage_vehicles: "‡Æµ‡Ææ‡Æï‡Æ©‡Æô‡Øç‡Æï‡Æ≥‡Øç", finding_hires: "‡Æ§‡Øá‡Æü‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...",
            keep_data_on: "‡Æá‡Æü‡ÆÆ‡Øç & ‡Æü‡Øá‡Æü‡Øç‡Æü‡Ææ‡Æµ‡Øà ‡ÆÜ‡Æ©‡Øç ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç", go_offline: "‡ÆÜ‡ÆÉ‡Æ™‡Øç‡Æ≤‡Øà‡Æ©‡Øç ‡Æö‡ØÜ‡Æ≤‡Øç‡Æ≤",
            close_rides: "‡Æ®‡ØÜ‡Æ∞‡ØÅ‡Æô‡Øç‡Æï‡Æø‡ÆØ ‡Æö‡Æµ‡Ææ‡Æ∞‡Æø", long_trips: "‡Æ®‡ØÄ‡Æ£‡Øç‡Æü ‡Æ™‡ÆØ‡Æ£‡ÆÆ‡Øç ‡ÆÆ‡Æü‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç",
            select_veh: "‡Æµ‡Ææ‡Æï‡Æ©‡Æ§‡Øç‡Æ§‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ‡Æö‡ØÜ‡ÆØ‡Øç‡Æï", continue: "‡Æ§‡Øä‡Æü‡Æ∞‡Æµ‡ØÅ‡ÆÆ‡Øç", cancel: "‡Æ∞‡Æ§‡Øç‡Æ§‡ØÅ",
            my_vehicles: "‡Æé‡Æ©‡Øç ‡Æµ‡Ææ‡Æï‡Æ©‡Æô‡Øç‡Æï‡Æ≥‡Øç", add_vehicle: "‡Æö‡Øá‡Æ∞‡Øç", close: "‡ÆÆ‡ØÇ‡Æü‡ØÅ",
            loc_err_title: "‡Æá‡Æü‡ÆÆ‡Øç ‡Æ§‡Øá‡Æµ‡Øà", loc_err_msg: "GPS & Data ‡Æê ‡ÆÜ‡Æ©‡Øç ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç."
        }
    };

    // --- INITIALIZATION ---
    window.onload = async () => {
        applyLang();
        updateClock();
        setInterval(updateClock, 60000);

        const uid = localStorage.getItem('uid');
        const dist = localStorage.getItem('dist');
        if(!uid || !dist) return window.location.href = "rider.html";

        // 1. Get User Data
        try {
            const s = await get(ref(db, `riders/${dist}/${uid}`));
            if(s.exists()) {
                const d = s.val().riderdata;
                currentUser = { ...d, uid, dist };
                document.getElementById('user-name').innerText = d.fullName.split(" ")[0];
                if(d.selfie) {
                    document.getElementById('user-pic').src = d.selfie;
                    document.getElementById('modal-p-img').src = d.selfie;
                }
                document.getElementById('modal-p-name').innerText = d.fullName;
                document.getElementById('modal-p-phone').innerText = d.phone;
                document.getElementById('modal-p-dist').innerText = dist;

                // Load Vehicles
                loadVehicles();

                // 2. Hide Skeleton & Show UI
                setTimeout(() => {
                    document.getElementById('skeleton').style.display = 'none';
                    document.getElementById('top-ui').style.display = 'flex';
                    document.getElementById('bottom-ui').style.display = 'flex';
                    initMap();
                }, 1000);

            } else {
                localStorage.clear(); window.location.href = "rider.html";
            }
        } catch(e) { console.error(e); }
    };

    // --- MAP & LOCATION ---
    function initMap() {
        // Init Map
        map = L.map('map', { zoomControl: false, attributionControl: false }).setView([7.8731, 80.7718], 8); // Center SL
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

        // Start Tracking
        if ("geolocation" in navigator) {
            // First time search (10s limit visually handled by user perception, technically indefinite until found)
            startLocationWatch();
        } else {
            showLocError();
        }
    }

    function startLocationWatch() {
        watchId = navigator.geolocation.watchPosition(
            (pos) => {
                const { latitude, longitude } = pos.coords;
                lastLocTime = Date.now();
                document.getElementById('location-error-modal').style.display = 'none';

                // Update Map
                if (!marker) {
                    const icon = L.divIcon({ className: 'gps-marker', html: '<div class="gps-dot"></div>', iconSize: [40, 40] });
                    marker = L.marker([latitude, longitude], { icon: icon }).addTo(map);
                    map.setView([latitude, longitude], 16);
                } else {
                    marker.setLatLng([latitude, longitude]);
                    if(isOnline) map.setView([latitude, longitude]); // Auto follow if online
                }

                // If Online, Update DB (Throttled for performance, user asked 10ms but we update local state instantly and DB responsibly)
                if (isOnline && selectedVehId) {
                   updateDBLocation(latitude, longitude);
                }
            },
            (err) => {
                console.warn("Loc Error", err);
                showLocError();
                if (isOnline) goOffline(); // Force offline if loc lost
            },
            { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
        );
    }

    function showLocError() {
        document.getElementById('location-error-modal').style.display = 'flex';
    }

    // --- ONLINE / OFFLINE LOGIC ---
    window.initiateGoOnline = () => {
        // Filter approved vehicles
        const approved = currentVehicles.filter(v => v.approved_status === true);
        
        if (approved.length === 0) {
            toast("No approved vehicles found.", "error");
            return;
        }

        // Show Select Modal
        const list = document.getElementById('online-veh-list');
        list.innerHTML = "";
        approved.forEach(v => {
            const div = document.createElement('div');
            div.className = 'v-item';
            div.innerHTML = `<b>${v.brand} ${v.model}</b> <span style="background:#eee; padding:2px 5px; border-radius:4px; font-size:10px;">${v.plate}</span>`;
            div.onclick = () => {
                document.querySelectorAll('.v-item').forEach(x => x.classList.remove('selected'));
                div.classList.add('selected');
                selectedVehId = v.id;
            };
            list.appendChild(div);
        });
        
        // Auto select first
        if(approved.length > 0) {
             selectedVehId = approved[0].id;
             list.firstChild.classList.add('selected');
        }

        openModal('vehicle-select-modal');
    }

    window.confirmVehicle = () => {
        closeModal('vehicle-select-modal');
        
        // Check First Time
        if (!localStorage.getItem('speedo_tutorial_done')) {
            openModal('tutorial-modal');
        } else {
            goOnline();
        }
    }

    window.finishTutorial = () => {
        localStorage.setItem('speedo_tutorial_done', 'true');
        closeModal('tutorial-modal');
        goOnline();
    }

    function goOnline() {
        if (!selectedVehId) return;

        // Show Confetti
        const c = document.getElementById('confetti-overlay');
        c.style.display = 'flex';
        setTimeout(() => c.style.display = 'none', 2000);
        
        toast("Good Luck Rider!", "success");

        isOnline = true;
        
        // Update UI
        document.getElementById('view-offline').style.display = 'none';
        document.getElementById('view-online').style.display = 'flex';
        document.getElementById('status-pill').className = 'status-pill st-online';
        document.getElementById('status-pill').innerText = i18n[lang].online;

        // DB Update
        const updates = {};
        const basePath = `riders/${currentUser.dist}/${currentUser.uid}`;
        updates[`${basePath}/rider_status`] = "online";
        updates[`${basePath}/active_vehicle`] = selectedVehId;
        updates[`${basePath}/pref_closer`] = false;
        updates[`${basePath}/pref_long`] = false;
        
        update(ref(db), updates);
        
        // Setup Disconnect Hook
        onDisconnect(ref(db, `${basePath}/rider_status`)).set("offline");

        // Start Connectivity Check
        dbUpdateInterval = setInterval(checkConnectivity, 2000);
    }

    window.goOffline = () => {
        isOnline = false;
        selectedVehId = null;

        // Update UI
        document.getElementById('view-online').style.display = 'none';
        document.getElementById('view-offline').style.display = 'block';
        document.getElementById('status-pill').className = 'status-pill st-offline';
        document.getElementById('status-pill').innerText = i18n[lang].offline;

        // DB Update
        const basePath = `riders/${currentUser.dist}/${currentUser.uid}`;
        update(ref(db, basePath), { rider_status: "offline", active_vehicle: null });
        
        if (dbUpdateInterval) clearInterval(dbUpdateInterval);
    }

    // --- UPDATES ---
    function updateDBLocation(lat, lng) {
        // Throttled update (user requested 10ms, code sets interval to logic check, updates db when needed)
        // Here we just write.
        update(ref(db, `riders/${currentUser.dist}/${currentUser.uid}/location`), {
            lat: lat,
            lng: lng,
            timestamp: Date.now()
        });
    }

    window.updatePref = () => {
        if(!isOnline) return;
        const c = document.getElementById('chk-close').checked;
        const l = document.getElementById('chk-long').checked;
        update(ref(db, `riders/${currentUser.dist}/${currentUser.uid}`), {
            pref_closer: c,
            pref_long: l
        });
    }

    function checkConnectivity() {
        // Check if data is old (Loc lost)
        if (Date.now() - lastLocTime > 3000) {
            goOffline();
            toast("Location Signal Lost", "error");
        }
        if (!navigator.onLine) {
            goOffline();
            toast("Internet Lost", "error");
        }
    }

    // --- VEHICLE MANAGEMENT (Embedded) ---
    async function loadVehicles() {
        currentVehicles = [];
        const types = ["Bike", "Tuk Tuk", "Car", "Van"];
        try {
            for(let t of types) {
                const s = await get(ref(db, `vehicles/${t}`));
                if(s.exists()) {
                    s.forEach(v => {
                        if(v.val().ownerUid === currentUser.uid) {
                            currentVehicles.push({...v.val(), id: v.key, type: t});
                        }
                    });
                }
            }
        } catch(e){}
    }

    window.openVehicleManager = () => {
        const list = document.getElementById('man-veh-list');
        list.innerHTML = "";
        
        if(currentVehicles.length === 0) list.innerHTML = "<p style='text-align:center'>No vehicles.</p>";

        currentVehicles.forEach(v => {
            let st = v.approved_status === true ? "Approved" : (v.approved_status==="declined"?"Declined":"Pending");
            let col = v.approved_status === true ? "green" : (v.approved_status==="declined"?"red":"orange");
            
            const div = document.createElement('div');
            div.className = 'v-item';
            div.style.display = 'block';
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <b>${v.brand} ${v.model}</b>
                    <span style="color:${col}; font-size:12px; font-weight:bold;">${st}</span>
                </div>
                <div style="font-size:12px; color:gray;">${v.plate}</div>
                <button class="del-btn" onclick="delVehicle('${v.type}', '${v.id}')">Delete</button>
            `;
            list.appendChild(div);
        });
        openModal('vehicle-man-modal');
    }

    window.delVehicle = async (type, id) => {
        if(!confirm("Delete this vehicle?")) return;
        await remove(ref(db, `vehicles/${type}/${id}`));
        await loadVehicles();
        openVehicleManager(); // refresh list
    }

    // --- UI UTILS ---
    function updateClock() {
        const d = new Date();
        const str = d.toLocaleDateString() + " | " + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        document.getElementById('time-date').innerText = str;
    }

    window.applyLang = () => {
        document.getElementById('lang-btn').innerText = lang.toUpperCase();
        document.querySelectorAll('[data-i18n]').forEach(e => {
            const k = e.getAttribute('data-i18n');
            if (i18n[lang][k]) e.innerText = i18n[lang][k];
        });
    }

    window.toggleLang = () => {
        if(lang === 'en') lang = 'si';
        else if(lang === 'si') lang = 'ta';
        else lang = 'en';
        localStorage.setItem('speedo_lang', lang);
        applyLang();
    }

    const toast = (m, t='norm') => {
        const c = document.getElementById('toast-container');
        const d = document.createElement('div');
        d.className = `toast ${t==='error'?'error':'success'}`;
        d.innerText = m;
        c.appendChild(d);
        setTimeout(()=>d.classList.add('show'),10);
        setTimeout(()=>{d.classList.remove('show'); setTimeout(()=>d.remove(),300)}, 2500);
    }

    // Modal Helpers
    window.openModal = (id) => document.getElementById(id).style.display = 'flex';
    window.closeModal = (id) => document.getElementById(id).style.display = 'none';
    
    window.showProfileModal = () => openModal('profile-modal');
    window.logout = () => { localStorage.clear(); location.href = "rider.html"; }

    // Expose functions
    window.updatePref = window.updatePref;
</script>
</body>
</html>
