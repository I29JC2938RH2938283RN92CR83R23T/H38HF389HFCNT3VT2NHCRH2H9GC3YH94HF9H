<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speedo Rider</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet & Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <style>
        :root { --primary: #D32F2F; --white: #ffffff; --text: #333; --online: #00C853; --offline: #D32F2F; --bg: #f4f4f4; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
        body { margin: 0; padding: 0; font-family: 'Poppins', sans-serif; overflow: hidden; background: #eee; height: 100vh; width: 100vw; }

        /* MAP */
        #map { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        /* Hide Leaflet Routing Container */
        .leaflet-routing-container { display: none; }

        /* MARKERS */
        .gps-marker-container { width: 50px; height: 50px; display: flex; justify-content: center; align-items: center; position: relative; }
        .gps-dot { width: 16px; height: 16px; background: #2196F3; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 2; position: relative; }
        .gps-pulse { position: absolute; width: 50px; height: 50px; background: rgba(33, 150, 243, 0.4); border-radius: 50%; z-index: 1; animation: pulse-ring 2s infinite; }
        @keyframes pulse-ring { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }

        /* TOP CARD */
        .top-card { position: fixed; top: 15px; left: 15px; right: 15px; background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); border-radius: 15px; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 100; }
        .profile-sec { display: flex; align-items: center; gap: 10px; }
        .p-img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        .p-name { font-weight: 700; font-size: 14px; color: var(--text); }
        .lang-btn { background: #f0f0f0; border: none; padding: 5px 12px; border-radius: 20px; font-weight: 600; font-size: 12px; color: #555; position: absolute; left: 50%; transform: translateX(-50%); }
        
        /* EARNINGS PILL */
        .earnings-pill { background: var(--white); border: 2px solid #ddd; padding: 5px 15px; border-radius: 30px; font-weight: 700; font-size: 13px; color: var(--online); display: flex; align-items: center; gap: 5px; transition: 0.3s; cursor: pointer; }
        .earnings-pill.offline { color: var(--offline); border-color: var(--offline); }
        .earnings-pill i { color: #FFD700; text-shadow: 0 1px 1px rgba(0,0,0,0.2); }

        /* BOTTOM CARDS (Common) */
        .bottom-card { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--white); border-radius: 25px 25px 0 0; padding: 25px 20px 15px 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.15); z-index: 100; display: flex; flex-direction: column; transition: transform 0.3s ease; }
        .hidden-card { transform: translateY(110%); }

        /* REQUEST CARD (NEW HIRE) */
        .req-title { font-size: 18px; font-weight: 700; color: var(--primary); margin-bottom: 5px; animation: flash 1s infinite; }
        .req-fare { font-size: 24px; font-weight: 800; color: #333; margin-bottom: 15px; }
        @keyframes flash { 50% { opacity: 0.5; } }
        
        .loc-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-start; }
        .loc-dot { width: 12px; height: 12px; border-radius: 50%; margin-top: 5px; flex-shrink: 0; }
        .dot-blue { background: #2196F3; border: 2px solid white; box-shadow: 0 0 0 2px #2196F3; }
        .dot-red { background: #F44336; border: 2px solid white; box-shadow: 0 0 0 2px #F44336; }
        .loc-txt { font-size: 14px; color: #555; font-weight: 500; }
        
        .req-meta { display: flex; justify-content: space-between; font-size: 13px; color: #777; margin: 15px 0; background: #f9f9f9; padding: 10px; border-radius: 8px; }
        
        /* 5s TIMER BUTTON */
        .accept-btn { position: relative; width: 100%; height: 55px; background: var(--primary); color: white; border: none; border-radius: 30px; font-size: 18px; font-weight: 700; cursor: pointer; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .timer-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .timer-circle { fill: none; stroke: rgba(255,255,255,0.3); stroke-width: 55; stroke-dasharray: 400; stroke-dashoffset: 0; transition: stroke-dashoffset 5s linear; }
        
        /* ACTIVE TRIP UI */
        .trip-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .trip-status { font-size: 12px; font-weight: 700; color: #2196F3; background: #E3F2FD; padding: 4px 10px; border-radius: 10px; }
        .pill-minimized { padding: 15px 20px; flex-direction: row; justify-content: space-between; align-items: center; cursor: pointer; }
        .pill-expand-icon { transition: 0.3s; }
        
        /* SLIDE BUTTON */
        .slide-btn-container { position: relative; width: 100%; height: 55px; background: #eee; border-radius: 30px; margin-top: 15px; overflow: hidden; }
        .slide-text { position: absolute; width: 100%; text-align: center; line-height: 55px; font-weight: 700; color: #888; z-index: 1; letter-spacing: 1px; }
        .slide-handle { position: absolute; left: 2px; top: 2px; width: 51px; height: 51px; background: var(--primary); border-radius: 50%; z-index: 2; display: flex; align-items: center; justify-content: center; color: white; cursor: grab; transition: background 0.3s; box-shadow: 2px 0 5px rgba(0,0,0,0.2); }
        .slide-bg { position: absolute; top: 0; left: 0; height: 100%; width: 0; background: var(--primary); opacity: 0.5; z-index: 0; }

        /* BUTTONS */
        .go-online-btn { background: var(--primary); color: white; width: 100%; padding: 15px; border: none; border-radius: 50px; font-size: 18px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 5px 15px rgba(211, 47, 47, 0.4); margin-top: 10px; transition: transform 0.1s; }
        .dot { width: 10px; height: 10px; background: white; border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        .vehicles-strip { width: 100%; background: #f5f5f5; padding: 12px; border-radius: 12px; margin-top: 15px; text-align: center; font-weight: 600; color: #333; font-size: 14px; border: 1px solid #ddd; }

        /* FULL SCREEN MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: center; align-items: flex-end; backdrop-filter: blur(3px); }
        .modal-card { background: white; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 25px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; animation: slideUp 0.3s ease; }
        .full-screen-modal { align-items: center; justify-content: center; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* SUMMARY MODAL */
        .summary-box { text-align: center; padding: 20px; }
        .total-price { font-size: 40px; font-weight: 800; color: var(--online); margin: 10px 0; }
        .collect-lbl { font-size: 14px; color: #555; text-transform: uppercase; letter-spacing: 1px; }
        .breakdown { background: #f9f9f9; padding: 15px; border-radius: 10px; margin: 20px 0; text-align: left; }
        .bd-row { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 5px; color: #555; }

        /* ADD VEHICLE & MANAGER STYLES (Existing) */
        .carousel { flex: 1; position: relative; overflow: hidden; min-height: 450px; display: flex; flex-direction: column; }
        .slide { position: absolute; top: 0; left: 100%; width: 100%; height: 100%; padding: 5px; box-sizing: border-box; transition: left 0.4s ease; display: flex; flex-direction: column; overflow-y: auto; background: white; }
        .slide.active { left: 0; } .slide.prev { left: -100%; }
        .type-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .type-card { background: #fff; border: 2px solid #eee; border-radius: 15px; padding: 20px; text-align: center; font-weight: 600; color: #555; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.2s; }
        .type-card.selected { border-color: var(--primary); background: #fff0f0; color: var(--primary); box-shadow: 0 4px 10px rgba(211, 47, 47, 0.2); }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; background: #f9f9f9; border-radius: 8px; margin-bottom: 15px; font-family: 'Poppins'; }
        
        .img-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px; }
        .img-upload { background: #f0f0f0; border: 2px dashed #ccc; height: 110px; display: flex; align-items: center; justify-content: center; border-radius: 10px; overflow: hidden; position: relative; flex-direction: column; }
        .img-upload img { width: 100%; height: 100%; object-fit: cover; display: none; position: absolute; top: 0; left: 0; }
        
        .v-item { padding: 15px; border: 1px solid #eee; border-radius: 12px; margin-bottom: 12px; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .v-item.selected { border: 2px solid var(--primary); background: #ffebee; }

        /* TOAST */
        #toast-container { position: fixed; top: 90px; left: 50%; transform: translateX(-50%); z-index: 9000; width: 90%; pointer-events: none; }
        .toast { background: #333; color: white; padding: 12px 20px; border-radius: 30px; text-align: center; margin-bottom: 10px; opacity: 0; transition: 0.3s; font-size: 13px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .toast.show { opacity: 1; transform: translateY(10px); }
        .toast.error { background: #d32f2f; } .toast.success { background: #388e3c; }
    </style>
</head>
<body>

<!-- MAP -->
<div id="map"></div>

<!-- TOP UI -->
<div class="top-card" id="top-ui" style="display:none;">
    <div class="profile-sec" onclick="openProfile()">
        <img src="" id="user-pic" class="p-img">
        <div class="p-name"><span id="user-name">Rider</span></div>
    </div>
    <button class="lang-btn" onclick="toggleLang()" id="lang-btn">EN</button>
    <div class="earnings-pill offline" id="earn-pill" onclick="showEarnings()">
        <i class="fas fa-coins"></i> <span id="earn-txt">OFFLINE</span>
    </div>
</div>

<!-- BOTTOM UI CONTAINER -->
<div id="bottom-container">

    <!-- 1. OFFLINE CARD -->
    <div class="bottom-card" id="card-offline" style="display:none;">
        <div style="font-weight:700; color:#444; margin-bottom:10px;">Driver Status</div>
        <button class="go-online-btn" onclick="initiateGoOnline()">
            <div class="dot"></div> GO ONLINE
        </button>
        <p style="font-size:12px; color:#777; text-align:center; margin:10px 0;">Go online to receive hires</p>
        <div class="vehicles-strip" onclick="openVehicleManager()">
            <i class="fas fa-car"></i> Manage Vehicles
        </div>
    </div>

    <!-- 2. ONLINE (SEARCHING) CARD -->
    <div class="bottom-card hidden-card" id="card-searching">
        <div style="text-align:center; margin-bottom:10px;">
            <h3 style="color:var(--primary); margin:0;">Finding Hires...</h3>
            <p style="font-size:12px; color:#777;">Keep GPS & Data ON</p>
        </div>
        <button class="go-online-btn" style="background:#333; font-size:14px; padding:12px;" onclick="goOffline()">GO OFFLINE</button>
        <div style="display:flex; justify-content:space-between; width:100%; margin-top:10px;">
            <label style="font-size:12px;"><input type="checkbox" id="chk-close"> Closer Rides</label>
            <label style="font-size:12px;"><input type="checkbox" id="chk-long"> Long Trips</label>
        </div>
    </div>

    <!-- 3. INCOMING REQUEST CARD -->
    <div class="bottom-card hidden-card" id="card-request" style="z-index:200;">
        <div class="req-title">New Hire!</div>
        <div class="req-fare">LKR <span id="req-price">0</span></div>
        
        <div class="loc-row"><div class="loc-dot dot-blue"></div><div class="loc-txt" id="req-pickup">...</div></div>
        <div class="loc-row"><div class="loc-dot dot-red"></div><div class="loc-txt" id="req-drop">...</div></div>
        
        <div class="req-meta">
            <span><i class="fas fa-location-arrow"></i> <span id="req-dist-user">0</span> km away</span>
            <span><i class="fas fa-route"></i> <span id="req-dist-trip">0</span> km trip</span>
        </div>

        <button class="accept-btn" id="accept-btn" onclick="acceptHire()">
            <svg class="timer-svg" viewBox="0 0 200 60"><rect x="0" y="0" width="200" height="60" class="timer-circle" rx="30"/></svg>
            <span style="position:relative; z-index:2;">GO & PICKUP</span>
        </button>
    </div>

    <!-- 4. ACTIVE TRIP CARD -->
    <div class="bottom-card hidden-card" id="card-trip">
        <div class="trip-header" onclick="toggleTripCard()">
            <div style="display:flex; gap:10px; align-items:center;">
                <i class="fas fa-chevron-up pill-expand-icon" id="trip-arrow"></i>
                <div>
                    <div style="font-weight:700; font-size:16px;" id="trip-cust-name">Customer</div>
                    <div style="font-size:12px; color:#777;" id="trip-status-txt">On way to pickup</div>
                </div>
            </div>
            <div class="trip-status">LKR <span id="live-fare">0</span></div>
        </div>

        <div id="trip-details" style="width:100%;">
            <div class="loc-row"><div class="loc-dot dot-blue"></div><div class="loc-txt" id="trip-from">...</div></div>
            <div class="loc-row"><div class="loc-dot dot-red"></div><div class="loc-txt" id="trip-to">...</div></div>
            
            <button class="go-online-btn" style="background:#2196F3; font-size:14px; margin-bottom:10px;" id="btn-notify" onclick="notifyUser()">Notify I'm Here</button>
            <button class="go-online-btn" style="background:#555; font-size:12px; padding:10px;" onclick="cancelTrip()">Cancel / Stop Trip</button>

            <!-- SLIDE BUTTON -->
            <div class="slide-btn-container" id="slider-cont">
                <div class="slide-bg" id="slider-bg"></div>
                <div class="slide-text" id="slider-text">SLIDE TO START</div>
                <div class="slide-handle" id="slider-handle"><i class="fas fa-chevron-right"></i></div>
            </div>
        </div>
    </div>

</div>

<!-- SUMMARY MODAL -->
<div id="summary-modal" class="modal-overlay full-screen-modal">
    <div class="modal-card">
        <div class="summary-box">
            <i class="fas fa-check-circle" style="font-size:50px; color:var(--online); margin-bottom:10px;"></i>
            <h2>Trip Ended</h2>
            <div class="collect-lbl">Cash to Collect</div>
            <div class="total-price">LKR <span id="sum-total">0</span></div>
            
            <div class="breakdown">
                <div class="bd-row"><span>Base Fare</span> <span id="sum-base">0</span></div>
                <div class="bd-row"><span>Distance</span> <span id="sum-dist">0</span></div>
                <div class="bd-row"><span>Waiting (<span id="sum-wait-time">0</span>m)</span> <span id="sum-wait-cost">0</span></div>
            </div>
            
            <button class="go-online-btn" onclick="finishCash()">CASH RECEIVED</button>
        </div>
    </div>
</div>

<!-- EARNINGS MODAL -->
<div id="earnings-modal" class="modal-overlay">
    <div class="modal-card">
        <h3 style="text-align:center;">Today's Earnings</h3>
        <h1 style="text-align:center; color:var(--online);">LKR <span id="daily-earn">0.00</span></h1>
        <hr>
        <div id="earn-list" style="max-height:300px; overflow-y:auto;"></div>
        <button class="vehicles-strip" onclick="closeModal('earnings-modal')">Close</button>
    </div>
</div>

<!-- ADD VEHICLE / MANAGER MODALS (Same as before) -->
<div id="vehicle-man-modal" class="modal-overlay">
    <div class="modal-card" style="height:85vh;">
        <h3 style="text-align:center;">My Vehicles</h3>
        <div id="man-veh-list" style="flex:1; overflow-y:auto; padding-bottom:10px;"></div>
        <button class="go-online-btn" style="background:#444; font-size:14px;" onclick="openAddVehicle()">+ Add Vehicle</button>
        <button class="vehicles-strip" onclick="closeModal('vehicle-man-modal')">Close</button>
    </div>
</div>

<div id="add-vehicle-modal" class="modal-overlay">
    <div class="modal-card" style="height:95vh;">
        <h3 style="text-align:center; margin-bottom:0;">Register Vehicle</h3>
        <div class="carousel">
            <div class="slide active" id="s1">
                <label>Vehicle Type</label>
                <div class="type-grid">
                    <div class="type-card" onclick="selectType('Bike', this)">üèçÔ∏è<br>Bike</div>
                    <div class="type-card" onclick="selectType('Tuk Tuk', this)">üõ∫<br>Tuk Tuk</div>
                    <div class="type-card" onclick="selectType('Car', this)">üöó<br>Car</div>
                    <div class="type-card" onclick="selectType('Van', this)">üöê<br>Van</div>
                </div>
                <button class="go-online-btn" style="margin-top:20px;" onclick="next(1)">Next</button>
            </div>
            <div class="slide" id="s2">
                <label>Brand</label><select id="v-brand" onchange="loadModels()"><option value="">Select</option></select>
                <label>Model</label><select id="v-model"><option value="">Select</option></select>
                <input type="text" id="v-other" placeholder="Other model name (Optional)" style="margin-top:5px;">
                <button class="go-online-btn" style="margin-top:20px;" onclick="next(2)">Next</button>
                <button class="vehicles-strip" onclick="prev(2)">Back</button>
            </div>
            <div class="slide" id="s3">
                <label>Number Plate</label>
                <div style="display:flex; gap:10px;">
                    <select id="v-plate-prov" style="width:30%"><option>WP</option><option>CP</option><option>SP</option><option>NP</option><option>EP</option><option>NW</option><option>NC</option><option>UP</option><option>SG</option></select>
                    <input type="text" id="v-plate-num" placeholder="CAB-1234" style="width:70%; text-transform:uppercase;" maxlength="8">
                </div>
                <button class="go-online-btn" style="margin-top:20px;" onclick="next(3)">Next</button>
                <button class="vehicles-strip" onclick="prev(3)">Back</button>
            </div>
            <div class="slide" id="s4">
                <label>Color</label><select id="v-color"><option>White</option><option>Black</option><option>Red</option><option>Blue</option><option>Silver</option></select>
                <label>Details</label><textarea id="v-det" rows="2"></textarea>
                <button class="go-online-btn" style="margin-top:20px;" onclick="next(4)">Next</button>
                <button class="vehicles-strip" onclick="prev(4)">Back</button>
            </div>
            <div class="slide" id="s5">
                <label>Photos (Ext & Int)</label>
                <div class="img-grid">
                    <div class="img-upload" onclick="up('ext1')">Front Ext<img id="p-ext1"></div>
                    <div class="img-upload" onclick="up('ext2')">Back Ext<img id="p-ext2"></div>
                    <div class="img-upload" onclick="up('int1')">Front Int<img id="p-int1"></div>
                    <div class="img-upload" onclick="up('int2')">Back Int<img id="p-int2"></div>
                </div>
                <input type="file" id="f-ext1" hidden onchange="proc(this,'p-ext1')"><input type="file" id="f-ext2" hidden onchange="proc(this,'p-ext2')">
                <input type="file" id="f-int1" hidden onchange="proc(this,'p-int1')"><input type="file" id="f-int2" hidden onchange="proc(this,'p-int2')">
                <button class="go-online-btn" style="margin-top:20px;" onclick="next(5)">Next</button>
                <button class="vehicles-strip" onclick="prev(5)">Back</button>
            </div>
            <div class="slide" id="s6">
                <label>License</label>
                <div class="img-grid">
                    <div class="img-upload" onclick="up('lic1')">Front<img id="p-lic1"></div>
                    <div class="img-upload" onclick="up('lic2')">Back<img id="p-lic2"></div>
                </div>
                <input type="file" id="f-lic1" hidden onchange="proc(this,'p-lic1')"><input type="file" id="f-lic2" hidden onchange="proc(this,'p-lic2')">
                <button class="go-online-btn" style="margin-top:20px;" onclick="next(6)">Next</button>
                <button class="vehicles-strip" onclick="prev(6)">Back</button>
            </div>
            <div class="slide" id="s7">
                <h4>Agreement</h4>
                <div style="height:100px; overflow-y:scroll; background:#f9f9f9; font-size:12px; padding:10px;">Terms...</div>
                <label><input type="checkbox" id="agree-chk"> I Agree</label>
                <button class="go-online-btn" style="margin-top:20px;" onclick="submitVehicle()">Submit</button>
                <button class="vehicles-strip" onclick="prev(7)">Back</button>
            </div>
        </div>
        <button class="vehicles-strip" onclick="closeModal('add-vehicle-modal')">Close</button>
    </div>
</div>

<div id="vehicle-select-modal" class="modal-overlay">
    <div class="modal-card">
        <h3 style="text-align:center;">Select Vehicle</h3>
        <div id="online-veh-list" style="max-height:300px; overflow-y:auto; margin-bottom:10px;"></div>
        <button class="go-online-btn" onclick="confirmVehicle()">Continue</button>
        <button class="vehicles-strip" onclick="closeModal('vehicle-select-modal')">Cancel</button>
    </div>
</div>

<div id="toast-container"></div>

<!-- JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, get, update, set, remove, onDisconnect, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const db = getDatabase(initializeApp({
        apiKey: "AIzaSyC3Rf4x5a_L1cYVa6soADfYktQK5WyMN-4",
        authDomain: "speedo-acb7c.firebaseapp.com",
        databaseURL: "https://speedo-acb7c-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "speedo-acb7c"
    }));

    const vehicleDB = {
        "Bike": {"Honda":["Dio","Hornet"],"Yamaha":["FZ","MT15"],"Bajaj":["Pulsar"]},
        "Tuk Tuk": {"Bajaj":["RE 4S","Compact"],"TVS":["King"]},
        "Car": {"Toyota":["Axio","Vitz","Premio","Corolla","Aqua","Prius"],"Suzuki":["Alto","WagonR","Swift"],"Honda":["Grace","Fit","Vezel"]},
        "Van": {"Toyota":["KDH","Hiace"],"Nissan":["Caravan"]}
    };

    let currentUser=null, map, marker, routeControl;
    let currentVehicles=[], selectedVehId, selectedVehType, isOnline=false;
    let tripState = "IDLE"; // IDLE, REQUEST, PICKUP, TRIP, END
    let currentOrder = null, tempV={type:"",imgs:{}}, earnings=0;
    
    // Trip Vars
    let tripInterval, waitInterval, waitMinutes=0, lastPos=null, tripPrice=0;

    window.onload = async () => {
        // Load Earnings
        let savedEarn = localStorage.getItem('speedo_earnings');
        if(savedEarn) { earnings = parseFloat(savedEarn); updateEarnUI(); }

        const uid = localStorage.getItem('uid');
        const dist = localStorage.getItem('dist');
        if(!uid) return location.href="rider.html";

        try {
            const s = await get(ref(db, `riders/${dist}/${uid}`));
            if(s.exists()) {
                const d = s.val().riderdata;
                currentUser = { ...d, uid, dist };
                document.getElementById('user-pic').src = d.selfie || '';
                document.getElementById('user-name').innerText = d.fullName.split(" ")[0];
                await loadVehicles();
                document.getElementById('top-ui').style.display='flex';
                document.getElementById('card-offline').style.display='flex';
                initMap();
            }
        } catch(e){}
    };

    function initMap() {
        map = L.map('map', {zoomControl:false}).setView([7.8, 80.7], 8);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        if("geolocation" in navigator) {
            navigator.geolocation.watchPosition(pos => {
                const {latitude:lat, longitude:lng} = pos.coords;
                if(!marker) {
                    const icon = L.divIcon({ className:'c', html:`<div class='gps-marker-container'><div class='gps-pulse'></div><div class='gps-dot'></div></div>`, iconSize:[50,50] });
                    marker = L.marker([lat, lng], {icon}).addTo(map);
                    map.setView([lat, lng], 16);
                } else {
                    marker.setLatLng([lat, lng]);
                    if(isOnline && !currentOrder) map.setView([lat, lng]); // Follow if idle
                    
                    if(isOnline && selectedVehId) {
                        update(ref(db, `vehicles/${selectedVehType}/${selectedVehId}/location`), {lat, lng, ts:Date.now()});
                        update(ref(db, `riders/${currentUser.dist}/${currentUser.uid}/location`), {lat, lng});
                    }
                    
                    // Trip Logic
                    if(tripState === "TRIP" || tripState === "PICKUP") checkArrival(lat, lng);
                    if(tripState === "TRIP") calculateTripMetrics(lat, lng, pos.coords.speed);
                }
            }, null, {enableHighAccuracy:true});
        }
    }

    // --- ONLINE LOGIC ---
    window.initiateGoOnline = () => {
        const app = currentVehicles.filter(v => v.approved_status === true);
        if(app.length===0) return toast("No Approved Vehicles", "error");
        
        const list = document.getElementById('online-veh-list');
        list.innerHTML = "";
        app.forEach(v => {
            let d = document.createElement('div');
            d.className = 'v-item';
            d.innerHTML = `<div class="v-info"><b>${v.brand} ${v.model}</b> <br><small>${v.plate}</small></div>`;
            d.onclick = () => {
                document.querySelectorAll('.v-item').forEach(x=>x.classList.remove('selected'));
                d.classList.add('selected');
                selectedVehId = v.id; selectedVehType = v.type;
            };
            list.appendChild(d);
        });
        openModal('vehicle-select-modal');
    }

    window.confirmVehicle = () => {
        if(!selectedVehId) return;
        closeModal('vehicle-select-modal');
        isOnline = true;
        
        document.getElementById('card-offline').style.display='none';
        document.getElementById('card-searching').classList.remove('hidden-card');
        document.getElementById('earn-pill').classList.remove('offline');
        document.getElementById('earn-txt').innerText = earnings.toFixed(2);

        update(ref(db, `vehicles/${selectedVehType}/${selectedVehId}`), {status:"online"});
        update(ref(db, `riders/${currentUser.dist}/${currentUser.uid}`), {rider_status:"online", active_vehicle:selectedVehId});
        
        // Listen for requests (Simulation: listening to node)
        listenForHires();
    }

    window.goOffline = () => {
        isOnline = false;
        document.getElementById('card-searching').classList.add('hidden-card');
        document.getElementById('card-offline').style.display='flex';
        document.getElementById('earn-pill').classList.add('offline');
        document.getElementById('earn-txt').innerText = "OFFLINE";
        update(ref(db, `vehicles/${selectedVehType}/${selectedVehId}`), {status:"offline"});
        // Stop listening
    }

    // --- RIDE FLOW ---
    function listenForHires() {
        // In real app, listen to `riders/{dist}/{uid}/request`
        // Here we assume a request comes in
        // SIMULATION FOR UI DEMO:
        /* 
        setTimeout(() => {
            if(isOnline && tripState==="IDLE") showRequest({
                id: "ORD123", price: 450, pickup: "Main St", drop: "City Mall",
                distUser: 1.2, distTrip: 5.5, pLat: 7.8, pLng: 80.7, dLat: 7.85, dLng: 80.75
            });
        }, 5000);
        */
    }

    // Function to call from console to test: window.testRequest()
    window.testRequest = () => {
        showRequest({ id:"O1", price:300, pickup:"Town Hall", drop:"Cinema", distUser:0.5, distTrip:3.2, pLat:7.87, pLng:80.77, dLat:7.89, dLng:80.78 });
    }

    function showRequest(req) {
        currentOrder = req;
        tripState = "REQUEST";
        document.getElementById('req-price').innerText = req.price;
        document.getElementById('req-pickup').innerText = req.pickup;
        document.getElementById('req-drop').innerText = req.drop;
        document.getElementById('req-dist-user').innerText = req.distUser;
        document.getElementById('req-dist-trip').innerText = req.distTrip;
        
        document.getElementById('card-searching').classList.add('hidden-card');
        document.getElementById('card-request').classList.remove('hidden-card');
        
        // 5s Timer
        let btn = document.querySelector('.timer-circle');
        btn.style.strokeDashoffset = 0;
        setTimeout(() => btn.style.strokeDashoffset = 400, 10);
        
        setTimeout(() => {
            if(tripState === "REQUEST") { // Timeout
                tripState = "IDLE";
                currentOrder = null;
                document.getElementById('card-request').classList.add('hidden-card');
                document.getElementById('card-searching').classList.remove('hidden-card');
            }
        }, 5000);
    }

    window.acceptHire = () => {
        tripState = "PICKUP";
        document.getElementById('card-request').classList.add('hidden-card');
        document.getElementById('card-trip').classList.remove('hidden-card');
        
        // Setup Pickup UI
        document.getElementById('trip-status-txt').innerText = "On way to pickup";
        document.getElementById('trip-from').innerText = currentOrder.pickup;
        document.getElementById('trip-to').innerText = currentOrder.drop;
        document.getElementById('live-fare').innerText = currentOrder.price;
        
        setupSlider("SLIDE TO START", startTrip);
        drawRoute(currentOrder.pLat, currentOrder.pLng); // Route to pickup
    }

    window.notifyUser = () => {
        toast("User Notified!", "success");
        // Update DB order status = "arrived"
    }

    function startTrip() {
        tripState = "TRIP";
        document.getElementById('trip-status-txt').innerText = "Heading to Destination";
        document.getElementById('btn-notify').style.display='none';
        
        setupSlider("SLIDE TO END", endTrip);
        drawRoute(currentOrder.dLat, currentOrder.dLng); // Route to drop
        
        // Start Pricing
        waitMinutes = 0;
        tripPrice = currentOrder.price;
        waitInterval = setInterval(() => {
            // Wait Logic (Simplified: if state is TRIP and not moving much)
            // In real app, check speed from GPS
            // waitMinutes++;
            // if(waitMinutes > 5) { tripPrice += 50; updateFareUI(); }
        }, 60000);
    }

    function endTrip() {
        clearInterval(waitInterval);
        tripState = "IDLE";
        
        document.getElementById('card-trip').classList.add('hidden-card');
        
        // Show Summary
        document.getElementById('sum-total').innerText = tripPrice;
        document.getElementById('sum-base').innerText = currentOrder.price;
        document.getElementById('sum-dist').innerText = "0"; // Calc real dist
        document.getElementById('sum-wait-cost').innerText = (Math.max(0, waitMinutes-5) * 10); // Example
        
        document.getElementById('summary-modal').style.display = 'flex';
        
        if(routeControl) { map.removeControl(routeControl); routeControl=null; }
    }

    window.finishCash = () => {
        closeModal('summary-modal');
        earnings += tripPrice;
        localStorage.setItem('speedo_earnings', earnings);
        document.getElementById('earn-txt').innerText = earnings.toFixed(2);
        
        document.getElementById('card-searching').classList.remove('hidden-card');
        document.getElementById('btn-notify').style.display='block'; // Reset UI
        currentOrder = null;
    }

    // --- HELPER FUNC ---
    function drawRoute(lat, lng) {
        if(routeControl) map.removeControl(routeControl);
        routeControl = L.Routing.control({
            waypoints: [
                L.latLng(marker.getLatLng()),
                L.latLng(lat, lng)
            ],
            lineOptions: { styles: [{color: 'blue', opacity: 0.6, weight: 6}] },
            createMarker: function() { return null; }, // No markers
            addWaypoints: false,
            draggableWaypoints: false,
            fitSelectedRoutes: true,
            show: false // Hide text instructions
        }).addTo(map);
    }

    function checkArrival(lat, lng) {
        let target = tripState==="PICKUP" ? {lat:currentOrder.pLat, lng:currentOrder.pLng} : {lat:currentOrder.dLat, lng:currentOrder.dLng};
        let d = map.distance([lat,lng], [target.lat, target.lng]);
        if(d < 50) {
            // Auto expand card logic if minified
            document.getElementById('trip-details').style.display='block';
        }
    }

    // --- SLIDER LOGIC ---
    function setupSlider(text, callback) {
        const slider = document.getElementById('slider-handle');
        const bg = document.getElementById('slider-bg');
        document.getElementById('slider-text').innerText = text;
        
        let isDragging = false;
        let startX, containerWidth;

        slider.addEventListener('touchstart', (e) => {
            isDragging = true;
            startX = e.touches[0].clientX;
            containerWidth = document.getElementById('slider-cont').offsetWidth - 55;
        });

        document.addEventListener('touchmove', (e) => {
            if(!isDragging) return;
            let moveX = e.touches[0].clientX - startX;
            if(moveX < 0) moveX = 0;
            if(moveX > containerWidth) moveX = containerWidth;
            
            slider.style.left = (moveX + 2) + 'px';
            bg.style.width = moveX + 'px';
            
            if(moveX >= containerWidth) {
                isDragging = false;
                callback();
                resetSlider();
            }
        });

        document.addEventListener('touchend', () => {
            if(isDragging) resetSlider();
            isDragging = false;
        });
        
        function resetSlider() {
            slider.style.transition = '0.3s';
            bg.style.transition = '0.3s';
            slider.style.left = '2px';
            bg.style.width = '0px';
            setTimeout(() => { slider.style.transition = 'none'; bg.style.transition = 'none'; }, 300);
        }
    }

    // --- UTILS ---
    const toast = (m,t) => {
        let d=document.createElement('div'); d.className=`toast ${t}`; d.innerText=m;
        document.getElementById('toast-container').appendChild(d);
        setTimeout(()=>d.classList.add('show'),10); setTimeout(()=>{d.classList.remove('show'); setTimeout(()=>d.remove(),300)},2500);
    }
    window.openModal=(id)=>document.getElementById(id).style.display='flex';
    window.closeModal=(id)=>document.getElementById(id).style.display='none';
    
    // Toggle Trip Card Size
    window.toggleTripCard = () => {
        let d = document.getElementById('trip-details');
        let a = document.getElementById('trip-arrow');
        if(d.style.display==='none') { d.style.display='block'; a.classList.remove('fa-chevron-down'); a.classList.add('fa-chevron-up'); }
        else { d.style.display='none'; a.classList.remove('fa-chevron-up'); a.classList.add('fa-chevron-down'); }
    }

    // --- VEHICLE REGISTRATION (Restored Logic) ---
    window.openAddVehicle = () => { closeModal('vehicle-man-modal'); openModal('add-vehicle-modal'); }
    window.selectType = (t, el) => { document.querySelectorAll('.type-card').forEach(x=>x.classList.remove('selected')); el.classList.add('selected'); tempV.type = t; }
    window.loadModels = () => {
        let b = document.getElementById('v-brand').value;
        let m = document.getElementById('v-model'); m.innerHTML="<option value=''>Select</option>";
        if(b && vehicleDB[tempV.type][b]) vehicleDB[tempV.type][b].forEach(x=>m.innerHTML+=`<option>${x}</option>`);
    }
    window.next = (s) => {
        if(s===1) { if(!tempV.type) return toast("Select Type","error"); let b=document.getElementById('v-brand'); b.innerHTML="<option>Select</option>"; Object.keys(vehicleDB[tempV.type]).forEach(x=>b.innerHTML+=`<option>${x}</option>`); }
        if(s===2) { tempV.brand=document.getElementById('v-brand').value; tempV.model=document.getElementById('v-model').value || document.getElementById('v-other').value; if(!tempV.brand) return toast("Brand required","error"); }
        if(s===3) { 
            let p = document.getElementById('v-plate-num').value.toUpperCase();
            if(!/^[A-Z]{2,3}[-\s]?\d{4}$/.test(p)) return toast("Invalid Plate","error");
            tempV.plate = document.getElementById('v-plate-prov').value + " " + p;
        }
        if(s===5 && (!tempV.imgs.ext1 || !tempV.imgs.int1)) return toast("Photos required","error");
        
        document.getElementById(`s${s}`).classList.add('prev');
        document.getElementById(`s${s}`).classList.remove('active');
        document.getElementById(`s${s+1}`).classList.add('active');
    }
    window.prev = (s) => { document.getElementById(`s${s}`).classList.remove('active'); document.getElementById(`s${s-1}`).classList.remove('prev'); document.getElementById(`s${s-1}`).classList.add('active'); }
    window.up = (id) => document.getElementById('f-'+id).click();
    window.proc = (i, id) => {
        let r=new FileReader(); r.onload=(e)=>{
            let im=new Image(); im.src=e.target.result;
            im.onload=()=>{
                let c=document.createElement('canvas'), x=c.getContext('2d'), s=600/im.width;
                c.width=600; c.height=im.height*s; x.drawImage(im,0,0,c.width,c.height);
                let b64=c.toDataURL('image/jpeg',0.5);
                document.getElementById(id).src=b64; document.getElementById(id).style.display='block';
                tempV.imgs[id.replace('p-','')] = b64;
            }
        }; r.readAsDataURL(i.files[0]);
    }
    window.submitVehicle = async () => {
        if(!document.getElementById('agree-chk').checked) return toast("Agree to terms","error");
        let vid="V"+Date.now();
        await set(ref(db, `vehicles/${tempV.type}/${vid}`), {
            ownerUid:currentUser.uid, ownerName:currentUser.fullName, district:currentUser.dist,
            type:tempV.type, brand:tempV.brand, model:tempV.model, plate:tempV.plate,
            color:document.getElementById('v-color').value, details:document.getElementById('v-det').value,
            images:tempV.imgs, approved_status:false
        });
        toast("Submitted","success"); closeModal('add-vehicle-modal'); loadVehicles();
    }
    
    // Manage Vehicles
    async function loadVehicles() {
        currentVehicles=[];
        for(let t of ["Bike","Tuk Tuk","Car","Van"]) {
            try { const s=await get(ref(db, `vehicles/${t}`)); if(s.exists()) s.forEach(v=>{ if(v.val().ownerUid===currentUser.uid) currentVehicles.push({...v.val(), id:v.key, type:t}); }); } catch(e){}
        }
    }
    window.openVehicleManager=()=>{
        const l=document.getElementById('man-veh-list'); l.innerHTML="";
        if(currentVehicles.length===0) l.innerHTML="<p style='text-align:center'>No vehicles</p>";
        currentVehicles.forEach(v=>{
            let d=document.createElement('div'); d.className='v-item';
            let st=v.approved_status===true?"<span style='color:green'>Approved</span>": (v.approved_status==="declined"?"<span style='color:red'>Declined</span>":"<span style='color:orange'>Pending</span>");
            d.innerHTML=`<div><b>${v.brand}</b><br><small>${v.plate}</small></div><div>${st}<br><button class="del-btn" onclick="askDelete('${v.type}','${v.id}')">Delete</button></div>`;
            l.appendChild(d);
        });
        openModal('vehicle-man-modal');
    }
    window.askDelete=(t,i)=>{ if(confirm("Delete?")) { remove(ref(db, `vehicles/${t}/${i}`)); loadVehicles(); openVehicleManager(); } }

    window.toggleLang=()=>{lang=lang==='en'?'si':(lang==='si'?'ta':'en'); localStorage.setItem('speedo_lang',lang); document.getElementById('lang-btn').innerText=lang.toUpperCase();}
</script>
</body>
</html>
