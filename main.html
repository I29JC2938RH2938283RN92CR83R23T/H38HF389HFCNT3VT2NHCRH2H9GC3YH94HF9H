<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speedo Rider</title>
    
    <!-- Fonts: Noto Sans for Sinhala/Tamil support -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Noto+Sans+Sinhala:wght@400;700&family=Noto+Sans+Tamil:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <style>
        :root { --primary: #D32F2F; --flash: #FFC107; --white: #ffffff; --text: #333; --online: #00C853; --offline: #D32F2F; --bg: #f4f4f4; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
        body { margin: 0; padding: 0; font-family: 'Poppins', 'Noto Sans Sinhala', 'Noto Sans Tamil', sans-serif; overflow: hidden; background: #eee; height: 100vh; width: 100vw; }

        /* GLOBAL LOADING SCREEN (Fixes white screen) */
        #global-loader-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s;
        }
        .app-logo { font-size: 40px; color: var(--primary); margin-bottom: 20px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
        .loading-text { font-weight: 600; color: #666; }

        /* MAP */
        #map { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        .leaflet-routing-container { display: none; }

        /* MARKERS */
        .gps-marker-container { width: 50px; height: 50px; display: flex; justify-content: center; align-items: center; position: relative; }
        .gps-dot { width: 16px; height: 16px; background: #2196F3; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 2; position: relative; }
        .gps-pulse { position: absolute; width: 50px; height: 50px; background: rgba(33, 150, 243, 0.4); border-radius: 50%; z-index: 1; animation: pulse-ring 2s infinite; }
        @keyframes pulse-ring { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }

        /* TOP CARD */
        .top-card { position: fixed; top: 15px; left: 15px; right: 15px; background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); border-radius: 15px; padding: 10px 15px; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 100; }
        .profile-sec { display: flex; align-items: center; gap: 10px; }
        .p-img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        .p-name { font-weight: 700; font-size: 14px; color: var(--text); }
        .lang-btn { background: #f0f0f0; border: none; padding: 5px 12px; border-radius: 20px; font-weight: 600; font-size: 12px; color: #555; position: absolute; left: 50%; transform: translateX(-50%); cursor: pointer; border:1px solid #ccc; }
        
        /* EARNINGS PILL (Always Visible) */
        .earnings-pill { background: var(--white); border: 2px solid #ddd; padding: 5px 15px; border-radius: 30px; font-weight: 700; font-size: 13px; color: var(--online); display: flex; align-items: center; gap: 5px; transition: 0.3s; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .earnings-pill i { color: #FFD700; text-shadow: 0 1px 1px rgba(0,0,0,0.2); }

        /* BOTTOM CARDS */
        .bottom-card { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--white); border-radius: 25px 25px 0 0; padding: 25px 20px 15px 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.15); z-index: 100; display: flex; flex-direction: column; transition: transform 0.3s ease; }
        .hidden-card { transform: translateY(110%); }

        /* LINEAR LOADER */
        .linear-loader { width: 100%; height: 4px; background: #eee; position: relative; overflow: hidden; margin-bottom: 15px; border-radius: 2px; display: none; }
        .linear-bar { position: absolute; left: 0; top: 0; height: 100%; width: 30%; background: var(--primary); animation: loadMove 1.5s infinite ease-in-out; }
        @keyframes loadMove { 0% { left: -30%; } 100% { left: 100%; } }

        /* REQUEST UI */
        .req-title { font-size: 18px; font-weight: 700; color: var(--primary); margin-bottom: 5px; animation: flash 1s infinite; display: flex; justify-content: space-between; align-items: center; }
        @keyframes flash { 50% { opacity: 0.5; } }
        .req-fare { font-size: 24px; font-weight: 800; color: #333; margin-bottom: 15px; }
        
        .loc-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-start; }
        .loc-dot { width: 12px; height: 12px; border-radius: 50%; margin-top: 5px; flex-shrink: 0; }
        .dot-blue { background: #2196F3; border: 2px solid white; box-shadow: 0 0 0 2px #2196F3; }
        .dot-red { background: #F44336; border: 2px solid white; box-shadow: 0 0 0 2px #F44336; }
        .loc-txt { font-size: 14px; color: #555; font-weight: 500; }
        
        .req-meta { display: flex; justify-content: space-between; font-size: 13px; color: #777; margin: 15px 0; background: #f9f9f9; padding: 10px; border-radius: 8px; }
        
        .accept-btn { position: relative; width: 100%; height: 55px; background: var(--primary); color: white; border: none; border-radius: 30px; font-size: 18px; font-weight: 700; cursor: pointer; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .timer-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .timer-circle { fill: none; stroke: rgba(255,255,255,0.3); stroke-width: 55; stroke-dasharray: 400; stroke-dashoffset: 0; transition: stroke-dashoffset 10s linear; }
        
        /* FLASH RIBBON & DETAILS */
        .flash-ribbon {
            background: var(--flash);
            color: #333;
            font-size: 10px;
            font-weight: 800;
            padding: 4px 10px;
            border-radius: 4px;
            text-transform: uppercase;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            margin-left: 10px;
        }

        /* TRIP UI */
        .trip-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .trip-status { font-size: 12px; font-weight: 700; color: #2196F3; background: #E3F2FD; padding: 4px 10px; border-radius: 10px; }
        .pill-expand-icon { transition: 0.3s; }
        
        .slide-btn-container { position: relative; width: 100%; height: 55px; background: #eee; border-radius: 30px; margin-top: 15px; overflow: hidden; }
        .slide-text { position: absolute; width: 100%; text-align: center; line-height: 55px; font-weight: 700; color: #888; z-index: 1; letter-spacing: 1px; }
        .slide-handle { position: absolute; left: 2px; top: 2px; width: 51px; height: 51px; background: var(--primary); border-radius: 50%; z-index: 2; display: flex; align-items: center; justify-content: center; color: white; cursor: grab; transition: background 0.3s; box-shadow: 2px 0 5px rgba(0,0,0,0.2); }
        .slide-bg { position: absolute; top: 0; left: 0; height: 100%; width: 0; background: var(--primary); opacity: 0.5; z-index: 0; }

        .go-online-btn { background: var(--primary); color: white; width: 100%; padding: 15px; border: none; border-radius: 50px; font-size: 18px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 5px 15px rgba(211, 47, 47, 0.4); margin-top: 10px; transition: transform 0.1s; }
        .dot { width: 10px; height: 10px; background: white; border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        .vehicles-strip { width: 100%; background: #f5f5f5; padding: 12px; border-radius: 12px; margin-top: 15px; text-align: center; font-weight: 600; color: #333; font-size: 14px; border: 1px solid #ddd; cursor: pointer; }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: center; align-items: flex-end; backdrop-filter: blur(3px); }
        .modal-card { background: white; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 25px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; animation: slideUp 0.3s ease; }
        .full-screen-modal { align-items: center; justify-content: center; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* TOAST */
        #toast-container { position: fixed; top: 90px; left: 50%; transform: translateX(-50%); z-index: 9000; width: 90%; pointer-events: none; }
        .toast { background: #333; color: white; padding: 12px 20px; border-radius: 30px; text-align: center; margin-bottom: 10px; opacity: 0; transition: 0.3s; font-size: 13px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .toast.show { opacity: 1; transform: translateY(10px); }
        .toast.error { background: #d32f2f; } .toast.success { background: #388e3c; }
        
        /* Popup Loader */
        .popup-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 3000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #eee; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* VEHICLE LIST ITEM */
        .v-item { padding: 15px; border: 1px solid #eee; border-radius: 12px; margin-bottom: 12px; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .v-item.selected { border: 2px solid var(--primary); background: #ffebee; }
        .del-btn { background: #ffebee; color: #d32f2f; border: none; padding: 5px 12px; border-radius: 20px; font-weight: 700; font-size: 12px; margin-top: 5px; cursor: pointer; transition: 0.2s; }
        .del-btn:active { background: #ffcdd2; }
        
        .img-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px; }
        .img-upload { background: #f0f0f0; border: 2px dashed #ccc; height: 110px; display: flex; align-items: center; justify-content: center; border-radius: 10px; overflow: hidden; position: relative; flex-direction: column; text-align: center; font-size: 12px; color: #777; }
        .img-upload img { width: 100%; height: 100%; object-fit: cover; display: none; position: absolute; top: 0; left: 0; }

        /* Message Popup */
        #msg-popup {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 6000;
            display: none; justify-content: center; align-items: center;
        }
        .msg-content {
            background: white; padding: 30px; border-radius: 20px; width: 80%; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .msg-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; margin: 15px 0; }
    </style>
</head>
<body>

<!-- GLOBAL LOADING SCREEN -->
<div id="global-loader-screen">
    <i class="fa-solid fa-taxi app-logo"></i>
    <div class="loading-text">Loading Speedo...</div>
</div>

<!-- MAP -->
<div id="map"></div>

<!-- GLOBAL POPUP LOADER -->
<div id="global-loader" class="popup-loader">
    <div class="spinner"></div>
    <div style="font-weight:600; color:#555;" data-i18n="processing">Processing...</div>
</div>

<!-- MESSAGE POPUP -->
<div id="msg-popup">
    <div class="msg-content">
        <h3>Message Customer</h3>
        <input type="text" id="msg-input-text" class="msg-input" placeholder="Type a message...">
        <div style="display:flex; gap:10px;">
            <button class="go-online-btn" style="background:#ddd; color:#333;" onclick="document.getElementById('msg-popup').style.display='none'">Cancel</button>
            <button class="go-online-btn" onclick="sendMessageToUser()">Send</button>
        </div>
    </div>
</div>

<!-- FULL SCREEN USER MESSAGE -->
<div id="user-msg-fullscreen" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9000; display:none; justify-content:center; align-items:center; color:white; font-size:24px; text-align:center; padding:20px;">
    <i class="fa-solid fa-comment-dots" style="margin-bottom:20px; font-size:50px;"></i>
    <div id="user-msg-text">Message from Customer</div>
</div>

<!-- TOP UI -->
<div class="top-card" id="top-ui" style="display:none;">
    <div class="profile-sec" onclick="openProfile()">
        <img src="" id="user-pic" class="p-img">
        <div class="p-name"><span id="user-name">Rider</span></div>
    </div>
    <button class="lang-btn" onclick="toggleLang()" id="lang-btn">EN</button>
    <!-- Always visible earnings -->
    <div class="earnings-pill" id="earn-pill" onclick="showEarnings()">
        <i class="fas fa-coins"></i> <span id="earn-txt">0.00</span>
    </div>
</div>

<!-- BOTTOM UI CONTAINER -->
<div id="bottom-container">

    <!-- 1. OFFLINE CARD -->
    <div class="bottom-card" id="card-offline" style="display:none;">
        <div style="font-weight:700; color:#444; margin-bottom:10px;" data-i18n="status_title">Driver Status</div>
        <button class="go-online-btn" onclick="initiateGoOnline()">
            <div class="dot"></div> <span data-i18n="btn_online">GO ONLINE</span>
        </button>
        <p style="font-size:12px; color:#777; text-align:center; margin:10px 0;" data-i18n="online_desc">Go online to receive hires</p>
        <div class="vehicles-strip" onclick="openVehicleManager()">
            <i class="fas fa-car"></i> <span data-i18n="btn_manage_veh">Manage Vehicles</span>
        </div>
    </div>

    <!-- 2. ONLINE (SEARCHING) CARD -->
    <div class="bottom-card hidden-card" id="card-searching">
        <div class="linear-loader" style="display:block;">
            <div class="linear-bar"></div>
        </div>
        <div style="text-align:center; margin-bottom:10px;">
            <h3 style="color:var(--primary); margin:0;" data-i18n="finding">Finding Hires...</h3>
            <p style="font-size:12px; color:#777;" data-i18n="gps_on">Keep GPS & Data ON</p>
        </div>
        <button class="go-online-btn" style="background:#333; font-size:14px; padding:12px;" onclick="goOffline()">
            <span data-i18n="btn_offline">GO OFFLINE</span>
        </button>
    </div>

    <!-- 3. INCOMING REQUEST CARD -->
    <div class="bottom-card hidden-card" id="card-request" style="z-index:200;">
        <div class="req-title">
            <span data-i18n="new_hire">New Hire!</span>
            <!-- Flash Ribbon injected via JS -->
            <span id="req-flash-badge"></span>
        </div>
        <div class="req-fare">LKR <span id="req-price">0</span></div>
        
        <div class="loc-row"><div class="loc-dot dot-blue"></div><div class="loc-txt" id="req-pickup">...</div></div>
        <div class="loc-row"><div class="loc-dot dot-red"></div><div class="loc-txt" id="req-drop">...</div></div>
        
        <!-- Flash details injected via JS -->
        <div id="req-flash-details" style="font-size:12px; color:#f57f17; margin-bottom:10px; display:none; font-weight:600; padding:8px; background:#fffde7; border-radius:8px;"></div>

        <div class="req-meta">
            <span><i class="fas fa-location-arrow"></i> <span id="req-dist-user">0</span> km</span>
            <span><i class="fas fa-route"></i> <span id="req-dist-trip">0</span> km</span>
        </div>

        <button class="accept-btn" id="accept-btn" onclick="acceptHire()">
            <svg class="timer-svg" viewBox="0 0 200 60"><rect x="0" y="0" width="200" height="60" class="timer-circle" rx="30"/></svg>
            <span style="position:relative; z-index:2;" data-i18n="btn_accept">GO & PICKUP</span>
        </button>
    </div>

    <!-- 4. ACTIVE TRIP CARD -->
    <div class="bottom-card hidden-card" id="card-trip">
        <div class="trip-header" onclick="toggleTripCard()">
            <div style="display:flex; gap:10px; align-items:center;">
                <i class="fas fa-chevron-up pill-expand-icon" id="trip-arrow"></i>
                <div>
                    <div style="font-weight:700; font-size:16px;" id="trip-cust-name">Customer</div>
                    <div style="font-size:12px; color:#777;" id="trip-status-txt">On way...</div>
                </div>
            </div>
            <div class="trip-status">LKR <span id="live-fare">0</span></div>
        </div>

        <div id="trip-details" style="width:100%;">
            <div class="loc-row"><div class="loc-dot dot-blue"></div><div class="loc-txt" id="trip-from">...</div></div>
            <div class="loc-row"><div class="loc-dot dot-red"></div><div class="loc-txt" id="trip-to">...</div></div>
            
            <button class="go-online-btn" style="background:#2196F3; font-size:14px; margin-bottom:10px;" id="btn-notify" onclick="notifyUser()">
                <span data-i18n="btn_notify">Notify I'm Here</span>
            </button>
            <button class="go-online-btn" style="background:#555; font-size:12px; padding:10px; margin-bottom:10px;" onclick="openMsgPopup()">
                <i class="fa-solid fa-comment"></i> Message Customer
            </button>

            <!-- SLIDE BUTTON -->
            <div class="slide-btn-container" id="slider-cont">
                <div class="slide-bg" id="slider-bg"></div>
                <div class="slide-text" id="slider-text">SLIDE TO START</div>
                <div class="slide-handle" id="slider-handle"><i class="fas fa-chevron-right"></i></div>
            </div>
        </div>
    </div>

<!-- SUMMARY MODAL -->
<div id="summary-modal" class="modal-overlay full-screen-modal">
    <div class="modal-card">
        <div class="summary-box" style="text-align:center;">
            <i class="fas fa-check-circle" style="font-size:50px; color:var(--online); margin-bottom:10px;"></i>
            <h2 data-i18n="trip_ended">Trip Ended</h2>
            <div class="collect-lbl" data-i18n="cash_collect">Cash to Collect</div>
            <div class="total-price" style="font-size:40px; font-weight:800; color:var(--online);">LKR <span id="sum-total">0</span></div>
            
            <div class="breakdown" style="background:#f9f9f9; padding:15px; border-radius:10px; margin:20px 0; text-align:left;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>Base</span> <span id="sum-base">0</span></div>
                <div style="display:flex; justify-content:space-between;"><span>Wait</span> <span id="sum-wait-cost">0</span></div>
            </div>
            
            <button class="go-online-btn" onclick="finishCash()">
                <span data-i18n="btn_cash_rec">CASH RECEIVED</span>
            </button>
        </div>
    </div>
</div>

<!-- EARNINGS MODAL -->
<div id="earnings-modal" class="modal-overlay">
    <div class="modal-card">
        <h3 style="text-align:center;" data-i18n="today_earn">Today's Earnings</h3>
        <h1 style="text-align:center; color:var(--online);">LKR <span id="daily-earn">0.00</span></h1>
        <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
        <div id="earn-list" style="max-height:300px; overflow-y:auto; text-align:center; color:#777;">
            No trips yet today.
        </div>
        <button class="vehicles-strip" onclick="closeModal('earnings-modal')" data-i18n="btn_close">Close</button>
    </div>
</div>

<!-- VEHICLE MANAGER MODAL -->
<div id="vehicle-man-modal" class="modal-overlay">
    <div class="modal-card" style="height:85vh;">
        <h3 style="text-align:center;" data-i18n="my_vehicles">My Vehicles</h3>
        <div id="man-veh-list" style="flex:1; overflow-y:auto; padding-bottom:10px;"></div>
        <button class="go-online-btn" style="background:#444; font-size:14px;" onclick="openAddVehicle()">
            <span data-i18n="btn_add_veh">+ Add Vehicle</span>
        </button>
        <button class="vehicles-strip" onclick="closeModal('vehicle-man-modal')" data-i18n="btn_close">Close</button>
    </div>
</div>

<!-- SELECT VEHICLE FOR ONLINE -->
<div id="vehicle-select-modal" class="modal-overlay">
    <div class="modal-card">
        <h3 style="text-align:center;" data-i18n="sel_veh">Select Vehicle</h3>
        <div id="online-veh-list" style="max-height:300px; overflow-y:auto; margin-bottom:10px;"></div>
        <button class="go-online-btn" onclick="confirmVehicle()" data-i18n="btn_cont">Continue</button>
        <button class="vehicles-strip" onclick="closeModal('vehicle-select-modal')" data-i18n="btn_cancel">Cancel</button>
    </div>
</div>

<div id="toast-container"></div>

<!-- JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, get, update, set, onValue, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const db = getDatabase(initializeApp({
        apiKey: "AIzaSyC3Rf4x5a_L1cYVa6soADfYktQK5WyMN-4",
        authDomain: "speedo-acb7c.firebaseapp.com",
        databaseURL: "https://speedo-acb7c-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "speedo-acb7c"
    }));

    // --- TRANSLATION DATA ---
    let lang = localStorage.getItem('speedo_lang') || 'en';
    const dict = {
        en: {
            status_title: "Driver Status", btn_online: "GO ONLINE", online_desc: "Go online to receive hires", btn_manage_veh: "Manage Vehicles",
            finding: "Finding Hires...", gps_on: "Keep GPS & Data ON", btn_offline: "GO OFFLINE",
            new_hire: "New Hire!", btn_accept: "GO & PICKUP", btn_notify: "Notify I'm Here", btn_cancel: "Cancel Trip",
            trip_ended: "Trip Ended", cash_collect: "Cash to Collect", btn_cash_rec: "CASH RECEIVED",
            today_earn: "Today's Earnings", btn_close: "Close", my_vehicles: "My Vehicles", btn_add_veh: "+ Add Vehicle",
            sel_veh: "Select Vehicle", btn_cont: "Continue", btn_cancel: "Cancel", processing: "Processing...",
            slide_start: "SLIDE TO START", slide_end: "SLIDE TO END"
        },
        si: {
            status_title: "රියදුරු තත්වය", btn_online: "මාර්ගත වන්න", online_desc: "හයර් ලැබා ගැනීමට ලබා වෙන", btn_manage_veh: "වාහන කළමනාකරණය",
            finding: "හයර් සොයමින්...", gps_on: "GPS සහ Data සක්‍රීයව තබන්න", btn_offline: "විසන්ධි වන්න",
            new_hire: "නව හයර් එක්!", btn_accept: "පිළිගන්න", btn_notify: "මම පැමිණියෙමි", btn_cancel: "අවලංගු කරන්",
            trip_ended: "ගමන අවසන්", cash_collect: "අයකළ ගැයීම", btn_cash_rec: "මුදල් ලැබුණි",
            today_earn: "අද ඉපැයීම්", btn_close: "වසන්න", my_vehicles: "මගේ වාහන", btn_add_veh: "+ වාහනයක් එක් කරන්න",
            sel_veh: "වාහනය තෝරන්න", btn_cont: "ඉදිරිපත් කරන්", btn_cancel: "අවලංගු යියි", processing: "සකසමින් පවතී...",
            slide_start: "ඇරඹීමට අදින්", slide_end: "අවසන් කිරීමට අදින්"
        },
        ta: {
            status_title: "ஓட்டுநர் நிலை", btn_online: "ஆன்லைனில் செல்லுங்கள்", online_desc: "சவாரிகளைப் பெற ஆன்லைனில் செல்லவும்", btn_manage_veh: "வாகனங்களை நிர்வகிக்கும்",
            finding: "தேடுகிறது...", gps_on: "GPS மற்றும் Data ஆன் செய்யவும்", btn_offline: "ஆஃப்லைன் செல்லுங்கள்",
            new_hire: "புதிய சவாரி!", btn_accept: "ஏற்கவும்", btn_notify: "நான் வந்துவிட்டேன்", btn_cancel: "ரத்து செய்",
            trip_ended: "சவாரி முடிந்தது", cash_collect: "பெற வேண்டிய பணம்", btn_cash_rec: "பணம் பெறப்பட்டு",
            today_earn: "இன்றைய வருமானம்", btn_close: "மூடு", my_vehicles: "எனது வாகனங்கள்", btn_add_veh: "+ வாகனத்தைச் சேர்",
            sel_veh: "வாகனத்தைத் தேர்ந்தெடுக்கவும்", btn_cont: "தொடரவும்", btn_cancel: "ரத்து", processing: "செயலாக்கிறது...",
            slide_start: "தொடங்க இழுக்கவும்", slide_end: "முடிக்க இழுக்கவும்"
        }
    };

    let currentUser=null, map, marker, routeControl;
    let currentVehicles=[], selectedVehId, selectedVehType, isOnline=false;
    let tripState = "IDLE"; 
    let currentRideId = null, tempV={type:"",imgs:{}}, earnings=0;
    let currentLocation = null; // {lat, lng}
    let rideData = null; // Store ride info
    let pickupLine = null; // Blue Line
    let tripLine = null; // Red Line
    let userPosMarker = null; // Customer Marker

    window.onload = async () => {
        updateLangUI();
        let savedEarn = localStorage.getItem('speedo_earnings');
        if(savedEarn) { earnings = parseFloat(savedEarn); document.getElementById('earn-txt').innerText = earnings.toFixed(2); }

        const uid = localStorage.getItem('uid');
        const dist = localStorage.getItem('dist');
        
        if(!uid || !dist) { 
            alert("Login required. Redirecting..."); 
            location.href="rider.html"; 
            return; 
        }

        try {
            const s = await get(ref(db, `riders/${dist}/${uid}`));
            if(s.exists()) {
                const d = s.val().riderdata;
                if(!d) {
                    alert("Invalid rider data. Please login again.");
                    location.reload();
                    return;
                }
                currentUser = { ...d, uid, dist };
                document.getElementById('user-pic').src = d.selfie || '';
                document.getElementById('user-name').innerText = d.fullName.split(" ")[0];
                
                await loadVehicles();
                
                document.getElementById('top-ui').style.display='flex';
                document.getElementById('card-offline').style.display='flex';
                initMap();
                
                // Remove loader once UI is ready
                const loader = document.getElementById('global-loader-screen');
                if(loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => loader.remove(), 500);
                }
            } else {
                alert("User not found.");
                location.href="rider.html";
            }
        } catch(e) { 
            console.error(e);
            alert("Error loading rider data. Please check connection.");
            document.getElementById('loading-text').innerText = "Error Loading App";
            // Keep loader visible if error
        }
    };

    function updateLangUI() {
        document.getElementById('lang-btn').innerText = lang.toUpperCase();
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if(dict[lang][key]) el.innerHTML = dict[lang][key];
        });
    }

    function initMap() {
        const mapDiv = document.getElementById('map');
        if(!mapDiv) return;

        map = L.map('map', {zoomControl:false}).setView([7.8, 80.7], 8);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        if("geolocation" in navigator) {
            navigator.geolocation.watchPosition(pos => {
                const {latitude:lat, longitude:lng} = pos.coords;
                currentLocation = {lat, lng};
                
                if(!marker) {
                    const icon = L.divIcon({ className:'c', html:`<div class='gps-marker-container'><div class='gps-pulse'></div><div class='gps-dot'></div></div>`, iconSize:[50,50] });
                    marker = L.marker([lat, lng], {icon}).addTo(map);
                    map.setView([lat, lng], 16);
                } else {
                    marker.setLatLng([lat, lng]);
                    // If driving, update line endpoints
                    if(tripState !== 'IDLE') updateTripLines();
                    
                    if(isOnline && selectedVehId) {
                        update(ref(db, `vehicles/${selectedVehType}/${selectedVehId}/location`), {lat, lng, ts:Date.now()});
                    }
                }
            }, (err) => {
                toast("GPS Error", "error");
            }, {enableHighAccuracy:true});
        }
    }

    // --- ONLINE LOGIC ---
    window.initiateGoOnline = () => {
        if(!currentLocation) return toast("Waiting for GPS Location...", "error");
        
        const app = currentVehicles.filter(v => v.approved_status === true);
        if(app.length===0) return toast("No Approved Vehicles", "error");
        
        const list = document.getElementById('online-veh-list');
        list.innerHTML = ""; 
        app.forEach(v => {
            let d = document.createElement('div');
            d.className = 'v-item';
            d.innerHTML = `<div class="v-info"><b>${v.brand} ${v.model}</b> <br><small>${v.plate}</small></div>`;
            d.onclick = () => {
                document.querySelectorAll('.v-item').forEach(x=>x.classList.remove('selected'));
                d.classList.add('selected');
                selectedVehId = v.id; selectedVehType = v.type;
            };
            list.appendChild(d);
        });
        openModal('vehicle-select-modal');
    }

    window.confirmVehicle = () => {
        if(!selectedVehId) return toast("Select a vehicle", "error");
        closeModal('vehicle-select-modal');
        isOnline = true;
        
        document.getElementById('card-offline').style.display='none';
        document.getElementById('card-searching').classList.remove('hidden-card');
        
        update(ref(db, `vehicles/${selectedVehType}/${selectedVehId}`), {status:"online"});
        
        // Listen for requests
        ridesRef = ref(db, 'rides');
        onValue(ridesRef, (snapshot) => {
            if(tripState !== 'IDLE') return; // Busy
                
            const rides = snapshot.val();
            if(!rides) return;
            
            // Check if any ride is requesting my type and matches my criteria
            for(let rid in rides) {
                const r = rides[rid];
                
                // Check Status
                if(r.status !== 'requesting') continue;

                // Check Vehicle Match
                if(r.vehicleType !== selectedVehType) continue;

                // FLASH LOGIC:
                // If this is a Flash job, I can only take it if I'm on a Bike.
                if(r.serviceType === 'flash' && selectedVehType !== 'bike') continue;
                
                // If I'm a Bike, I accept both Ride and Flash.
                // If I'm others, I only accept Ride (serviceType undefined or 'ride').
                if(r.serviceType && r.serviceType !== 'flash' && r.serviceType !== 'ride') continue;

                // Distance Check (Optional simple check for demo)
                // Real app: getDistanceFromLatLonInKm(currentLocation, r.pickup) < radius

                incomingRequest(rid, r);
                break; // Stop listening once found
            }
        });
    }

    window.goOffline = () => {
        isOnline = false;
        document.getElementById('card-searching').classList.add('hidden-card');
        document.getElementById('card-offline').style.display='flex';
        if(selectedVehId) update(ref(db, `vehicles/${selectedVehType}/${selectedVehId}`), {status:"offline"});
        selectedVid = null;
        if(ridesRef) { ridesRef = null; } // Stop listener
    }

    function incomingRequest(rideId, data) {
        currentRideId = rideId;
        rideData = data;
        tripState = "REQUEST";
        
        document.getElementById('req-price').innerText = data.price.replace('LKR ', '');
        document.getElementById('req-pickup').innerText = data.pickup.addr;
        document.getElementById('req-drop').innerText = data.dropoff.addr;
        
        // Handle Flash UI Ribbon
        const flashBadge = document.getElementById('req-flash-badge');
        const flashDetails = document.getElementById('req-flash-details');
        
        if(data.serviceType === 'flash') {
            flashBadge.innerHTML = `<span class="flash-ribbon">FLASH DELIVERY</span>`;
            flashDetails.style.display = 'block';
            const itemText = data.flashItem ? data.flashItem.charAt(0).toUpperCase() + data.flashItem.slice(1) : 'Unknown';
            flashDetails.innerText = `Item: ${itemText} | Note: ${data.note || 'None'}`;
        } else {
            flashBadge.innerHTML = '';
            flashDetails.style.display = 'none';
        }

        const distToUser = getDistanceFromLatLonInKm(currentLocation.lat, currentLocation.lng, data.pickup.lat, data.pickup.lng).toFixed(1);
        const distTrip = getDistanceFromLatLonInKm(data.pickup.lat, data.pickup.lng, data.dropoff.lat, data.dropoff.lng).toFixed(1);
        
        document.getElementById('req-dist-user').innerText = distToUser;
        document.getElementById('req-dist-trip').innerText = distTrip;
        
        document.getElementById('card-searching').classList.add('hidden-card');
        document.getElementById('card-request').classList.remove('hidden-card');
        
        let btn = document.querySelector('.timer-circle');
        btn.style.strokeDashoffset = 0;
        setTimeout(() => btn.style.strokeDashoffset = 400, 10);
        
        setTimeout(() => {
            if(tripState === "REQUEST") rejectRide();
        }, 10000);
    }

    window.acceptHire = async () => {
        tripState = "PICKUP";
        document.getElementById('card-request').classList.add('hidden-card');
        document.getElementById('card-trip').classList.remove('hidden-card');
        
        // REAL DB UPDATE
        await update(ref(db, `rides/${currentRideId}`), {
            status: 'driver_found',
            driverId: currentUser.uid,
            driverName: currentUser.fullName,
            driverPhone: currentUser.mobile || '0000000000', // In real app, ensure this exists
            vehiclePlate: currentVehicles.find(v=>v.id===selectedVehId).plate
        });
        
        document.getElementById('trip-status-txt').innerText = lang==='si'?"සියයා වෙත යමින්":"On way to pickup";
        document.getElementById('trip-from').innerText = rideData.pickup.addr;
        document.getElementById('trip-to').innerText = rideData.dropoff.addr;
        document.getElementById('live-fare').innerText = rideData.price.replace('LKR ', '');
        
        setupSlider(dict[lang].slide_start, startTrip);
        
        // Update Map Lines (Blue)
        updateTripLines();
        
        // Listen for messages
        onValue(ref(db, `rides/${currentRideId}/messages`), snap => {
            const msgs = snap.val();
            if(msgs) {
                const last = Object.values(msgs).pop();
                if(last && last.sender !== 'driver') {
                    const fs = document.getElementById('user-msg-fullscreen');
                    document.getElementById('user-msg-text').innerText = last.text;
                    fs.style.display = 'flex';
                    setTimeout(() => fs.style.display = 'none', 2000);
                }
            }
        });

        // Watch for cancellation
        onValue(ref(db, `rides/${currentRideId}`), s => {
            const r = s.val();
            if(r.status === 'cancelled') rejectRide();
        });
    }
    
    function rejectRide() {
        currentRideId = null;
        tripState = "IDLE";
        rideData = null;
        clearLines();
        document.getElementById('card-request').classList.add('hidden-card');
        document.getElementById('card-trip').classList.add('hidden-card');
        if(isOnline) document.getElementById('card-searching').classList.remove('hidden-card');
        else document.getElementById('card-offline').style.display='flex';
    }

    function updateTripLines() {
        if(!rideData) return;
        
        const pickup = L.latLng(rideData.pickup.lat, rideData.pickup.lng);
        const drop = L.latLng(rideData.dropoff.lat, rideData.dropoff.lng);
        const rider = L.latLng(currentLocation.lat, currentLocation.lng);
        
        // User Marker
        if(!userPosMarker) {
            const icon = L.divIcon({ html: '<div style="width:15px;height:15px;background:blue;border-radius:50%;border:2px solid white;"></div>', iconSize:[15,15], iconAnchor:[7,7]});
            userPosMarker = L.marker(pickup, {icon}).addTo(map);
        }

        if(tripState === 'PICKUP') {
            // Blue Line: Rider -> Pickup
            if(rider && pickup) {
                if(pickupLine) map.removeLayer(pickupLine);
                pickupLine = L.polyline([rider, pickup], {color: 'blue', weight: 5, dashArray: '10, 10'}).addTo(map);
                map.fitBounds([rider, pickup], {padding: [50, 50]});
            }
            if(tripLine) { map.removeLayer(tripLine); tripLine = null; }
        } else if (tripState === 'TRIP') {
            // Red Line: Pickup -> Drop
            if(pickupLine) { map.removeLayer(pickupLine); pickupLine = null; }
            if(!tripLine) {
                tripLine = L.polyline([pickup, drop], {color: 'red', weight: 5}).addTo(map);
                map.fitBounds([pickup, drop], {padding: [100, 100]});
            }
        }
    }

    window.notifyUser = () => { toast("User Notified!", "success"); }
    window.openMsgPopup = () => document.getElementById('msg-popup').style.display = 'flex';

    function startTrip() {
        tripState = "TRIP";
        document.getElementById('trip-status-txt').innerText = lang==='si'?"ගමනානාන්තය වෙත":"Heading to Destination";
        document.getElementById('btn-notify').style.display='none';
        setupSlider(dict[lang].slide_end, endTrip);
        updateTripLines(); // Switch to Red Line
    }

    function endTrip() {
        tripState = "IDLE";
        document.getElementById('card-trip').classList.add('hidden-card');
        document.getElementById('card-offline').style.display='flex';
        
        const ridePrice = document.getElementById('live-fare').innerText;
        
        document.getElementById('sum-total').innerText = ridePrice;
        document.getElementById('sum-base').innerText = ridePrice;
        document.getElementById('summary-modal').style.display = 'flex';
        clearLines();
    }

    window.finishCash = async () => {
        closeModal('summary-modal');
        const price = parseFloat(document.getElementById('sum-total').innerText);
        earnings += price;
        localStorage.setItem('speedo_earnings', earnings);
        document.getElementById('earn-txt').innerText = earnings.toFixed(2);
        
        // REAL DB UPDATE: End Ride
        await update(ref(db, `rides/${currentRideId}`), { status: 'ended' });
        
        // Reset Rider to be available again
        currentRideId = null;
        rideData = null;
        document.getElementById('btn-notify').style.display='block';
        // Back to Searching state visually
        document.getElementById('card-offline').style.display='none';
        document.getElementById('card-searching').classList.remove('hidden-card');
    }

    window.sendMessageToUser = async () => {
        const txt = document.getElementById('msg-input-text').value;
        if(!txt) return;
        document.getElementById('msg-popup').style.display = 'none';
        
        await push(ref(db, `rides/${currentRideId}/messages`), {
            sender: 'driver',
            text: txt,
            timestamp: Date.now()
        });
    }

    // --- UTILS ---
    const toast = (m,t) => {
        let d=document.createElement('div'); d.className=`toast ${t}`; d.innerText=m;
        document.getElementById('toast-container').appendChild(d);
        setTimeout(()=>d.classList.add('show'),10); setTimeout(()=>{d.classList.remove('show'); setTimeout(()=>d.remove(),300)},2500);
    }
    window.openModal=(id)=>document.getElementById(id).style.display='flex';
    window.closeModal=(id)=>document.getElementById(id).style.display='none';
    window.toggleTripCard = () => {
        let d = document.getElementById('trip-details');
        let a = document.getElementById('trip-arrow');
        if(d.style.display==='none') { d.style.display='block'; a.className='fas fa-chevron-up pill-expand-icon'; }
        else { d.style.display='none'; a.className='fas fa-chevron-down pill-expand-icon'; }
    }
    function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
        var R = 6371; 
        var dLat = deg2rad(lat2-lat1);  
        var dLon = deg2rad(lon2-lon1); 
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        var d = R * c; 
        return d;
    }
    function deg2rad(deg) { return deg * (Math.PI/180) }

    // --- VEHICLE MANAGER ---
    async function loadVehicles() {
        currentVehicles=[];
        const categories = ["Bike","Tuk Tuk","Car","Van"];
        for(let t of categories) {
            try { 
                const s = await get(ref(db, `vehicles/${t}`)); 
                if(s.exists()) {
                    s.forEach(v => { 
                        if(v.val().ownerUid === currentUser.uid) {
                            currentVehicles.push({...v.val(), id:v.key, type:t}); 
                        }
                    }); 
                }
            } catch(e){ console.log(e); }
        }
    }
    
    window.openVehicleManager = async () => {
        await loadVehicles();
        const l = document.getElementById('man-veh-list');
        l.innerHTML = ""; 
        if(currentVehicles.length === 0) {
            l.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px;'>No vehicles added</p>";
        } else {
            currentVehicles.forEach(v => {
                let d = document.createElement('div');
                d.className = 'v-item';
                let st = v.approved_status===true ? "<span style='color:green; font-size:10px;'>Approved</span>" : 
                         (v.approved_status==="declined" ? "<span style='color:red; font-size:10px;'>Declined</span>" : 
                         "<span style='color:orange; font-size:10px;'>Pending</span>");
                
                d.innerHTML = `
                    <div><b>${v.brand}</b> <span style="font-size:12px;color:#777;">${v.model}</span><br><small>${v.plate}</small></div>
                    <div style="text-align:right;">
                        ${st}
                    </div>`;
                l.appendChild(d);
            });
        }
        openModal('vehicle-man-modal');
    }
    window.openAddVehicle = () => { closeModal('vehicle-man-modal'); window.open('add-vehicle.html','_blank'); } // Open separate file for brevity

    // --- SLIDER LOGIC ---
    function setupSlider(text, callback) {
        const slider = document.getElementById('slider-handle');
        const bg = document.getElementById('slider-bg');
        document.getElementById('slider-text').innerText = text;
        
        let isDragging = false, startX, containerWidth;
        const cont = document.getElementById('slider-cont');

        slider.ontouchstart = (e) => {
            isDragging = true; startX = e.touches[0].clientX; containerWidth = cont.offsetWidth - 55;
        };
        document.ontouchmove = (e) => {
            if(!isDragging) return;
            let moveX = e.touches[0].clientX - startX;
            if(moveX < 0) moveX = 0; if(moveX > containerWidth) moveX = containerWidth;
            slider.style.left = (moveX + 2) + 'px'; bg.style.width = moveX + 'px';
            if(moveX >= containerWidth) { isDragging = false; callback(); resetSlider(); }
        };
        document.ontouchend = () => { if(isDragging) resetSlider(); isDragging = false; };
        function resetSlider() {
            slider.style.transition = '0.3s'; bg.style.transition = '0.3s';
            slider.style.left = '2px'; bg.style.width = '0px';
            setTimeout(() => { slider.style.transition = 'none'; bg.style.transition = 'none'; }, 300);
        }
    }

    window.toggleLang=()=>{
        lang = lang==='en'?'si':(lang==='si'?'ta':'en'); 
        localStorage.setItem('speedo_lang',lang); 
        updateLangUI();
    }
</script>
</body>
</html>
